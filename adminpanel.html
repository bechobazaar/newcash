<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="robots" content="noindex, nofollow">
    <link rel="icon" type="image/png" href="/fevicon/favicon-96x96.png" sizes="96x96" />
<link rel="icon" type="image/svg+xml" href="/fevicon/favicon.svg" />
<link rel="shortcut icon" href="/fevicon/favicon.ico" />
<link rel="apple-touch-icon" sizes="180x180" href="/fevicon/apple-touch-icon.png" />
<meta name="apple-mobile-web-app-title" content="Bechobazaar" />
<link rel="manifest" href="/fevicon/site.webmanifest" />
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Master Admin Panel</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: 'Inter', sans-serif;
      background: #f0f2f5;
      display: flex;
      color: #333;
      min-height: 100vh;
    }
    .sidebar {
      width: 250px;
      background: #1f1f2e;
      color: #fff;
      height: 100vh;
      padding: 20px;
      position: fixed;
      display: flex;
      flex-direction: column;
    }
    .sidebar h4 {
      text-align: center;
      margin-bottom: 30px;
      font-size: 18px;
    }
    .sidebar ul {
      list-style: none;
      flex: 1;
      font-size: 12px;
    }

   #adThumbnail {
      display: block;
      max-width: auto;
      max-height: 200px;
      margin: 0 auto 18px auto;
      border-radius: 13px;
      box-shadow: 0 2px 16px #0ee7b733;
      object-fit: contain;
    }

    .sidebar li {
      padding: 12px;
      margin: 8px 0;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      transition: 0.2s;
      
    }
    .sidebar li:hover,
    .sidebar li.active {
      background: #007bff;
    }
    .sidebar i {
      margin-right: 10px;
    }
    .content {
      margin-left: 250px;
      padding: 30px;
      width: calc(100% - 250px);
    }
    .top-summary {
      display: flex;
      gap: 20px;
      margin-bottom: 30px;
    }
    .card {
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      flex: 1;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      text-align: center;
    }
    .card h3 {
      font-size: 18px;
      margin-bottom: 10px;
      color: #555;
    }
    .card p {
      font-size: 22px;
      font-weight: 600;
      color: #222;
    }
    .section {
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    .section h3 {
      margin-bottom: 20px;
      font-size: 15px;
      border-bottom: 1px solid #ddd;
      padding-bottom: 10px;
    }
    .list-item {
      padding: 12px 0;
      border-bottom: 1px solid #eee;
      font-size: 11px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .list-item button {
      margin-left: 6px;
      padding: 4px 8px;
      font-size: 11px;
      cursor: pointer;
      border: none;
      border-radius: 8px;
    }
    .edit-btn {
      background: #28a745;
      color: #fff;
    }
    .delete-btn {
      background: #dc3545;
      color: #fff;
    }
    .view-btn {
      background: #007bff;
      color: #fff;
    }
    .approve-btn {
      background: #28a745;
      color: #fff;
    }
    .reject-btn {
      background: #dc3545;
      color: #fff;
    }
    
    .chat-bubble {
      max-width: 70%;
      margin: 8px 0;
      padding: 10px 14px;
      border-radius: 20px;
      position: relative;
      word-wrap: break-word;
      display: inline-block;
      clear: both;
      font-size: 14px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    .admin-message {
      background: #007bff;
      color: white;
      float: right;
      text-align: right;
      border-bottom-right-radius: 5px;
    }
    .user-message {
      background: #e5e5ea;
      color: #000;
      float: left;
      text-align: left;
      border-bottom-left-radius: 5px;
    }
    .message-time {
      font-size: 11px;
      margin-top: 4px;
      opacity: 0.7;
      text-align: right;
    }
    /* Red "NEW" badge */
    .new-badge {
      display: none;
      background: #e74c3c;
      color: #fff;
      border-radius: 12px;
      font-size: 10px;
      font-weight: bold;
      padding: 2px 6px;
      margin-left: 6px;
      vertical-align: middle;
    }
    
#sliderTab.section {
  background: #f8faff;
  border-radius: 14px;
  box-shadow: 0 2px 12px #2060b303;
  padding: 24px 30px 32px 30px;
  margin: 25px auto 30px auto;
  max-width: auto;
  border: 1.5px solid #e7eefa;
  font-family: 'Segoe UI',Arial,sans-serif;
}

#sliderTab h3 {
  font-size: 22px;
  font-weight: 700;
  color: #27374d;
  margin-top: 0;
  margin-bottom: 15px;
  letter-spacing: .7px;
}

#addSliderForm {
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  gap: 13px 18px;
  background: #fff;
  border-radius: 8px;
  padding: 14px 16px 8px 16px;
  margin-bottom: 20px;
  box-shadow: 0 1px 8px #243d3a0d;
  border: 1.2px solid #e2ecf7;
}

#addSliderForm input[type="text"],
#addSliderForm input[type="number"] {
  font-size: 15px;
  border-radius: 7px;
  border: 1.2px solid #d1e0f5;
  padding: 7px 12px;
  background: #fafbff;
  outline: none;
  transition: border-color 0.22s;
  margin-right: 0;
  margin-bottom: 6px;
  min-width: 130px;
  max-width: 230px;
}
#addSliderForm input[type="text"]:focus,
#addSliderForm input[type="number"]:focus {
  border-color: #228bfa;
  background: #f5fbff;
}

#addSliderForm input[type="file"] {
  font-size: 14px;
  margin-bottom: 6px;
  background: transparent;
  padding: 2px 0;
}

#addSliderForm label {
  display: flex;
  align-items: center;
  font-size: 13.5px;
  margin: 0 8px 0 0;
  color: #1d3b5a;
}

#addSliderForm input[type="checkbox"] {
  accent-color: #3f51b5;
  margin-right: 4px;
}

#addSliderForm .approve-btn,
#addSliderForm .btn {
  background: linear-gradient(90deg, #228bfa 60%, #09e188 100%);
  color: #fff;
  border: none;
  border-radius: 8px;
  padding: 8px 22px;
  font-size: 15px;
  font-weight: 700;
  cursor: pointer;
  box-shadow: 0 2px 8px #33b57a21;
  transition: background 0.19s, transform 0.13s;
}
#addSliderForm .approve-btn:hover,
#addSliderForm .btn:hover {
  background: linear-gradient(90deg, #1790ff 60%, #10bb78 100%);
  transform: translateY(-2px) scale(1.04);
}

#addSliderForm span {
  color: #6c7784;
  margin-left: 12px;
}

#sliderTab hr {
  border: none;
  border-bottom: 1.4px solid #dde5ed;
  margin: 18px 0 12px 0;
}

#sliderList {
  padding: 12px 0;
  min-height: 36px;
  font-size: 15px;
  color: #4b5e75;
  background: #fcfdff;
  border-radius: 8px;
}


    #editModal,
    #messageModal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      border-radius: 12px;
      padding: 20px;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      z-index: 10000;
      display: none;
    }


#reportsTab .report-card {
  background: #fff8f8;
  border-left: 4px solid #ff4d4f;
  padding: 18px;
  border-radius: 12px;
  box-shadow: 0 2px 12px #ffdada3a;
  margin-bottom: 16px;
  display: flex;
  justify-content: space-between;
  gap: 16px;
  align-items: flex-start;
}
#reportsTab .report-card strong {
  color: #c0392b;
}
#reportsTab .report-card img {
  max-width: 80px;
  border-radius: 6px;
  margin-top: 8px;
  box-shadow: 0 1px 6px #ccc;
}
#reportsTab .report-card .ad-id {
  background: #f0f2f7;
  color: #1e3c72;
  font-size: 13px;
  padding: 4px 8px;
  border-radius: 8px;
  margin-top: 4px;
  display: inline-block;
}
#reportsTab .report-card .reason {
  color: #000;
  font-size: 14px;
  font-weight: 500;
  margin-bottom: 8px;
}


    #messageModal h3,
    #editModal h3 {
      margin-bottom: 15px;
      font-size: 18px;
    }
    #editModal input,
    #editModal textarea {
      width: 100%;
      margin-bottom: 10px;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 14px;
    }
    #editModal button {
      margin-right: 10px;
      padding: 8px 14px;
      font-size: 14px;
      cursor: pointer;
      border: none;
      border-radius: 6px;
    }
    #messageContent, 
#messageContent div {
      font-size: 14px;
      overflow-wrap: anywhere;
      word-wrap: break-word;
    }

.chat-email {
  color: #0066cc;
}

.chat-container {
  display: flex;
  flex-direction: column;
  gap: 11px;            
  padding: 12px 10px 12px 10px;
  background: #f7fafd;
  max-height: 70vh;
  overflow-y: auto;
}

.chat-message {
  min-width: 64px;
  max-width: 78%;
  padding: 8px 14px 13px 14px;
  border-radius: 17px;
  margin-bottom: 10px;
  position: relative;
  font-size: 13px;
  line-height: 1.48;
  box-shadow: 0 1px 7px #dde8f21b;
  word-break: break-word;
  background: #f4f5fa;
  display: flex;
  flex-direction: column;
}

.chat-message.sent {
  align-self: flex-end;
  background: #d6ffe4;
  border-bottom-right-radius: 7px;
  margin-left: 16%;
  margin-right: 0;
  text-align: right;
}

.chat-message.received {
  align-self: flex-start;
  background: #f1f0f0;
  border-bottom-left-radius: 7px;
  margin-right: 16%;
  margin-left: 0;
  text-align: left;
}

.chat-message .sender {
  font-size: 0.87em;
  font-weight: 500;
  margin-bottom: 2px;
  color: #197be6;
  opacity: 0.8;
}

.chat-message .text {
  margin-bottom: 3px;
}

.chat-message .time {
  font-size: 6px;
  color: black;
  align-self: flex-end;
  margin-top: 2px;
}

.chat-message img {
  max-width: 120px;
  border-radius: 7px;
  margin: 4px 0 2px 0;
  box-shadow: 0 1px 5px #ddd;
}

.ads-bulk-btn {
  background: #e6f1ff;
  color: #195eaa;
  font-weight: 600;
  border: none;
  border-radius: 7px;
  padding: 7px 18px;
  margin-right: 4px;
  cursor: pointer;
  font-size: 15px;
  transition: background 0.16s, color 0.16s;
}
.ads-bulk-btn:disabled {
  background: #f2f3f6;
  color: #b0b5bb;
  cursor: not-allowed;
}

#bulkApproveBtn { background: #e4fbee; color: #1ea164; }
#bulkRejectBtn  { background: #ffeaea; color: #e65050; }
#bulkDeleteBtn  { background: #f7e5fb; color: #9637b8; }
#bulkApproveBtn:disabled, #bulkRejectBtn:disabled, #bulkDeleteBtn:disabled {
  background: #f2f3f6 !important;
  color: #b0b5bb !important;
}


    
    #liveChatBox {
      height: 300px;
      overflow-y: auto;
      border: 1px solid #ccc;
      padding: 10px;
      border-radius: 8px;
      background: #f9f9f9;
      margin-bottom: 10px;
    }
    #liveChatInput {
      width: 100%;
      padding: 8px;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-size: 14px;
      resize: none;
    }
    #liveChatSendBtn {
      margin-top: 8px;
      background: #28a745;
      color: white;
      padding: 8px 16px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      float: right;
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 10000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow-y: auto;
      background-color: rgba(0, 0, 0, 0.4);
    }
    .modal-content {
      background-color: #ffffff;
      margin: 60px auto;
      padding: 20px 30px;
      border: 1px solid #888;
      width: 80%;
      max-width: 600px;
      border-radius: 8px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
      position: relative;
    }

  
.chat-email {
  color: #0066cc;
  cursor: pointer;
  text-decoration: underline;
}


#userAdsList div,
#messageContent div {
  white-space: pre-wrap;
  overflow-wrap: anywhere;
}


.user-ad-item {
  display: flex;
  align-items: flex-start;
  gap: 5px;
  padding: 10px 0;
  border-bottom: 1px solid #f2f2f2;
  font-size: 10px;
  line-height: 0.5;
}

.user-ad-item img {
  width: 50px;
  height: 50px;
  border-radius: 10px;
  object-fit: cover;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
  flex-shrink: 0;
}

.user-ad-info {
  flex: 1;
}

.user-ad-title {
  font-weight: 600;
  margin-bottom: 2px;
  font-size: 11px;
  color: #202d3f;
}

.user-status-badge {
  display: inline-block;
  font-size: 10.5px;
  font-weight: 500;
  padding: 1.5px 8px;
  border-radius: 14px;
  margin: 2px 0 4px 0;
}

.status-approved {
  background: #e7f8ed;
  color: #158a56;
}
.status-pending {
  background: #fff4da;
  color: #b88400;
}
.status-rejected {
  background: #fdeaea;
  color: #d63d3d;
}
.status-expired {
  background: #e9e9e9;
  color: #777;
}

.user-ad-meta {
  color: #6b7c95;
}

.user-ad-id {
  font-size: 10px;
  color: #999;
  margin-top: 2px;
}

.user-ad-reason {
  font-size: 11px;
  color: #c0392b;
  margin-top: 4px;
}


    .close-btn {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
    .close-btn:hover,
    .close-btn:focus {
      color: #000;
    }
    #adDetailsContainer img {
      width: 100%;
      height: auto;
      border-radius: 6px;
      margin-bottom: 15px;
    }
    #adDetailsContainer h2 {
      margin-top: 0;
      margin-bottom: 10px;
      font-size: 24px;
      color: #102a43;
    }
    #adDetailsContainer p {
      font-size: 16px;
      line-height: 1.5;
      color: #334e68;
      margin-bottom: 12px;
    }
   


.list-item.highlight-pending {
  background: #fffbe7 !important;
  border-left: 4px solid #e6b41c;
  box-shadow: 0 2px 8px #ffefbb23;
}

.ads-tab-btn {
  background: #f4f6fd;
  color: #1b3a76;
  font-weight: 600;
  border: none;
  border-radius: 8px 8px 0 0;
  padding: 9px 28px;
  font-size: 15px;
  letter-spacing: 0.3px;
  cursor: pointer;
  transition: background 0.18s, color 0.15s;
  border-bottom: 2.5px solid #e4e9f3;
}
.ads-tab-btn.active {
  background: #e7f0fe;
  color: #0072f3;
  border-bottom: 3px solid #1d89ed;
  z-index: 1;
}
.ads-tab-btn:hover:not(.active) {
  background: #edf3fa;
  color: #2072a7;
}


#paymentsList table {
  width: 100%;
  border-collapse: collapse;
  margin-bottom: 16px;
  background: #fff;
  box-shadow: 0 2px 10px #dde8f225;
  border-radius: 11px;
  overflow: hidden;
}
#paymentsList th, #paymentsList td {
  padding: 10px 12px;
  border: 1px solid #e2e5f1;
  text-align: left;
  font-size: 15px;
}
#paymentsList th {
  background: #f4f7fd;
  font-weight: 600;
  color: #2257ad;
}
#paymentsList tr:nth-child(even) td {
  background: #f9fbff;
}
#paymentsList td {
  color: #234;
}
/* Boost Requests Cards */
#boostRequestsList .list-item {
  background: #fffdf7;
  border: 1px solid #fde9c6;
  border-radius: 12px;
  padding: 20px 17px;
  margin-bottom: 14px;
  box-shadow: 0 2px 8px #ffd94b1a;
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  gap: 18px;
  transition: box-shadow .15s;
}
#boostRequestsList .list-item:hover {
  box-shadow: 0 5px 14px #ffe6a930;
}
#boostRequestsList img {
  max-width: 120px;
  border-radius: 7px;
  border: 1px solid #eee;
}
#boostRequestsList b {
  color: #b27600;
}
#boostRequestsList .btn, #boostRequestsList button {
  margin-top: 5px;
  border: none;
  border-radius: 6px;
  padding: 8px 16px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  box-shadow: 0 1px 5px #fdebd7a6;
  transition: background .12s;
}
#boostRequestsList button[onclick*="approve"] {
  background: #18ce7c;
  color: #fff;
}
#boostRequestsList button[onclick*="reject"] {
  background: #ff6262;
  color: #fff;
}

@media (max-width: 600px) {
  #adsStatusTabs { flex-wrap:wrap; gap:6px;}
  .ads-tab-btn { padding:7px 11px;font-size:14px;}
}



#chatList .list-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 16px;
}
#chatList .chat-users {
  display: flex;
  gap: 48px;              
  flex: 1;                
}
#chatList .chat-users .user-block {
  text-align: left;
}
#chatList .chat-users code {
  display: block;
  font-size: 0.9em;
  word-break: break-word;  
  margin-bottom: 4px;
}
#chatList .chat-users small {
  color: #555;
  font-size: 0.85em;
}

.modal {
  display: none;                        
  position: fixed;
  top: 50%; left: 50%;
  transform: translate(-50%, -50%);
  z-index: 10000;
  width: 90%; max-width: 600px;
  background: white;
  border-radius: 10px;
  box-shadow: 0 8px 24px rgba(0,0,0,0.2);
}
.modal-content {
  padding: 24px;
  position: relative;
}
.modal-close {
  position: absolute;
  top: 12px; right: 16px;
  font-size: 24px;
  cursor: pointer;
  color: #666;
}
#userAdsList > div {
  margin-bottom: 16px;
  padding-bottom: 12px;
  border-bottom: 1px solid #eee;
}
#adsList {
  margin-top: 22px;
}

#adsList .list-item {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  gap: 16px;
  padding: 20px 10px 18px 10px;
  border-bottom: 1.5px solid #eef1f8;
  background: #fff;
  border-radius: 11px;
  margin-bottom: 8px;
  box-shadow: 0 1px 4px #e2eeff30;
  transition: box-shadow 0.17s, background 0.18s;
  position: relative;
}
#adsList .list-item:hover {
  background: #f4faff;
  box-shadow: 0 2px 10px #b3daff2e;
  z-index: 2;
}

#adsList .ad-info {
  font-size: 14px;
  font-weight: 500;
  color: #233366;
  margin-bottom: 6px;
}
#adsList .ad-info span {
  font-size: 12px;
  color: #4083c7;
  font-weight: 500;
}

#adsList .ad-meta {
  font-size: 11px;
  color: #6a7da8;
  margin-top: 3px;
  line-height: 1.0;
  margin-bottom: 3px;
}
#adsList .ad-meta strong {
  color: #205f94;
  font-weight: 600;
}

.users-tab-btn {
  background: #f3f6fb;
  border: none;
  border-radius: 7px 7px 0 0;
  padding: 8px 18px;
  font-weight: 600;
  font-size: 15px;
  cursor: pointer;
  transition: background 0.16s, color 0.16s;
}
.users-tab-btn.active {
  background: #e7f6fd;
  color: #007bff;
  border-bottom: 2.5px solid #007bff;
}
.user-count-badge {
  font-size:12px;
  padding:2px 8px;
  border-radius:12px;
  margin-left:6px;
  background:#e2eafc;
  color:#1864ab;
}
.all-badge {
  background: #e2eafc;
  color: #1864ab;
}
.active-badge {
  background: #dafbe6;
  color: #138e45;
}
.suspended-badge {
  background: #ffeaea;
  color: #d63d3d;
}



#adsList .status-label {
  display: inline-block;
  font-size: 12px;
  font-weight: 600;
  padding: 3px 13px 3px 13px;
  border-radius: 22px;
  margin-left: 3px;
  letter-spacing: 0.6px;
}
.status-approved { background: #e4fbee; color: #20a665; }
.status-pending  { background: #fff9e1; color: #e0b41a; }
.status-rejected { background: #ffe9e9; color: #e7472f; }
.status-expired  { background: #e6e6e6; color: #7c879a; }

#adsList .ad-actions {
  display: flex;
  flex-direction: row;
  gap: 7px;
  margin-top: 2px;
  flex-shrink: 0;
}
#adsList .ad-actions button {
  font-size: 13px;
  border: none;
  border-radius: 7px;
  padding: 7px 15px;
  background: #f3f6fd;
  color: #184391;
  font-weight: 500;
  cursor: pointer;
  transition: background 0.16s, color 0.16s;
  outline: none;
}
#adsList .ad-actions .btn-view    { background: #e8f2fd; color: #0071f3; }
#adsList .ad-actions .btn-edit    { background: #e7fbf3; color: #1bb570; }
#adsList .ad-actions .btn-delete  { background: #fde7eb; color: #e05050; }
#adsList .ad-actions .btn-approve { background: #e7fbf3; color: #2da458; }
#adsList .ad-actions .btn-reject  { background: #ffeaea; color: #d64b4b; }
#adsList .ad-actions button:hover { filter: brightness(0.91); box-shadow: 0 2px 6px #d8ecff30; }


/* ===== PUSH CENTER STYLES (scoped) ===== */
#pushCenterTab {
  --pc-bg: #ffffff;
  --pc-muted: #64748b;      /* slate-500 */
  --pc-text: #0f172a;       /* slate-900 */
  --pc-border: #e5e7eb;     /* gray-200 */
  --pc-soft: #f8fafc;       /* slate-50 */
  --pc-primary: #0ea5e9;    /* sky-500 */
  --pc-primary-hover: #0284c7; /* sky-600 */
  --pc-success: #10b981;    /* emerald-500 */
  --pc-success-hover: #059669; /* emerald-600 */
  --pc-danger: #ef4444;     /* red-500 */
  --pc-radius: 12px;
  --pc-shadow: 0 8px 24px rgba(15, 23, 42, 0.06);
  color: var(--pc-text);
}

#pushCenterTab h3 { margin: 0 0 8px 0; font-size: 20px; }
#pushCenterTab h4 { margin: 0 0 8px 0; font-size: 16px; }

#pushCenterTab p, 
#pushCenterTab small { color: var(--pc-muted); }

/* Cards (your two top boxes + UIDs + history wrapper already look like cards) */
#pushCenterTab .pc-card {
  background: var(--pc-bg);
  border: 1px solid var(--pc-border);
  border-radius: var(--pc-radius);
  padding: 14px;
  box-shadow: var(--pc-shadow);
}

/* Grid (if later you add class="pc-grid" instead of inline style) */
#pushCenterTab .pc-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
  align-items: start;
}

/* Inputs */
#pushCenterTab input[type="text"],
#pushCenterTab input[type="url"],
#pushCenterTab input[type="password"],
#pushCenterTab textarea {
  width: 100%;
  padding: 10px 12px;
  border: 1px solid var(--pc-border);
  border-radius: 8px;
  background: #fff;
  color: var(--pc-text);
  outline: none;
  transition: border-color .15s ease, box-shadow .15s ease;
  box-sizing: border-box;
}

#pushCenterTab textarea { resize: vertical; }

#pushCenterTab input:focus,
#pushCenterTab textarea:focus {
  border-color: var(--pc-primary);
  box-shadow: 0 0 0 3px rgba(14,165,233,.15);
}

/* Buttons */
#pushCenterTab .btn {
  appearance: none;
  border: 0;
  border-radius: 10px;
  background: var(--pc-primary);
  color: #fff;
  padding: 10px 14px;
  font-weight: 600;
  cursor: pointer;
  transition: transform .04s ease, background .15s ease, box-shadow .15s ease;
  box-shadow: 0 2px 8px rgba(14,165,233,.25);
}
#pushCenterTab .btn:hover   { background: var(--pc-primary-hover); }
#pushCenterTab .btn:active  { transform: translateY(1px); }

#pushCenterTab .approve-btn.btn {
  background: var(--pc-success);
  box-shadow: 0 2px 8px rgba(16,185,129,.25);
}
#pushCenterTab .approve-btn.btn:hover { background: var(--pc-success-hover); }

/* Secondary / muted buttons (e.g. Clear, Load more) */
#pushCenterTab .btn.is-muted,
#pushCenterTab button[style*="background:#eee"] {
  background: #eef2f7 !important;
  color: #111827 !important;
  box-shadow: none;
}
#pushCenterTab .btn.is-muted:hover { background: #e6edf5 !important; }

/* Output line under send form */
#pushCenterTab #pc_out { 
  margin-top: 10px; 
  color: #0a6; 
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
  word-break: break-word;
}

/* History table */
#pushCenterTab #pc_history_wrap { margin-top: 18px; }

#pushCenterTab #pc_hist_table {
  width: 100%;
  border-collapse: collapse;
  font-size: 14px;
}

#pushCenterTab #pc_hist_table thead {
  background: var(--pc-soft);
  position: sticky;
  top: 0;
  z-index: 1;
}

#pushCenterTab #pc_hist_table th,
#pushCenterTab #pc_hist_table td {
  text-align: left;
  padding: 10px;
  border-bottom: 1px solid #eef2f7;
  vertical-align: top;
}

#pushCenterTab #pc_hist_table tbody tr:hover {
  background: #fcfdff;
}

/* â€œDetailsâ€ disclosure area */
#pushCenterTab [id^="det_"] {
  background: #fafafa;
  border: 1px solid var(--pc-border);
  border-radius: 8px;
  padding: 8px;
  margin-top: 8px;
}

#pushCenterTab [id^="det_"] table {
  width: 100%;
  border-collapse: collapse;
  font-size: 13px;
}
#pushCenterTab [id^="det_"] th,
#pushCenterTab [id^="det_"] td {
  padding: 6px 8px;
  border-top: 1px dashed #eee;
}

/* Links in the table column get ellipsis */
#pushCenterTab #pc_hist_table a {
  color: #0ea5e9;
  text-decoration: none;
}
#pushCenterTab #pc_hist_table a:hover { text-decoration: underline; }

/* Responsive */
@media (max-width: 980px) {
  #pushCenterTab .pc-grid { grid-template-columns: 1fr; }
  #pushCenterTab #pc_hist_table { font-size: 13px; }
  #pushCenterTab #pc_hist_table th, 
  #pushCenterTab #pc_hist_table td { padding: 8px; }
}

/* Tiny screens: make table scroll smoother */
@media (max-width: 640px) {
  #pushCenterTab .btn { padding: 9px 12px; }
  #pushCenterTab input, #pushCenterTab textarea { padding: 9px 10px; }
}

/* Nice focus ring for buttons (keyboard users) */
#pushCenterTab .btn:focus-visible {
  outline: 0;
  box-shadow: 0 0 0 3px rgba(14,165,233,.25), 0 2px 8px rgba(14,165,233,.25);
}


/* ---- Design Tokens ---- */
:root{
  --cm-font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Helvetica Neue", "Apple Color Emoji","Segoe UI Emoji";
  --cm-bg: #f6f8fb;
  --cm-card: #ffffff;
  --cm-muted: #6b7280;
  --cm-text: white;
  --cm-border: #e5e7eb;
  --cm-border-strong: #d1d5db;
  --cm-primary: #2563eb;
  --cm-primary-600:#1d4ed8;
  --cm-primary-50:#eff6ff;
  --cm-success:#16a34a;
  --cm-danger: #ef4444;
  --cm-warning:#f59e0b;

  --cm-radius-lg: 12px;
  --cm-radius-pill: 999px;
  --cm-shadow-sm: 0 2px 10px rgba(2, 6, 23, .06);
  --cm-shadow-md: 0 6px 22px rgba(2, 6, 23, .08);
  --cm-ring: 0 0 0 3px rgba(37, 99, 235, .2);
}

@media (prefers-color-scheme: dark){
  :root{
    --cm-bg:#E6E9FC;
    --cm-card:#0f172a;
    --cm-muted:#9aa3b2;
    --cm-text:red;
    --cm-border:#1f2937;
    --cm-border-strong:#334155;
    --cm-primary:#60a5fa;
    --cm-primary-600:#3b82f6;
    --cm-primary-50:#0b1b33;
    --cm-shadow-sm: 0 2px 10px rgba(0,0,0,.35);
    --cm-shadow-md: 0 10px 28px rgba(0,0,0,.35);
    --cm-ring: 0 0 0 3px rgba(96,165,250,.25);
  }
}

/* ---- Base ---- */
#categoryTab.section{
  font-family: var(--cm-font);
  color: grey;
  background: var(--cm-bg);
  padding: 12px 12px 24px;
  border-radius: var(--cm-radius-lg);
}

#categoryTab h3{
  margin: 0 0 14px;
  font-size: 20px;
  font-weight: 800;
  letter-spacing: .2px;
  color: black;
}

#categoryTab h4{
  margin: 0 0 8px;
  font-size: 16px;
  font-weight: 700;
}

#categoryTab h5{
  margin: 0 0 8px;
  font-size: 14px;
  font-weight: 700;
}

/* ---- Cards ---- */
#categoryTab .card,
#categoryTab .tabs-card{
  background: var(--cm-card) !important;
  border: 1px solid var(--cm-border) !important;
  border-radius: var(--cm-radius-lg) !important;
  padding: 14px 14px !important;
  box-shadow: var(--cm-shadow-sm);
}

#categoryTab .tabs-card + .tabs-card{ margin-top: 10px; }

#categoryTab small{
  color: var(--cm-muted);
}

/* ---- Inputs ---- */
#categoryTab .inputs-row{
  display:flex; gap:10px; flex-wrap:wrap; align-items:center;
}

#categoryTab input[type="text"],
#categoryTab input[type="number"],
#categoryTab textarea{
  background: var(--cm-card);
  color: white;
  border: 1px solid var(--cm-border-strong);
  border-radius: var(--cm-radius-lg);
  padding: 10px 12px;
  outline: none;
  transition: box-shadow .2s ease, border-color .2s ease, background .2s ease;
  box-shadow: 0 1px 0 rgba(2,6,23, .02) inset;
  min-height: 38px;
}

#categoryTab textarea{ min-height: 110px; resize: vertical; }

#categoryTab input::placeholder,
#categoryTab textarea::placeholder{ color: color-mix(in srgb, var(--cm-muted) 75%, transparent); }

#categoryTab input:focus,
#categoryTab textarea:focus{
  border-color: var(--cm-primary);
  box-shadow: var(--cm-ring);
}

#categoryTab input[type="checkbox"]{
  width: 16px; height:16px; accent-color: var(--cm-primary);
}

/* ---- Buttons ---- */
#categoryTab .approve-btn,
#categoryTab .btn-view,
#categoryTab .btn-delete{
  --btn-bg: var(--cm-primary);
  --btn-bg-hover: var(--cm-primary-600);
  --btn-text: #fff;
  --btn-border: transparent;

  display:inline-flex; align-items:center; justify-content:center;
  gap:8px; padding: 9px 14px; min-height: 38px;
  border-radius: 10px; border:1px solid var(--btn-border);
  background: var(--btn-bg); color: var(--btn-text);
  font-weight: 700; letter-spacing:.2px;
  box-shadow: var(--cm-shadow-sm);
  cursor: pointer; user-select:none;
  transition: transform .08s ease, box-shadow .2s ease, background .2s ease, opacity .2s ease;
}

#categoryTab .approve-btn:hover{ background: var(--btn-bg-hover); box-shadow: var(--cm-shadow-md); transform: translateY(-1px); }
#categoryTab .approve-btn:active{ transform: translateY(0); }

#categoryTab .btn-view{
  --btn-bg: color-mix(in srgb, var(--cm-primary) 12%, transparent);
  --btn-bg-hover: color-mix(in srgb, var(--cm-primary) 18%, transparent);
  --btn-text: var(--cm-primary);
  --btn-border: color-mix(in srgb, var(--cm-primary) 24%, transparent);
}

#categoryTab .btn-delete{
  --btn-bg: color-mix(in srgb, var(--cm-danger) 90%, transparent 10%);
  --btn-bg-hover: color-mix(in srgb, var(--cm-danger) 100%, transparent 0%);
  --btn-text: #fff;
  --btn-border: color-mix(in srgb, var(--cm-danger) 40%, transparent);
}

#categoryTab button[disabled],
#categoryTab .approve-btn[disabled],
#categoryTab .btn-view[disabled],
#categoryTab .btn-delete[disabled]{
  opacity:.6; cursor:not-allowed; transform:none; box-shadow:none;
}

/* ---- Toolbars / Tabs Row ---- */
#categoryTab .tabs-toolbar{
  display:flex; justify-content:space-between; align-items:center; gap:10px;
}

#categoryTab .tabs-row{
  display:flex; gap:8px; flex-wrap:wrap;
  max-height: 104px; overflow:auto;
  scrollbar-width: thin;
}

#categoryTab .tabs-row::-webkit-scrollbar{ height:8px; }
#categoryTab .tabs-row::-webkit-scrollbar-thumb{
  background: color-mix(in srgb, black 12%, transparent);
  border-radius:10px;
}

/* ---- Pills ---- */
#categoryTab .cat-pill,
#categoryTab .sub-pill{
  border: 1px solid color-mix(in srgb, var(--cm-primary) 20%, var(--cm-border));
  padding: 6px 12px;
  border-radius: var(--cm-radius-pill);
  background: color-mix(in srgb, var(--cm-primary-50) 70%, var(--cm-card));
  color: black;
  font-weight: 700;
  display:inline-flex; align-items:center; gap:6px;
  cursor: grab;
  transition: transform .08s ease, background .2s ease, border-color .2s ease;
  will-change: transform;
  box-shadow: 0 1px 0 rgba(2,6,23,.03);
  font-size:11px;
}

#categoryTab .sub-pill{
  background: color-mix(in srgb, var(--cm-card) 85%, var(--cm-primary-50));
  font-weight: 600;
}

#categoryTab .cat-pill:hover,
#categoryTab .sub-pill:hover{ transform: translateY(-1px); }

#categoryTab .cat-pill small{ color: var(--cm-danger); font-weight:700; }

/* ---- Category Cards ---- */
#categoryTab #catList .cat-card{
  border: 1px solid var(--cm-border);
  border-radius: var(--cm-radius-lg);
  background: var(--cm-card);
  box-shadow: var(--cm-shadow-sm);
  padding: 12px 14px;
  transition: box-shadow .2s ease, transform .08s ease, border-color .2s ease;
}

#categoryTab #catList .cat-card:hover{
  border-color: var(--cm-border-strong);
  box-shadow: var(--cm-shadow-md);
  transform: translateY(-1px);
}

#categoryTab #catList .cat-card .fa-solid,
#categoryTab #catList .cat-card i{
  font-size: 18px;
  color: var(--cm-primary);
  
}

/* ---- Sub List Rows ---- */
#categoryTab #subList .sub-row{
  border: 1px solid var(--cm-border);
  border-radius: var(--cm-radius-lg);
  background: var(--cm-card);
  box-shadow: var(--cm-shadow-sm);
  padding: 10px 12px;
  transition: box-shadow .2s ease, transform .08s ease, border-color .2s ease;
  cursor: grab;
}

#categoryTab #subList .sub-row:hover{
  border-color: var(--cm-border-strong);
  box-shadow: var(--cm-shadow-md);
  transform: translateY(-1px);
}

/* ---- Editor Sections ---- */
#categoryTab #subTabsWrap{ margin-top: 12px; }
#categoryTab #subcatEditor{
  margin-top: 12px;
}

#categoryTab hr{
  border:0; height:1px; background: var(--cm-border);
  margin: 18px 0;
  border-radius:999px;
}

/* ---- Code badge ---- */
#categoryTab code{
  background: color-mix(in srgb, white 6%, transparent);
  border: 1px solid var(--cm-border);
  color: var(--cm-text);
  padding: 2px 6px; border-radius: 6px; font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
}

/* ---- Helpers for drag feedback (optional) ---- */
#categoryTab .dragging{ opacity:.6; }

/* ---- Compact layouts on narrow screens ---- */
@media (max-width: 640px){
  #categoryTab .tabs-toolbar{ flex-direction: column; align-items: stretch; gap:12px; }
}


  /* ===== Admin app container (hidden until auth ok) ===== */
    #bbAdminApp{display:none; min-height:100vh}

    /* ===== Fullscreen login overlay ===== */
    #bbLoginOverlay {
  position: fixed;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  padding: 24px;

  /* ðŸ”¥ Solid gradient background (replace colors if you want) */
  background: linear-gradient(135deg, #1a1f71, #4b0082); 
}

    .bb-card{
      width:min(96vw, 420px); background:linear-gradient(180deg,#0b1220,#0b1322);
      border:1px solid var(--border); border-radius:12px;
      box-shadow:0 20px 60px rgba(2,6,23,.5); padding:22px 20px 18px;
    }
    .bb-card h1{font-size:22px; margin:0 0 6px; color: white;}
    .bb-sub{margin:0 0 18px; color:white; font-size:13px}
    label{display:block; font:600 13px/1.2 ui-sans-serif; margin:12px 0 6px}
    input[type="email"], input[type="password"]{
      width:100%; padding:12px 12px; border-radius:12px; border:1px solid #243042;
      background:#0b1220; color:#e5e7eb; outline:none; transition:border-color .15s, box-shadow .15s;
    }
    input::placeholder{color:#6b7280}
    input:focus{border-color:#2563eb; box-shadow:0 0 0 3px rgba(37,99,235,.25)}
    .bb-btn{
      width:100%; margin-top:14px; border:0; border-radius:12px; padding:12px 14px;
      background:linear-gradient(90deg,#2563eb,#22c55e); color:#fff; font-weight:700; cursor:pointer;
      transition:transform .05s ease, filter .15s ease;
    }
    .bb-btn:hover{filter:brightness(1.05)}
    .bb-btn:active{transform:translateY(1px)}
    .bb-btn[disabled]{opacity:.6; cursor:not-allowed}
    .bb-msg{margin-top:12px; font-size:13px; padding:10px 12px; border-radius:10px; line-height:1.35; border:1px solid}
    .bb-err{background:#2a1013; color:#fecaca; border-color:#7f1d1d}
    .bb-ok{background:#0f2b1c; color:#bbf7d0; border-color:#14532d}
    .bb-foot{margin-top:14px; font-size:12px; color:#94a3b8; display:flex; gap:8px; align-items:center; justify-content:center}
    .bb-spin{width:16px;height:16px;border:2px solid rgba(255,255,255,.25); border-top-color:#fff; border-radius:50%; display:inline-block; vertical-align:-3px; margin-right:8px; animation:bbspin .8s linear infinite}
    @keyframes bbspin{to{transform:rotate(360deg)}}

    /* Optional: topbar sign out on admin */
    .bb-topbar{display:flex; align-items:center; justify-content:space-between; padding:10px 14px; background:#0b1220; border-bottom:1px solid #1f2937; position:sticky; top:0; z-index:5}
   .bb-signout{
  width:100%;
  margin:10px 0 16px;
  border:1px solid #334155;
  background:#111827;
  color:#e5e7eb;
  border-radius:10px;
  padding:10px 12px;
  cursor:pointer;
}
.bb-signout:hover{ background:#0f172a; }

.bb-msg{
  display:none; align-items:flex-start; gap:10px; margin-top:12px;
  padding:12px 14px; border-radius:12px; line-height:1.35; border:1px solid;
}
.bb-err{background:#2a1013; color:#fecaca; border-color:#7f1d1d}
.bb-ok{background:#0f2b1c; color:#bbf7d0; border-color:#14532d}
.bb-msg .bb-title{font-weight:700; margin-right:4px}
.bb-msg .bb-close{margin-left:auto; background:transparent; border:0; color:inherit; cursor:pointer; font-size:18px; line-height:1}


/* ====== Layout basics (tab area) ====== */
.tab-content.section {
  padding: 14px;
}

.card {
  background: #fff;
  border: 1px solid #e5e7eb;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0,0,0,.04);
}

/* Header row & list rows */
#abList .list-item,
.card > .list-item {
  display: grid;
  grid-template-columns: 220px 120px 1fr 160px 220px;
  align-items: center;
  gap: 0;
  padding: 10px 12px;
  border-bottom: 1px solid #f1f5f9;
  font: 14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
}
#abList .list-item:last-child { border-bottom: none; }

#abList code {
  background: #f3f4f6;
  border: 1px solid #e5e7eb;
  border-radius: 6px;
  padding: 2px 6px;
  font-size: 12px;
  color: #111827;
}

/* ====== Controls row (Mode / Min / Search / Buttons) ====== */
#abuseTab select,
#abuseTab input[type="text"],
#abuseTab input[type="search"],
#abuseTab input[placeholder],
#abuseTab input {
  padding: 6px 10px;
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  background: #fff;
  outline: none;
  transition: border-color .15s ease, box-shadow .15s ease;
  font: 14px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
}
#abuseTab select:focus,
#abuseTab input:focus {
  border-color: #60a5fa;
  box-shadow: 0 0 0 3px rgba(96,165,250,.25);
}

#abuseTab label {
  color: #374151;
  user-select: none;
}

/* ====== Buttons ====== */
button {
  appearance: none;
  border: none;
  cursor: pointer;
}

.approve-btn, .btn-view, .delete-btn {
  padding: 8px 12px;
  border-radius: 10px;
  font-weight: 600;
  font-size: 13px;
  transition: transform .06s ease, box-shadow .15s ease, background .15s ease, color .15s ease;
  white-space: nowrap;
}

/* Primary / Approve */
.approve-btn {
  background: #2563eb;          /* blue-600 */
  color: #fff;
  box-shadow: 0 1px 0 rgba(0,0,0,.04), 0 4px 10px rgba(37, 99, 235, .15);
}
.approve-btn:hover { background: #1d4ed8; }
.approve-btn:active { transform: translateY(1px); }

/* Secondary / View */
.btn-view {
  background: #10b9811a;        /* subtle emerald tint */
  color: #065f46;
  border: 1px solid #10b98155;
}
.btn-view:hover {
  background: #10b98122;
  border-color: #10b98188;
}
.btn-view:active { transform: translateY(1px); }

/* Danger / Delete */
.delete-btn {
  background: #ef44441a;        /* subtle red tint */
  color: #991b1b;
  border: 1px solid #ef444455;
}
.delete-btn:hover {
  background: #ef444422;
  border-color: #ef444488;
}
.delete-btn:active { transform: translateY(1px); }

/* Disabled state helper */
button[disabled] {
  opacity: .6;
  cursor: not-allowed;
}

/* ====== Section title ====== */
#abuseTab h3 {
  font: 700 18px/1.2 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
  color: #111827;
  margin: 0 0 14px;
}

/* ====== Modal (overlay + panel) ====== */
#abuseModal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.35);
  z-index: 10000;
  align-items: center;
  justify-content: center;
}

.abuse-modal {
  background: #fff;
  width: min(94vw, 900px);
  border-radius: 14px;
  box-shadow: 0 10px 30px rgba(0,0,0,.15);
  border: 1px solid #e5e7eb;
  overflow: hidden;
  animation: scaleIn .2s ease;
}

.abuse-modal-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 8px;
  padding: 12px 14px;
  border-bottom: 1px solid #eee;
  background: #f9fafb;
}

.abuse-modal-title {
  font: 600 16px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
  color: #111827;
}

.abuse-close {
  border: none;
  background: transparent;
  font-size: 24px;
  line-height: 1;
  cursor: pointer;
  color: #374151;
  padding: 4px 8px;
  border-radius: 8px;
}
.abuse-close:hover { background: #0000000a; color: #111; }

.abuse-modal-body {
  padding: 14px;
  max-height: 70vh;
  overflow: auto;
  font: 14px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
}

/* Simple list rows inside modal */
.abuse-modal-body .list-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 12px;
  padding: 10px 12px;
  border: 1px solid #f1f5f9;
  border-radius: 10px;
  background: #fafafa;
  margin-bottom: 8px;
}
.abuse-modal-body .list-item code {
  background: #f3f4f6;
  border: 1px solid #e5e7eb;
  border-radius: 6px;
  padding: 2px 6px;
  font-size: 12px;
  color: #111827;
}

/* Animation */
@keyframes scaleIn {
  from { transform: scale(.96); opacity: 0; }
  to   { transform: scale(1);   opacity: 1; }
}

/* ====== Responsive tweaks ====== */
@media (max-width: 1024px) {
  #abList .list-item { grid-template-columns: 180px 100px 1fr 140px 200px; }
}

@media (max-width: 800px) {
  #abList .list-item {
    grid-template-columns: 1fr;
    gap: 8px;
  }
  .card > div:first-child { display: none !important; } /* hide header grid on small screens */
}

/* ====== Optional dark mode ====== */
@media (prefers-color-scheme: dark) {
  .card { background:#0b0b0c; border-color:#1f2937; }
  #abList .list-item,
  .abuse-modal-body .list-item { background:#0e0f11; border-color:#1f2937; }
  #abuseTab select,
  #abuseTab input { background:#0b0b0c; border-color:#1f2937; color:#e5e7eb; }
  #abuseTab label { color:#cbd5e1; }
  #abuseTab h3, .abuse-modal-title { color:#e5e7eb; }
  .abuse-modal { background:#0b0b0c; border-color:#1f2937; }
  .abuse-modal-header { background:#0e0f11; border-color:#1f2937; }
  .abuse-close { color:#cbd5e1; }
  #abList code, .abuse-modal-body code {
    background:#111827; border-color:#1f2937; color:#e5e7eb;
  }
}

/* Admin panel cards/spacing (light polish, safe with your UI) */
.section h3{ margin:6px 0 10px; }

/* ====== Admin: Desktop + Mobile Live Preview (fixed frames) ====== */
.slider-admin-grid{
  display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-top:12px;
}
.slider-admin-tag{ font:600 12px system-ui; color:#334155; margin:0 0 6px; }

.slider-admin-frame{
  width:920px; max-width:100%; height:80px;
  background:#f8fafc; border:1px dashed #c7d2e5; border-radius:10px;
  display:flex; align-items:center; justify-content:center; overflow:hidden;
}
.slider-admin-frame--mobile{ width:360px; height:120px; }

.slider-admin-frame img{ width:100%; height:100%; object-fit:contain; display:block; }
.slider-admin-empty{ font:600 12px system-ui; color:#7a8aa6; opacity:.9; }
.slider-admin-note{ margin-top:8px; font:12px/1.4 system-ui; color:#556987; }
.slider-file{ margin-top:8px; }

@media (max-width:860px){ .slider-admin-grid{ grid-template-columns:1fr; } }

/* ====== Admin: Slider List (mini thumbs for D & M) ====== */
#sliderList .list-item{
  display:flex; align-items:center; justify-content:space-between;
  padding:10px 12px; margin:10px 0; background:#fff;
  border:1px solid #eef1f6; border-radius:10px;
}
#sliderList .meta{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
.slider-mini{ display:flex; gap:6px; align-items:center; }
.slider-mini .box{
  width:110px; height:16px; border-radius:4px; background:#f3f6fb; border:1px solid #e8eef7;
  overflow:hidden; display:flex; align-items:center; justify-content:center;
}
.slider-mini .box.m{ width:80px; height:26px; } /* mobile thumb */
.slider-mini img{ width:100%; height:100%; object-fit:contain; display:block; }
.badge{ font:700 10px system-ui; padding:2px 6px; border-radius:999px; }
.badge.d{ background:#eaf3ff; color:#1873e8; } .badge.m{ background:#e8fff1; color:#169b52; }
.edit-btn, .delete-btn, .approve-btn, .btn{
  padding:7px 12px; border:none; border-radius:8px; font:600 12px system-ui; cursor:pointer;
}
.edit-btn{ background:#22c55e; color:#fff; }
.delete-btn{ background:#ef4444; color:#fff; }
.approve-btn.btn{ background:linear-gradient(90deg,#228bfa,#05c3ff); color:#fff; }


/* ===== NOTICE MODAL (full-screen, no-scroll, GIF friendly) ===== */
#noticeModal{
  position: fixed; inset: 0;
  display: none; /* show via JS */
  align-items: center; justify-content: center;
  background: rgba(0,0,0,.65);
  z-index: 2147483647;
  -webkit-backdrop-filter: blur(2px);
  backdrop-filter: blur(2px);
}

/* Inner card fills viewport and centers media */
#noticeContent{
  position: relative;
  width: 100vw;
  height: 100dvh;           /* includes mobile safe areas */
  background: #000;
  display: grid;
  place-items: center;
  overflow: hidden;         /* -- NO SCROLL inside */
  padding: 0;
}

/* Image/GIF fit exactly once inside the screen */
#noticeContent .notice-media{
  max-width: 100vw;
  max-height: 100dvh;
  width: auto; height: auto;
  object-fit: contain;
  display: block;
  pointer-events: none;
}

/* Optional close button (if you already have one via #closeNoticeModal, keep both) */
.notice-x{
  position: absolute; top: 10px; right: 12px;
  width: 36px; height: 36px;
  border: 0; border-radius: 999px; cursor: pointer;
  background: rgba(255,255,255,.95);
  color: #d11; font-weight: 800; font-size: 18px; line-height: 36px;
  box-shadow: 0 6px 18px rgba(0,0,0,.2);
}

/* Freeze page scroll while notice open */
body.notice-open{ overflow: hidden; height: 100dvh; }

.tab-refresh-btn{
  float:right;
  background:#f0f4ff;
  color:#2563eb;
  border:1px solid #dbeafe;
  border-radius:8px;
  padding:6px 12px;
  font-size:13px;
  font-weight:700;
  cursor:pointer;
  transition:background .18s, transform .06s;
}
.tab-refresh-btn:hover{ background:#e6efff; }
.tab-refresh-btn:active{ transform:translateY(1px); }
.tab-refresh-btn[disabled]{ opacity:.6; cursor:not-allowed; }
.tab-refresh-btn i{ margin-right:6px; }

/* ===== Admin Support Tickets â€“ Pro, clean look ===== */
#userChatTab { --ring:#e5e7eb; --ink:#111827; --muted:#6b7280; --brand:#2563eb; --bg:#f8fafc; }
#userChatTab h3{ margin:0 0 12px; font-weight:800; color:var(--ink); }


#userChatList{
  background:#fff; border:1px solid var(--ring); border-radius:12px;
  box-shadow: 0 6px 16px rgba(0,0,0,.06);
  max-height:60vh; overflow:auto;
}
#userChatList .list-item{
  padding:12px 12px; border-bottom:1px solid var(--ring); cursor:pointer;
  transition: background .15s ease, border-left-color .15s ease;
  border-left:3px solid transparent;
}
#userChatList .list-item:hover{ background:#fafafa; }
#userChatList .list-item.active{ background:#eff6ff; border-left-color:#3b82f6; }
#userChatList .badge{
  display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; border:1px solid var(--ring);
}
#userChatList .badge.Open{ background:#eff6ff; color:#1d4ed8; border-color:#bfdbfe; }
#userChatList .badge.Answered{ background:#ecfdf5; color:#15803d; border-color:#a7f3d0; }
#userChatList .badge.Closed{ background:#fef2f2; color:#b91c1c; border-color:#fecaca; }

#ticketHeader{
  padding:8px 10px; border:1px solid var(--ring); border-radius:10px; background:#fff; color:#374151;
}
#ticketHeader .chip{ display:inline-flex; gap:6px; align-items:center; padding:4px 8px; margin-right:6px; border:1px solid var(--ring); border-radius:8px; background:#f9fafb; font-size:12px; color:#6b7280; }

#liveChatBox{
  background:#fafafa; border:1px solid var(--ring); border-radius:12px; padding:12px;
  min-height:260px; max-height:50vh; overflow:auto;
  box-shadow: inset 0 1px 0 rgba(0,0,0,.02);
}

/* Bubbles */
.chat-bubble{ max-width:78%; padding:10px 12px; margin:8px 0; border-radius:12px; border:1px solid var(--ring); background:#fff; color:#111827; }
.chat-bubble.admin-message{ margin-left:auto; background:#eef2ff; border-color:#bfdbfe; }
.chat-bubble.user-message{ margin-right:auto; background:#ffffff; }
.message-time{ font-size:11px; color:#6b7280; margin-top:6px; }

/* Day separator */
.day-sep{
  text-align:center; margin:12px 0; color:#6b7280; font-size:12px; position:relative;
}
.day-sep::before, .day-sep::after{
  content:""; height:1px; background:var(--ring); position:absolute; top:50%; width:38%;
}
.day-sep::before{ left:0; } .day-sep::after{ right:0; }

/* Composer block */
#liveChatInput{
  width:100%; padding:10px 12px; border:1px solid var(--ring); border-radius:10px; background:#fff;
  line-height:1.4; resize:none; min-height:64px; max-height:220px; transition:border-color .15s ease;
}
#liveChatInput:focus{ border-color:#93c5fd; box-shadow:0 0 0 3px rgba(59,130,246,.15); outline: none; }
#liveChatSendBtn, #saveTicketStatus{
  padding:10px 14px; border-radius:10px; border:1px solid var(--ring); background:#fff; cursor:pointer;
}
#liveChatSendBtn{ background:#22c55e; color:#fff; border-color:#22c55e; }
#liveChatSendBtn:disabled{ opacity:.6; cursor:not-allowed; }
#saveTicketStatus{ background:#f3f4f6; }
#ticketStatus{ padding:8px 10px; border:1px solid var(--ring); border-radius:10px; background:#fff; }

/* Tiny scroll shadow hint inside chat */
#liveChatBox::after{
  content:""; position:sticky; bottom:-1px; display:block; height:10px;
  background:linear-gradient(0deg, rgba(0,0,0,.08), transparent);
  border-bottom-left-radius:12px; border-bottom-right-radius:12px;
}

/* ===== Status Tabs Look ===== */
#ticketStatusTabs { display:flex; gap:8px; flex-wrap:wrap; }

#ticketStatusTabs .st-btn{
  padding:8px 12px;
  border:1px solid #e5e7eb;
  border-radius:10px;
  background:#ffffff;
  color:#111827;
  cursor:pointer;
  font:inherit;
  transition:background .15s ease, color .15s ease, border-color .15s ease, box-shadow .15s ease;
}
#ticketStatusTabs .st-btn:hover{
  background:#f8fafc;
  border-color:#d1d5db;
}

/* ===== Active colors per status ===== */
#ticketStatusTabs .st-btn[data-status="Open"].active{
  background:#eff6ff;           /* light blue */
  border-color:#bfdbfe;
  color:#1d4ed8;
  box-shadow:0 0 0 3px rgba(59,130,246,.15);
}
#ticketStatusTabs .st-btn[data-status="Answered"].active{
  background:#ecfdf5;           /* light green */
  border-color:#a7f3d0;
  color:#15803d;
  box-shadow:0 0 0 3px rgba(16,185,129,.15);
}
#ticketStatusTabs .st-btn[data-status="Closed"].active{
  background:#fef2f2;           /* light red */
  border-color:#fecaca;
  color:#b91c1c;
  box-shadow:0 0 0 3px rgba(239,68,68,.12);
}

/* Pills inside button when active (counts / NEW) */
#ticketStatusTabs .st-btn .st-count{
  display:inline-block; min-width:18px; padding:2px 6px; margin-left:6px;
  border-radius:999px; border:1px solid #e5e7eb; font-size:12px; background:#f9fafb; text-align:center;
}
#ticketStatusTabs .st-btn.active .st-count{
  border-color: currentColor;
  background: rgba(255,255,255,.7);
}

#ticketStatusTabs .st-btn .st-new{
  display:inline-block; min-width:18px; padding:2px 6px; margin-left:6px;
  border-radius:999px; font-size:12px; background:#fee2e2; color:#b91c1c; border:1px solid #fecaca; text-align:center;
}
#ticketStatusTabs .st-btn[data-status="Open"].active .st-new{
  background:#fde68a; color:#92400e; border-color:#fcd34d; /* active par NEW thoda highlight */
}

/* Optional: disabled look */
#userChatTab :disabled, #userChatTab .is-disabled{ opacity:.55; cursor:not-allowed !important; }
/* Optional: active tab color (adjust as you like) */
#ticketStatusTabs .st-btn[data-status="Open"].active{
  background:#eff6ff; border-color:#bfdbfe; color:#1d4ed8; box-shadow:0 0 0 3px rgba(59,130,246,.15);
}
#ticketStatusTabs .st-btn[data-status="Answered"].active{
  background:#ecfdf5; border-color:#a7f3d0; color:#15803d; box-shadow:0 0 0 3px rgba(16,185,129,.15);
}
#ticketStatusTabs .st-btn[data-status="Closed"].active{
  background:#fef2f2; border-color:#fecaca; color:#b91c1c; box-shadow:0 0 0 3px rgba(239,68,68,.12);
}

/* ========== Notices Tab Styling ========== */

#noticesTab {
  font-family: "Poppins", sans-serif;
  color: #1e293b;
  background: #f9fafb;
  padding: 16px;
  border-radius: 12px;
}

/* ----- Section header ----- */
#noticesTab h3 {
  display: flex;
  align-items: center;
  justify-content: space-between;
  font-size: 20px;
  font-weight: 600;
  color: #0f172a;
  margin-bottom: 18px;
}

#noticesTab .tab-refresh-btn {
  background: #0ea5e9;
  color: #fff;
  font-size: 13px;
  border: none;
  border-radius: 6px;
  padding: 7px 12px;
  cursor: pointer;
  transition: background 0.2s ease;
}
#noticesTab .tab-refresh-btn:hover {
  background: #0284c7;
}

/* ----- Form section ----- */
#addNoticeForm {
  background: #fff;
  border: 1px solid #e2e8f0;
  border-radius: 10px;
  padding: 14px;
  margin-bottom: 18px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.05);
}

#addNoticeForm textarea {
  width: 100%;
  font-family: inherit;
  border: 1px solid #d1d5db;
  border-radius: 8px;
  padding: 10px;
  resize: vertical;
  font-size: 14px;
  color: #334155;
  transition: border 0.2s ease;
}
#addNoticeForm textarea:focus {
  border-color: #0ea5e9;
  outline: none;
}

#addNoticeForm input[type="file"] {
  display: block;
  margin-top: 6px;
  margin-bottom: 10px;
  font-size: 13px;
}

#addNoticeForm label {
  font-size: 14px;
  color: #475569;
  display: flex;
  align-items: center;
  gap: 6px;
}

#addNoticeForm .approve-btn {
  background: #0ea5e9;
  border: none;
  color: #fff;
  border-radius: 8px;
  padding: 9px 16px;
  font-size: 14px;
  cursor: pointer;
  font-weight: 500;
  transition: background 0.25s ease, transform 0.1s ease;
}
#addNoticeForm .approve-btn:hover {
  background: #0284c7;
  transform: translateY(-1px);
}

/* ----- Notice list container ----- */
#noticesList {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

/* ----- Each notice card ----- */
.notice-item {
  background: #fff;
  border: 1px solid #e2e8f0;
  border-radius: 12px;
  padding: 14px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.05);
  transition: box-shadow 0.2s ease;
}
.notice-item:hover {
  box-shadow: 0 2px 6px rgba(0,0,0,0.08);
}

/* Status indicators */
.notice-item .status-indicator {
  font-size: 12px;
  font-weight: 500;
  padding: 3px 10px;
  border-radius: 999px;
}
.notice-item.status-active .status-indicator {
  background: #dcfce7;
  color: #166534;
}
.notice-item.status-inactive .status-indicator {
  background: #f1f5f9;
  color: #64748b;
}

/* Header bar with switch */
.notice-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 6px;
}

.notice-body {
  font-size: 14px;
  color: #334155;
  line-height: 1.5;
  white-space: pre-wrap;
  margin: 6px 0;
}

/* Image */
.notice-item img {
  border-radius: 8px;
  width: 100%;
  max-height: 220px;
  object-fit: cover;
  margin-top: 6px;
}

/* Buttons */
.notice-actions {
  display: flex;
  gap: 8px;
  margin-top: 10px;
}

.notice-actions .btn {
  flex: 1;
  text-align: center;
  border: 1px solid #e2e8f0;
  border-radius: 8px;
  padding: 8px 0;
  font-size: 13px;
  cursor: pointer;
  background: #f9fafb;
  transition: background 0.2s ease, transform 0.1s ease;
}
.notice-actions .btn:hover {
  background: #f1f5f9;
  transform: translateY(-1px);
}

/* Edit and Delete colors */
.notice-actions .edit-btn {
  color: #0369a1;
}
.notice-actions .edit-btn:hover {
  background: #e0f2fe;
}
.notice-actions .del-btn {
  color: #b91c1c;
}
.notice-actions .del-btn:hover {
  background: #fee2e2;
}

/* Checkbox toggle */
.notice-header input[type="checkbox"] {
  transform: scale(1.1);
  accent-color: #0ea5e9;
  cursor: pointer;
}

/* Small responsive tweak */
@media (max-width: 480px) {
  #noticesTab h3 {
    flex-direction: column;
    align-items: flex-start;
    gap: 8px;
  }
}

#userReportsList .report-card {
  background: #fff8f8;
  border-left: 4px solid #ff4d4f;
  padding: 16px;
  border-radius: 12px;
  box-shadow: 0 2px 12px #ffdada3a;
  margin-bottom: 14px;
}
#userReportsList .report-card strong { color: #c0392b; }
#userReportsList .report-card small { color: #666; }

/* Paid/Free */
.fee-badge{font-weight:600;font-size:12px;padding:2px 8px;border-radius:12px;display:inline-block;margin-left:8px}
.fee-badge.free{color:#15803d;background:#ecfdf5;border:1px solid #a7f3d0}
.fee-badge.paid{color:#b91c1c;background:#fef2f2;border:1px solid #fecaca}

/* Dealer verification widget */
.dealer-verify{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border:1px solid #e5e7eb;border-radius:12px;background:#fff;margin-top:6px}
.dealer-verify .title{font-weight:700;font-size:13px;margin-right:4px}
.dealer-verify .btn{border:0;border-radius:8px;padding:6px 10px;font-weight:700;cursor:pointer}
.dealer-verify .ok{background:#16a34a;color:#fff}
.dealer-verify .no{background:#ef4444;color:#fff}
.dealer-proof{font-size:12px;text-decoration:underline;color:#2563eb;margin-left:6px}
.dealer-badge{display:inline-block;font-size:12px;font-weight:700;color:#065f46;background:#d1fae5;border:1px solid #a7f3d0;border-radius:999px;padding:3px 10px;margin-left:8px}
.dealer-pill {
  display: inline-flex;
  align-items: center;
  background: #ecfdf5;
  color: #047857;
  font-weight: 600;
  font-size: 13px;
  border-radius: 999px;
  padding: 5px 12px;
  margin-top: 4px;
  cursor: pointer;
  border: 1px solid #a7f3d0;
  transition: background 0.2s ease;
}
.dealer-pill:hover {
  background: #d1fae5;
}
.dealer-pill i {
  margin-left: 6px;
  font-size: 13px;
  color: #059669;
}


</style>

</head>
<body>
    

  <div id="bbLoginOverlay" aria-labelledby="bbLoginTitle" aria-modal="true" role="dialog">
  <div class="bb-card">
    <h1 id="bbLoginTitle">Admin Login</h1>
    <p class="bb-sub">Only authorized administrators can sign in.</p>

    <form id="bbLoginForm" novalidate>
      <label for="bbEmail">Email</label>
      <input id="bbEmail" type="email" inputmode="email" placeholder="" autocomplete="username" required />

      <label for="bbPass">Password</label>
      <input id="bbPass" type="password" placeholder="" autocomplete="current-password" required />

      <button id="bbLoginBtn" class="bb-btn" type="submit"><span id="bbBtnText">Login</span></button>
      <div id="bbMsg" class="bb-msg" style="display:none"></div>
    </form>

    <div class="bb-foot"><span>ðŸ”’</span> Protected Admin Access</div>
  </div>
</div>



    
<div id="chatPopup" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%);
  width:90%; max-width:500px; background:white; border-radius:10px; padding:15px; box-shadow:0 0 15px rgba(0,0,0,0.2); z-index:1000;">
  <h3>Chat History</h3>
  <div id="chatPopupContent" style="max-height:300px; overflow-y:auto; margin-top:10px;"></div>
  <button onclick="closeChatPopup()" style="margin-top:15px; padding:6px 14px;">Close</button>
</div>
<div id="popupBackdrop" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0;
  background:rgba(0,0,0,0.5); z-index:999;" onclick="closeChatPopup()"></div>

<div id="userDetailsModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.4); z-index:9999;">
  <div style="
    background:#fff; 
    max-width:400px; 
    margin:80px auto; 
    padding:20px; 
    border-radius:10px; 
    box-shadow:0 4px 20px rgba(0,0,0,0.2);
    max-height:calc(100vh - 120px);   
    overflow-y:auto;                  
    ">
    <h3 style="margin-top:0;">User Details</h3>
    <div id="userDetailsContent" style="font-size:14px; line-height:1.6;"></div>
    <div style="text-align:right; margin-top:10px;">
      <button onclick="document.getElementById('userDetailsModal').style.display='none'" style="padding:6px 12px; border:none; background:#333; color:white; border-radius:6px;">Close</button>
    </div>
  </div>
</div>


<!-- Image enlarge modal -->
<div id="boostImageModal" style="display:none;position:fixed;z-index:99999;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.7);justify-content:center;align-items:center;">
  <img id="boostImageLarge" src="" style="max-width:94vw;max-height:94vh;border-radius:18px;box-shadow:0 2px 28px #111;" />
</div>

  <!-- ========== Sidebar ========== -->
  <div class="sidebar">
  <button id="bbSignOutBtn" class="bb-signout" type="button">Sign out</button>

  <h4>Admin Panel</h4>
  <ul>
    <li class="active" data-tab="dashboardTab"><i class="fas fa-th"></i> Dashboard</li>
    <li data-tab="amountTab"><i class="fas fa-wallet"></i> Finance Management</li>
    <li data-tab="categoryTab"><i class="fa fa-list"></i> Category Management</li>
    <li data-tab="usersTab"><i class="fas fa-users"></i> Users Management</li>
    <li data-tab="adsTab"><i class="fas fa-ad"></i> All Ads Management</li>
    <li data-tab="adsReviewTab"><i class="fas fa-hourglass-half"></i> Pending Ads Review</li>
    <li data-tab="reportsTab"><i class="fas fa-flag"></i> Ads Report</li>
    <li data-tab="userReportsTab"><i class="fa-solid fa-flag"></i> User Reports</li>
    <li data-tab="messagesTab"><i class="fas fa-comments"></i> Users Chat</li>
    <li data-tab="userChatTab"><i class="fas fa-headset"></i> Admin-User Chat Ticket</li>
    <li data-tab="noticesTab"><i class="fas fa-bell"></i> Notices</li>
    <li data-tab="boostRequestsTab"><i class="fas fa-bolt"></i> Ads Boost Request(not in use)</li>
    <li data-tab="deletedAdsTab"><i class="fas fa-trash-alt"></i> User Deleted Ads</li>
    <li data-tab="sliderTab"><i class="fas fa-sliders-h"></i> Slider</li>
    <li data-tab="pushCenterTab"><i class="fas fa-bullhorn"></i> Push Center</li>
    <li data-tab="abuseTab"><i class="fas fa-user-shield"></i> Abuse / Same-IP</li>
  </ul>
</div>


  <!-- ========== Main Content ========== -->
<div class="content">
    <!-- Top Summary (Dashboard stats) -->
    <div class="top-summary">
      <div class="card">
  <h5>Amount Recieved</h5>
  <!-- ðŸ”’ password unlock ke baad hi value dikhegi -->
  <p id="totalAmountReceivedDashboard"
     data-secure="amount-received"
     data-fetch="loadDashboardStats">â‚¹ â€¢â€¢â€¢â€¢â€¢</p>
</div>

      <div class="card"><h5>Total Users</h5><p id="totalUsers">0</p></div>
      <div class="card"><h5>Total Ads</h5><p id="totalAds">0</p></div>
      <div class="card"><h5>Total Ads Reports</h5><p id="totalReports">0</p></div>
      <div class="card"><h5>Total Users Reports</h5><p id="totalUserReports">0</p></div>
      <div class="card"><h5>New Tickit Chats</h5><p id="totalTickitChats">0</p></div>
      <div class="card"><h5>Pending Ads</h5><p id="totalPendingAds">0</p></div>
     <div class="card"><h5>Pending Boost Requests</h5><p id="totalPendingBoost">0</p></div></div>

 <!-- ========== Dashboard Overview Section ========== -->
<div id="dashboardTab" class="tab-content section">
  <h3 style="margin-bottom: 20px;">
  ðŸ“Š Dashboard Overview
  <button class="tab-refresh-btn" onclick="refreshTab('dashboardTab')">
    <i class="fa fa-rotate-right"></i> Refresh
  </button>
</h3>


  <!-- Filters -->
  <div style="display:flex;flex-wrap:wrap;justify-content:space-between;align-items:center;margin-bottom: 20px;gap:12px;">
    <div>
      <label style="font-weight: 600;">Date Range:</label>
      <select id="dateRange" onchange="updateFullDashboardChart()" style="padding:8px 12px; border-radius:6px;">
        <option value="7">Last 7 Days</option>
        <option value="30">Last 30 Days</option>
        <option value="90">Last 90 Days</option>
        <option value="365">Last 1 Year</option>
        <option value="custom">Custom Range</option>
      </select>
      <input type="date" id="startDate" style="display:none;margin-left:8px;" onchange="updateFullDashboardChart()" />
      <input type="date" id="endDate" style="display:none;margin-left:4px;" onchange="updateFullDashboardChart()" />
    </div>
    <div>
      <select id="chartType" onchange="updateFullDashboardChart()" style="padding:8px 12px; border-radius:6px;">
        <option value="bar">Bar Chart</option>
        <option value="line">Line Chart</option>
      </select>
      <button onclick="downloadFullReportCSV()" style="padding: 8px 16px; margin-left: 8px; background:#007bff; color:#fff; border:none; border-radius:6px; cursor:pointer;">
        â¬‡ Download CSV
      </button>
    </div>
  </div>

  <!-- Chart -->
  <div style="background:#fff; padding:20px; border-radius:12px; box-shadow:0 1px 6px rgba(0,0,0,0.1); margin-bottom: 30px;">
    <canvas id="fullDashboardChart" height="110"></canvas>
  <!-- In the tab/panel where you draw the chart -->


  </div>
</div>

<!-- Not inside card or grid -->
<div id="deletedAdsTab" class="tab-content section" style="display:none;">
  <h3 style="margin-bottom:15px;">
  ðŸ—‘ï¸ Deleted Ads (User Removed)
  <button class="tab-refresh-btn" onclick="refreshTab('deletedAdsTab')">
    <i class="fa fa-rotate-right"></i> Refresh
  </button>
</h3>

  <div id="deletedAdsList" style="display: flex; flex-direction: column; gap: 16px;"></div>
</div>

    <!-- ========== Amount Received Tab ========== -->
<div id="amountTab" class="tab-content section" style="display:none;">
  <h3>
  Amount Received
  <button class="tab-refresh-btn" onclick="refreshTab('amountTab')">
    <i class="fa fa-rotate-right"></i> Refresh
  </button>
</h3>

<div style="margin: 10px 0;">
  <button onclick="downloadPaymentsCSV('approved')" style="padding: 8px 16px; background:#28a745; color:#fff; border:none; border-radius:6px;">â¬‡ Download Approved CSV</button>
  <button onclick="downloadPaymentsCSV('rejected')" style="padding: 8px 16px; background:#dc3545; color:#fff; border:none; border-radius:6px; margin-left: 12px;">â¬‡ Download Rejected CSV</button>
</div>

  <div id="amountReceivedSummary">
    <div style="font-size: 25px; margin-bottom: 20px;">
      Total Amount Received: <span id="totalAmountReceivedAmountTab" style="color: green;">â‚¹0</span>
    </div>
    <!-- Tab buttons -->
<div style="margin-bottom: 14px;">
  <button id="approvedTabBtn" class="ads-tab-btn active" onclick="showPaymentsTab('approved')">Approved Payments</button>
  <button id="rejectedTabBtn" class="ads-tab-btn" onclick="showPaymentsTab('rejected')">Rejected Payments</button>
</div>

<!-- Tab contents -->
<div id="approvedPaymentsList"></div>
<div id="rejectedPaymentsList" style="display:none;"></div>

  </div>
</div>

<div id="sliderTab" class="tab-content section" style="display:none;">
  <h3>
  Homepage Banner/Slider Control
  <button class="tab-refresh-btn" onclick="refreshTab('sliderTab')">
    <i class="fa fa-rotate-right"></i> Refresh
  </button>
</h3>


  <div id="addSliderForm" style="margin-bottom:18px;">
    <input id="sliderText"  placeholder="Slider Text (optional)"
           style="padding:7px 14px;border-radius:7px;border:1px solid #ddd;width:220px;">
    <input id="sliderLink"  placeholder="Slider Link (optional)"
           style="padding:7px 14px;border-radius:7px;border:1px solid #ddd;width:160px;">
    <input id="sliderOrder" type="number" min="1" value="1"
           style="width:60px;padding:7px 5px;border-radius:7px;border:1px solid #ddd;">
    <label style="font-size:13px;margin-left:8px;">
      <input type="checkbox" id="sliderActive" checked style="margin-right:4px;">Active
    </label>
    <label style="font-size:13px;margin-left:8px;">
      <input type="checkbox" id="showOnDesktop" checked style="margin-right:4px;">Desktop
    </label>
    <label style="font-size:13px;margin-left:8px;">
      <input type="checkbox" id="showOnMobile" checked style="margin-right:4px;">Mobile
    </label>
    <button id="saveSliderBtn" class="approve-btn btn" style="margin-left:9px;">Add Slider</button>
    <span style="font-size:12px;color:#777;margin-left:20px;">
      Upload sizes â€” Desktop: <b>920Ã—80</b>, Mobile: <b>360Ã—120</b> (JPG/PNG/WebP)
    </span>

    <!-- Live previews + uploads -->
    <div class="slider-admin-grid">
      <!-- Desktop -->
      <div>
        <div class="slider-admin-tag">Desktop 920Ã—80</div>
        <div class="slider-admin-frame">
          <img id="sliderPreviewImgDesktop" alt="Desktop Preview" style="display:none;">
          <span class="slider-admin-empty" id="sliderPreviewEmptyDesktop">Preview 920Ã—80</span>
        </div>
        <input type="file" id="desktopImageFile" accept="image/*" class="slider-file">
      </div>
      <!-- Mobile -->
      <div>
        <div class="slider-admin-tag">Mobile 360Ã—120</div>
        <div class="slider-admin-frame slider-admin-frame--mobile">
          <img id="sliderPreviewImgMobile" alt="Mobile Preview" style="display:none;">
          <span class="slider-admin-empty" id="sliderPreviewEmptyMobile">Preview 360Ã—120</span>
        </div>
        <input type="file" id="mobileImageFile" accept="image/*" class="slider-file">
      </div>
    </div>

    <div id="sliderPreviewNote" class="slider-admin-note"></div>
  </div>

  <hr>
  <div id="sliderList">Loading slidersâ€¦</div>
</div>


<!-- âœ… CATEGORY MANAGER TAB (between Slider and Users) -->
<div id="categoryTab" class="tab-content section" style="display:none;">
  <h3>
    Category Manager
    <button class="tab-refresh-btn" onclick="refreshTab('categoryTab')">
      <i class="fa fa-rotate-right"></i> Refresh
    </button>
  </h3>

  <!-- â”€â”€â”€ Add / Edit Category â”€â”€â”€ -->
  <div class="card" style="margin-bottom:16px; padding:12px; background:#f8faff; border-radius:10px;">
    <h4 style="margin:0 0 10px;">Add / Edit Category</h4>

    <div class="inputs-row" style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
      <input id="catName" type="text" placeholder="Category name (e.g. Mobiles)" aria-label="Category name" style="color:black;">
      <input id="catIcon" type="text" placeholder="FontAwesome class (optional) e.g. fa-solid fa-mobile-screen" aria-label="Icon class" style="color:black;">
      <input id="catOrder" type="number" placeholder="Order" value="1" min="0" style="width:110px; color:black;" aria-label="Display order">
      <label style="display:flex; align-items:center; gap:6px;"><input id="catActive" type="checkbox" checked> Active</label>
    </div>

    <!-- NEW: PNG icon upload row -->
    <div class="inputs-row" style="display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:10px;">
      <input id="catIconFile" type="file" accept="image/png,image/webp" aria-label="Upload icon (PNG/WebP)" />
      <button id="uploadCatIconBtn" type="button" class="approve-btn">
        <i class="fa fa-upload"></i> Upload PNG
      </button>
      <button id="removeCatIconBtn" type="button" class="btn-delete" style="display:none;">
        <i class="fa fa-times"></i> Remove Icon
      </button>
      <small>Recommended: square PNG ~128â€“256px</small>
    </div>

    <!-- Preview -->
    <div style="margin-top:8px; display:flex; align-items:center; gap:10px;">
      <img id="catIconPreview" src="" alt="Preview" style="width:60px;height:60px;object-fit:contain;border:1px solid #ddd;border-radius:8px;display:none;background:#fff;">
      <code id="catIconUrlCode" style="display:none; font-size:12px;"></code>
    </div>

    <div style="margin-top:10px;">
      <label for="catSubs" style="display:block; font-weight:600; margin-bottom:6px;">Sub-categories (one per line)</label>
      <textarea id="catSubs" rows="5" style="width:100%; border-radius:10px; padding:10px; border:1px solid #d5e0ff; color:black;"
        placeholder="Smartphone
Tablet
Wearables
Other"></textarea>
      <small>Tip: har line ek subcategory. Order upar se neeche 1..N. Default active=true. Advanced: <code>Name|order|active</code> (e.g. <code>Smartphone|3|false</code>).</small>
    </div>

    <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
      <button id="saveCatWithSubsBtn" class="approve-btn">Save Category + Subcategories</button>
      <button id="resetCatFormBtn" class="btn-view" type="button">Reset</button>
    </div>
  </div>

  <!-- â”€â”€â”€ Category tabs (drag to reorder) â”€â”€â”€ -->
  <div class="tabs-card">
    <div class="tabs-toolbar" style="display:flex;justify-content:space-between;align-items:center;gap:8px;">
      <div style="min-width:220px">
        <small style="color:#6b7280">Categories (drag to reorder)</small>
        <div id="catTabs" class="tabs-row" style="display:flex;gap:8px;flex-wrap:wrap;"></div>
      </div>
      <button id="saveCatOrderBtn" class="approve-btn" disabled>Save Category Order</button>
    </div>
  </div>

  <!-- Category cards list -->
  <div id="catList" style="margin-top:10px;"></div>

  <hr style="margin:18px 0;">

  <!-- â”€â”€â”€ Subcategory tabs (drag to reorder) â”€â”€â”€ -->
  <div id="subTabsWrap" class="tabs-card" style="display:none">
    <div class="tabs-toolbar" style="display:flex;justify-content:space-between;align-items:center;gap:8px;">
      <div style="min-width:220px">
        <small style="color:#6b7280">Subcategories for <b id="subTabsFor"></b> (drag to reorder)</small>
        <div id="subTabs" class="tabs-row" style="display:flex;gap:8px;flex-wrap:wrap;"></div>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;">
        <button id="saveSubOrderBtn" class="approve-btn" disabled>Save Sub Order</button>
        <button id="closeSubEditorBtn" class="btn-delete" type="button" title="Close">âœ•</button>
      </div>
    </div>
  </div>

  <!-- â”€â”€â”€ Subcategory editor (same screen) â”€â”€â”€ -->
  <div id="subcatEditor" style="display:none;">
    <small style="display:block;margin:8px 0;color:#6b7280">Tip: Subcategories ko drag karke order set karo, phir â€œSave Sub Orderâ€.</small>

    <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;">
      <h4 style="margin:0;">Manage Subcategories for: <span id="subcatFor"></span></h4>
      <button id="closeSubEditorBtn2" class="btn-delete" type="button">âœ• Close</button>
    </div>

    <!-- single add -->
    <div class="inputs-row" style="display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:8px;">
      <input id="subName" type="text" placeholder="Subcategory name (e.g. Smartphones)" aria-label="Subcategory name" style="color:black;">
      <input id="subOrder" type="number" placeholder="Order" value="1" min="0" style="width:110px;color:black;" aria-label="Subcategory order">
      <label style="display:flex; align-items:center; gap:6px; color:black;"><input id="subActive" type="checkbox" checked> Active</label>
      <button id="addSubBtn" class="approve-btn" type="button">Add Subcategory</button>
    </div>

    <!-- bulk tools -->
    <div style="margin-top:16px; padding:12px; border:1px dashed #9ab0ff; border-radius:10px; background:#f7faff;">
      <h5 style="margin:0 0 8px;">Bulk Add / Replace</h5>
      <textarea id="bulkSubs" rows="6" style="width:100%; border-radius:10px; padding:10px; border:1px solid #d5e0ff;color:black;"
        placeholder="One per line. Optional format: Name|order|active"></textarea>
      <div style="display:flex; gap:8px; margin-top:8px; flex-wrap:wrap;">
        <button id="bulkAppendBtn" class="btn-view" type="button">Append</button>
        <button id="bulkReplaceBtn" class="btn-delete" type="button">Replace All</button>
      </div>
      <small>Append: maujooda subcategories me add karega. Replace: pehle sab delete karke naya set likhega.</small>
    </div>

    <!-- list (drag here also) -->
    <div id="subList" style="margin-top:12px;"></div>
  </div>
</div>





    <!-- ========== Users Tab ========== -->
<div id="usersTab" class="tab-content section" style="display:none;">
  <h3>
  User Management
  <button class="tab-refresh-btn" onclick="refreshTab('usersTab')">
    <i class="fa fa-rotate-right"></i> Refresh
  </button>
</h3>

  
  <div style="margin-bottom:16px; display:flex; gap:16px;">
<button class="users-tab-btn active" data-status="all">
    All Users <span id="allUsersCount" class="user-count-badge">0</span>
  </button>
  <button class="users-tab-btn" data-status="active">
    Active Users <span id="activeUsersCount" class="user-count-badge">0</span>
  </button>
  <button class="users-tab-btn" data-status="suspended">
    Suspended Users <span id="suspendedUsersCount" class="user-count-badge">0</span>
  </button>
  
</div>
<div id="userList">Loading usersâ€¦</div>
</div>


      <!-- ========== All Ads Tab ========== -->
<div id="adsTab" class="tab-content section" style="display:none;">
  <h3>
  All Ads
  <button class="tab-refresh-btn" onclick="refreshTab('adsTab')">
    <i class="fa fa-rotate-right"></i> Refresh
  </button>
</h3>

  <!-- List ke bilkul upar, filter tabs ke niche yeh add karein: -->
<div id="bulkActionBar" style="display:flex;align-items:center;gap:15px;margin-bottom:13px;">
  <input type="checkbox" id="selectAllAds" style="transform:scale(1.2);vertical-align:middle;">
  <label for="selectAllAds" style="font-weight:500;font-size:15px;color:#0e3662;margin-right:22px;">Select All</label>
  <button id="bulkApproveBtn" class="ads-bulk-btn" disabled>Approve</button>
  <button id="bulkRejectBtn" class="ads-bulk-btn" disabled>Reject</button>
  <button id="bulkDeleteBtn" class="ads-bulk-btn" disabled>Delete</button>
  <span id="bulkSelectedCount" style="color:#3a83de;font-size:14px;margin-left:8px;"></span>
</div>

  <!-- Status Tabs -->
  <div id="adsStatusTabs" style="display:flex;gap:10px;margin-bottom:18px;">
  <button class="ads-tab-btn active" data-status="all">
    All <span id="adsCountAll" class="user-count-badge all-badge">0</span>
  </button>
  <button class="ads-tab-btn" data-status="pending">
    Pending <span id="adsCountPending" class="user-count-badge pending-badge">0</span>
  </button>
  <button class="ads-tab-btn" data-status="approved">
    Approved <span id="adsCountApproved" class="user-count-badge active-badge">0</span>
  </button>
  <button class="ads-tab-btn" data-status="rejected">
    Rejected <span id="adsCountRejected" class="user-count-badge suspended-badge">0</span>
  </button>
  <button class="ads-tab-btn" data-status="expired">
    Expired <span id="adsCountExpired" class="user-count-badge" style="background:#eee;color:#444;">0</span>
  </button>
</div>


  <!-- Ads List Will Render Here -->
  <div id="adsList">Loading all adsâ€¦</div>
</div>



<!-- ========== PUSH CENTER (No Sign-in) ========== -->
<div id="pushCenterTab" class="tab-content section" style="display:none;">
  <h3>
  Push Center
  <button class="tab-refresh-btn" onclick="refreshTab('pushCenterTab')">
    <i class="fa fa-rotate-right"></i> Refresh
  </button>
</h3>

  <p style="color:#666;margin-top:-6px">n3tliFY_$uper$3CR3T_2025</p>

  <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;align-items:start;">
    <div style="background:#fff;border:1px solid #eee;border-radius:12px;padding:14px;">
      <h4 style="margin:0 0 8px 0;">Admin Key</h4>
      <input id="pc_adminKey" type="password" placeholder="Enter Admin Key"
             style="width:100%;padding:10px;border:1px solid #ddd;border-radius:8px;">
      <div style="display:flex;gap:10px;margin-top:8px;">
        <button id="pc_saveKey" class="btn">Save (this tab)</button>
        <button id="pc_clearKey" class="btn" style="background:#eee;color:#333;">Clear</button>
      </div>
      <small style="color:#777;">Key <b>sessionStorage</b> me save hoti hai. Tab close karte hi clear ho jaayegi.</small>
    </div>

    <div style="background:#fff;border:1px solid #eee;border-radius:12px;padding:14px;">
      <h4 style="margin:0 0 8px 0;">Notification</h4>
      <label style="font-weight:600;">Title</label>
      <input id="pc_title" placeholder="e.g. Big Sale Today!"
             style="width:100%;padding:10px;border:1px solid #ddd;border-radius:8px;">

      <label style="font-weight:600;display:block;margin-top:10px;">Description / Body</label>
      <textarea id="pc_body" rows="3" placeholder="Short message..."
                style="width:100%;padding:10px;border:1px solid #ddd;border-radius:8px;"></textarea>

      <label style="font-weight:600;display:block;margin-top:10px;">Click Link</label>
      <input id="pc_link" placeholder="https://bechobazaar.com/" value="https://bechobazaar.com/"
             style="width:100%;padding:10px;border:1px solid #ddd;border-radius:8px;">

      <label style="font-weight:600;display:block;margin-top:10px;">Image URL (optional)</label>
      <input id="pc_image" placeholder="https://â€¦/banner.jpg"
             style="width:100%;padding:10px;border:1px solid #ddd;border-radius:8px;">

      <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap;">
        <button id="pc_sendAll" class="approve-btn btn">Send to ALL users</button>
      </div>
      <div id="pc_out" style="margin-top:10px;color:#0a6;"></div>
    </div>
  </div>

  <div style="background:#fff;border:1px solid #eee;border-radius:12px;padding:14px;margin-top:16px;">
    <h4 style="margin:0 0 8px 0;">Target by UIDs (optional)</h4>
    <textarea id="pc_uids" rows="4" placeholder="uid1, uid2  (comma or one per line)"
              style="width:100%;padding:10px;border:1px solid #ddd;border-radius:8px;"></textarea>
    <button id="pc_sendUids" class="btn" style="margin-top:10px;">Send to these UIDs</button>
  </div>

  <!-- ========== PUSH HISTORY (under Push Center) ========== -->
  <div id="pc_history_wrap" style="margin-top:18px;">
    <h3 style="margin:0 0 8px 0;">Push History</h3>
    <div style="display:flex;gap:10px;margin:8px 0 12px;">
      <button id="pc_hist_refresh" class="btn">Refresh</button>
      <button id="pc_hist_more" class="btn" style="background:#eee;color:#333;">Load more</button>
    </div>

    <div style="overflow:auto;border:1px solid #eee;border-radius:12px;">
      <table id="pc_hist_table" style="width:100%;border-collapse:collapse;font-size:14px;">
        <thead style="background:#f8fafc;">
          <tr>
            <th style="text-align:left;padding:10px;border-bottom:1px solid #eee;">Date</th>
            <th style="text-align:left;padding:10px;border-bottom:1px solid #eee;">Title</th>
            <th style="text-align:left;padding:10px;border-bottom:1px solid #eee;">Audience</th>
            <th style="text-align:left;padding:10px;border-bottom:1px solid #eee;">Sent</th>
            <th style="text-align:left;padding:10px;border-bottom:1px solid #eee;">Failed</th>
            <th style="text-align:left;padding:10px;border-bottom:1px solid #eee;">Tokens</th>
            <th style="text-align:left;padding:10px;border-bottom:1px solid #eee;">Removed</th>
            <th style="text-align:left;padding:10px;border-bottom:1px solid #eee;">Link</th>
            <th style="text-align:left;padding:10px;border-bottom:1px solid #eee;">Details</th>
          </tr>
        </thead>
        <tbody id="pc_hist_body"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- ===== Abuse / Same-IP Tab ===== -->
<div id="abuseTab" class="tab-content section" style="display:none;">
  <h3 style="margin-bottom:14px;">
  ðŸš¨ Same-IP â†’ Multiple Accounts
  <button class="tab-refresh-btn" onclick="refreshTab('abuseTab')">
    <i class="fa fa-rotate-right"></i> Refresh
  </button>
</h3>

  <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:10px;">
    <label style="font-size:13px;">Mode</label>
    <select id="abMode" style="padding:6px 8px;border-radius:8px;border:1px solid #e5e7eb;">
      <option value="index" selected>Reverse index</option>
      <option value="lastip">Scan lastIP (users)</option>
    </select>

    <label style="font-size:13px;">Min Accounts</label>
    <select id="abMinUids" style="padding:6px 8px;border-radius:8px;border:1px solid #e5e7eb;">
      <option value="2" selected>2+</option>
      <option value="3">3+</option>
      <option value="4">4+</option>
    </select>

    <input id="abSearch" placeholder="Search IP, UID, email, phoneâ€¦"
           style="flex:1;min-width:220px;padding:6px 10px;border-radius:8px;border:1px solid #e5e7eb;">
    <button id="abRefresh" class="approve-btn" type="button">Refresh</button>
    <button id="abExport" class="btn-view" type="button">Export CSV</button>
  </div>

  <div class="card" style="padding:0;">
    <div style="display:grid;grid-template-columns:220px 120px 1fr 220px 160px 220px;background:#f9fafb;border-bottom:1px solid #e5e7eb;padding:10px 12px;font:600 13px system-ui;">
  <div>Public IP</div>
  <div>Unique UIDs</div>
  <div>Sample</div>
  <div>Phones</div>
  <div>Last Seen</div>
  <div>Actions</div>
</div>

    <div id="abList"></div>
  </div>
</div>

<!-- ===== Modal: IP Details ===== -->
<div id="abuseModal"
     style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.35);
            z-index:10000; align-items:center; justify-content:center;">
  <div class="abuse-modal">
    <div class="abuse-modal-header">
      <div class="abuse-modal-title">IP Details</div>
      <button id="abuseClose" class="abuse-close">&times;</button>
    </div>
    <div id="abuseModalBody" class="abuse-modal-body"></div>
  </div>
</div>




    <!-- ========== Notices Tab ========== -->
    <div id="noticesTab" class="tab-content section" style="display:none;">
     <h3>
  Manage Notices
  <button class="tab-refresh-btn" onclick="refreshTab('noticesTab')">
    <i class="fa fa-rotate-right"></i> Refresh
  </button>
</h3>


      <!-- 1) Form to create a new notice -->
      <div id="addNoticeForm">
        <textarea id="noticeText" placeholder="Notice text (optional)" rows="3" style="width:100%; margin-bottom:10px; padding:8px;"></textarea>

<input type="file" id="noticeImageFile" accept="image/*" style="margin-bottom:10px;">
<small style="display:block; margin-bottom:16px;">Optional: Upload an image</small>

        <label>
          <input type="checkbox" id="noticeActive" checked/>
          Active (visible to users)
        </label>
        <br/><br/>
        <button id="saveNoticeBtn" class="approve-btn btn">Save Notice</button>
      </div>

      <hr/>

      <!-- 2) List existing notices -->
      <div id="noticesList">
        <!-- Dynamically injected: each notice with â€œEditâ€ / â€œDeleteâ€ -->
        Loading noticesâ€¦
      </div>
    </div>

   <!-- ========== Ads Review (Pending Ads) Tab ========== -->
<div id="adsReviewTab" class="tab-content section" style="display:none;">
  <h3>
  Ads Review (Pending)
  <button class="tab-refresh-btn" onclick="refreshTab('adsReviewTab')">
    <i class="fa fa-rotate-right"></i> Refresh
  </button>
</h3>

<div style="margin-bottom: 12px; display: flex; align-items: center; gap: 14px;">
  <input type="checkbox" id="selectAllPending" style="transform: scale(1.2);">
  <label for="selectAllPending" style="font-weight: 500;">Select All</label>
  <button onclick="bulkApprovePending()" style="background: #dff7e6; color: #0b9444; padding: 6px 14px; border-radius: 6px; border: none;">âœ… Approve Selected</button>
  <button onclick="bulkRejectPending()" style="background: #ffeaea; color: #d93025; padding: 6px 14px; border-radius: 6px; border: none;">âŒ Reject Selected</button>
</div>
<hr>
<br>
  <div id="adsReviewList">Loading pending adsâ€¦</div>
</div>


    <div id="reportsTab" class="tab-content section" style="display:none;">
  <h3>
  Reports
  <button class="tab-refresh-btn" onclick="refreshTab('reportsTab')">
    <i class="fa fa-rotate-right"></i> Refresh
  </button>
</h3>


  <!-- Tab buttons -->
  <div style="margin-bottom: 16px;">
    <button onclick="showReportSection('active')" id="tabActiveBtn" style="padding:6px 14px; background:#d9efff; border:none; border-radius:6px; margin-right:6px; font-weight:bold;">Active Reports</button>
    <button onclick="showReportSection('history')" id="tabHistoryBtn" style="padding:6px 14px; background:#f1f1f1; border:none; border-radius:6px; font-weight:bold;">History</button>
 
  </div>

  <!-- Active Report List -->
  <div id="activeReportsSection">
    <div id="reportList">Loading reportsâ€¦</div>
  </div>

  <!-- History Report List -->
  <div id="historyReportsSection" style="display:none;">
    <div id="reportHistoryList">Loading historyâ€¦</div>
  </div>
</div>


    <!-- ========== Messages Tab ========== -->
    <div id="messagesTab" class="tab-content section" style="display:none;">
      <h3>
  All Chats (User â†” User / Non-Admin)
  <button class="tab-refresh-btn" onclick="refreshTab('messagesTab')">
    <i class="fa fa-rotate-right"></i> Refresh
  </button>
</h3>

      <div id="chatList">Loading chatsâ€¦</div>
    </div>

<!-- Boost Requests Tab/Section -->
<div id="boostRequestsTab" class="tab-content section" style="display:none;">
  <h3 style="margin-bottom:12px;">
  Boost & Paid Post Requests
  <button class="tab-refresh-btn" onclick="refreshTab('boostRequestsTab')">
    <i class="fa fa-rotate-right"></i> Refresh
  </button>
</h3>


  <!-- Inner Tabs -->
  <div id="boostInnerTabs" style="display:flex;gap:8px;margin-bottom:10px;">
    <button id="btnBoostTab" class="ads-tab-btn active">Boost Ads</button>
    <button id="btnPostFeeTab" class="ads-tab-btn">Paid Post Ads</button>
  </div>

  <!-- Boost list (existing) -->
  <div id="boostRequestsList"></div>

  <!-- NEW: Paid Post list -->
  <div id="postFeeRequestsList" style="display:none;"></div>

  <!-- Reuse the same image modal for screenshot enlarge -->
  <div id="boostImageModal" class="modal" style="display:none;align-items:center;justify-content:center;">
    <div class="modal-content" style="max-width:90%;max-height:90%;padding:0;border:none;background:transparent;box-shadow:none;">
      <span class="modal-close" onclick="document.getElementById('boostImageModal').style.display='none';" style="position:absolute;top:6px;right:12px;font-size:28px;color:#fff;cursor:pointer;">&times;</span>
      <img id="boostImageLarge" src="" style="max-width:100%;max-height:85vh;border-radius:8px;" />
    </div>
  </div>
</div>



   <!-- ========== User Chat (Admin â†” User) Tab ========== -->
  <div id="userChatTab" class="tab-content section" style="display:none;">
  <h3>
    Support Tickets
    <button class="tab-refresh-btn" onclick="refreshTab('userChatTab')">
      <i class="fa fa-rotate-right"></i> Refresh
    </button>
  </h3>

  <div style="display:flex; gap:20px;">
    <!-- LEFT: Ticket list + status tabs -->
    <div style="width:40%; border-right:1px solid #ccc; padding-right:12px;">
      <!-- Status tabs with counts -->
      <!-- Status tabs (no "All") -->
<div id="ticketStatusTabs" class="status-tabs" style="margin-bottom:10px; display:flex; gap:8px; flex-wrap:wrap;">
  <button class="st-btn active" data-status="Open" style="padding:8px 12px; border:1px solid #e5e7eb; border-radius:10px; background:#fff; cursor:pointer;">
    Open
    <span class="st-count" id="stOpen" style="display:inline-block; min-width:18px; padding:2px 6px; margin-left:6px; border-radius:999px; border:1px solid #e5e7eb; font-size:12px; background:#f9fafb; text-align:center;">0</span>
    <span class="st-pill st-new" title="New user messages in Open tickets" style="display:inline-block; min-width:18px; padding:2px 6px; margin-left:6px; border-radius:999px; font-size:12px; background:#fee2e2; color:#b91c1c; border:1px solid #fecaca; text-align:center;">0</span>
  </button>
  <button class="st-btn" data-status="Answered" style="padding:8px 12px; border:1px solid #e5e7eb; border-radius:10px; background:#fff; cursor:pointer;">
    Answered
    <span class="st-count" id="stAnswered" style="display:inline-block; min-width:18px; padding:2px 6px; margin-left:6px; border-radius:999px; border:1px solid #e5e7eb; font-size:12px; background:#f9fafb; text-align:center;">0</span>
  </button>
  <button class="st-btn" data-status="Closed" style="padding:8px 12px; border:1px solid #e5e7eb; border-radius:10px; background:#fff; cursor:pointer;">
    Closed
    <span class="st-count" id="stClosed" style="display:inline-block; min-width:18px; padding:2px 6px; margin-left:6px; border-radius:999px; border:1px solid #e5e7eb; font-size:12px; background:#f9fafb; text-align:center;">0</span>
  </button>
</div>

      <!-- Ticket list -->
      <div id="userChatList">Loading ticketsâ€¦</div>
    </div>

    <!-- RIGHT: Ticket thread + composer -->
    <div style="width:60%; padding-left:12px;">
      <!-- Ticket header (auto-fills on selection) -->
      <div id="ticketHeader" style="margin-bottom:10px;">
        <em>Select a ticket from the left.</em>
      </div>

      <!-- Messages -->
      <div id="liveChatBox" style="min-height:260px; max-height:50vh; overflow:auto; border:1px solid #e5e7eb; border-radius:8px; padding:10px; background:#fafafa;">
        <!-- bubbles render here -->
      </div>

      <!-- Controls -->
      <div style="display:flex; gap:8px; align-items:flex-start; margin-top:10px;">
        <textarea id="liveChatInput" placeholder="Type your replyâ€¦" rows="3" style="flex:1;"></textarea>
        <div style="display:flex; flex-direction:column; gap:8px;">
          <select id="ticketStatus" title="Ticket status" style="padding:8px 10px;">
            <option>Open</option>
            <option>Answered</option>
            <option>Closed</option>
          </select>
          <button id="saveTicketStatus">Save Status</button>
          <button id="liveChatSendBtn" type="button">Send</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ========== User Reports (type:'user') Tab ========== -->
<div id="userReportsTab" class="tab-content section" style="display:none;">
  <h3 style="margin-bottom:10px;">
    User Reports
    <button class="tab-refresh-btn" type="button" onclick="window.__tabReloaders?.userReportsTab?.()">
      <i class="fa fa-rotate-right"></i> Refresh
    </button>
  </h3>

  <div class="user-reports-toolbar" style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:10px;">
    <button class="ads-tab-btn urt active" data-usr-status="active" type="button">Active</button>
    <button class="ads-tab-btn urt" data-usr-status="resolved" type="button">Resolved</button>
    <span id="userReportsCountBadge"
          style="margin-left:auto;font-size:12px;border:1px solid #e5e7eb;border-radius:999px;padding:4px 8px;background:#fff;">
      0 items
    </span>
  </div>

  <div id="userReportList" data-scroll style="min-height:80px;">Loadingâ€¦</div>
</div>



  <!-- ========== Edit Ad Modal ========== -->
<div id="editModal" class="modal">
  <div class="modal-content">
    <span class="close-btn" onclick="closeEditModal()">&times;</span>
    <h3>Edit Ad</h3>

    <input id="editTitle" placeholder="Title" />
    <input id="editPrice" type="number" placeholder="Price" />
    <input id="editLocation" placeholder="Location" />
    <input id="editCategory" placeholder="Category" />
    <input id="editBrand" placeholder="Brand" />
    <input id="editArea" placeholder="Area" />
    <textarea id="editDescription" placeholder="Description" rows="4"></textarea>

    <!-- Cars/Bikes Fields -->
    <input id="editKmDriven" type="number" placeholder="KM Driven" />
    <input id="editYearOfPurchase" type="number" placeholder="Year of Purchase" />
    <input id="editTyreCondition" placeholder="Tyre Condition" />
    <input id="editAccidentStatus" placeholder="Accident History" />
    <input id="editAllPapersAvailable" placeholder="All Papers Available" />
    <input id="editPollutionExpiry" placeholder="Pollution Expiry" />
    <input id="editTaxExpiry" placeholder="Tax Expiry" />
    <input id="editInsuranceExpiry" placeholder="Insurance Expiry" />
    <input id="editOwnership" placeholder="Ownership" />

    <!-- Properties Fields -->
    <input id="editPropertyType" placeholder="Property Type" />
    <input id="editBhk" placeholder="BHK" />
    <input id="editFurnishing" placeholder="Furnishing" />
    <input id="editPropertyArea" type="number" placeholder="Area (sq. ft.)" />
    <input id="editBedrooms" type="number" placeholder="Bedrooms" />
    <input id="editBathrooms" type="number" placeholder="Bathrooms" />

    <button onclick="saveAdEdits()">Save</button>
    <button onclick="closeEditModal()">Cancel</button>
  </div>
</div>


  <!-- ========== View Chat Messages Modal ========== -->
  <div id="messageModal" class="modal">
    <div class="modal-content">
      <span class="close-btn" onclick="closeMessageModal()">&times;</span>
      <h3>Chat Messages</h3>
      <div id="messageContent"></div>
      <button onclick="closeMessageModal()">Close</button>
    </div>
  </div>




  <!-- ========== View Ad Details Modal ========== -->
  <div id="adDetailsModal" class="modal">
    <div class="modal-content">
      <button onclick="closeAdDetailsModal()">Close X</button>

      <div id="adDetailsContainer">
        <!-- Swipeable image gallery -->
<div id="adImageCarousel" style="position:relative; margin-bottom: 15px;">
  <div id="adImageWrapper" style="display:flex; overflow-x:auto; scroll-snap-type:x mandatory; gap:8px;">
    <!-- Images will be injected dynamically -->
  </div>
  <div id="imageCounter" style="text-align:center; margin-top:8px; font-weight:bold;"></div>
</div>
        <h2 id="adTitle"></h2>
        <hr>
        <p id="adDescription"></p>
        <hr>
        <p><strong>Price:</strong> â‚¹<span id="adPrice"></span></p>
        <p><strong>Category:</strong> <span id="adCategory"></span></p>
        <p><strong>Brand:</strong> <span id="adBrand"></span></p>
        <p><strong>Location:</strong> <span id="adLocation"></span></p>
        <p><strong>Area:</strong> <span id="adArea"></span></p>
        <hr>
        <div id="extraFields"></div>
      </div>
      <button onclick="closeAdDetailsModal()">Close X</button>
    </div>
  </div>


<!-- User Ads Modal for viewing user's uploads -->
<div id="userAdsModal" class="modal" style="display:none;">
  <div class="modal-content">
    <span class="modal-close" onclick="closeUserAdsModal()">&times;</span>
    <h3>User Ads for <span id="modalUserId"></span></h3>
    <div style="margin-bottom: 6px;">Email: <span id="modalUserEmail" style="color:#1a5aad"></span></div>
    <div>Total Ads: <span id="totalAdsCount">0</span></div>
    <hr style="margin:10px 0;">
    <div id="userAdsList">Loadingâ€¦</div>
    <button onclick="closeUserAdsModal()">Close</button>
  </div>
</div>
<!-- Reject Reason Modal -->
<div id="rejectReasonModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.5); z-index:9999;">
  <div style="background:#fff; max-width:360px; margin:100px auto; padding:20px; border-radius:10px;">
    <h3 style="margin-top:0;">Reject Ad</h3>
    <p style="font-size:14px;">Select a reason for rejection:</p>
    <select id="rejectReasonSelect" style="width:100%; padding:8px; border-radius:6px; border:1px solid #ccc;">
  <option value="">-- Select reason --</option>
  <option value="Inappropriate content">Inappropriate content</option>
  <option value="Fake/Scam listing">Fake/Scam listing</option>
  <option value="Duplicate listing">Duplicate listing</option>
  <option value="Wrong category">Wrong category</option>
  <option value="Insufficient details">Insufficient details</option>
  <option value="Contact details missing or incorrect">Contact details missing or incorrect</option>
  <option value="Price seems unrealistic or misleading">Price seems unrealistic or misleading</option>
  <option value="Poor image quality or irrelevant images">Poor image quality or irrelevant images</option>
  <option value="Multiple items in one listing">Multiple items in one listing</option>
  <option value="Offensive or abusive language used">Offensive or abusive language used</option>
  <option value="Violation of posting rules">Violation of posting rules</option>
  <option value="Item not allowed for sale">Item not allowed for sale</option>
  <option value="Location mismatch or unclear">Location mismatch or unclear</option>
  <option value="Repeatedly rejected post">Repeatedly rejected post</option>
  <option value="Other - does not meet guidelines">Other - does not meet guidelines</option>
</select>

    <div style="margin-top:14px; text-align:right;">
      <button onclick="confirmRejectReason()" style="padding:6px 12px;">Reject</button>
      <button onclick="closeRejectModal()" style="padding:6px 12px;">Cancel</button>
    </div>
  </div>
</div>

<!-- Boost Reject Reason Modal -->
<div id="boostRejectReasonModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.5); z-index:9999;">
  <div style="background:#fff; max-width:360px; margin:100px auto; padding:20px; border-radius:10px;">
    <h3 style="margin-top:0;">Reject Boost Request</h3>
    <p style="font-size:14px;">Select a reason for rejection:</p>
    <select id="boostRejectReasonSelect" style="width:100%; padding:8px; border-radius:6px; border:1px solid #ccc;">
      <option value="">-- Select reason --</option>
      <option value="Transaction ID mismatch">Transaction ID mismatch</option>
      <option value="Fake/edited screenshot">Fake/edited screenshot</option>
      <option value="Payment not received">Payment not received</option>
      <option value="Incorrect amount">Incorrect amount</option>
      <option value="Other">Other</option>
    </select>
    <div style="margin-top:14px; text-align:right;">
      <button id="confirmBoostRejectionBtn" onclick="confirmBoostRejection()">Reject</button>
      <button onclick="document.getElementById('boostRejectReasonModal').style.display='none'">Cancel</button>
    </div>
  </div>
</div>


  <script>
    // ===== Firebase Initialization =====
    const firebaseConfig = {
      apiKey: "AIzaSyBknD854PogHpSh12VEVOFobZTG5q1o4_Y",
      authDomain: "olxhub-12479.firebaseapp.com",
      projectId: "olxhub-12479",
      storageBucket: "olxhub-12479.appspot.com",
      messagingSenderId: "470888578176",
      appId: "1:470888578176:web:5f24b2dba3eebd39cefa65",
      measurementId: "G-FDNWXBM2MY"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    const storage = firebase.storage();
window.db      = firebase.firestore();
  window.auth    = firebase.auth();
  window.storage = firebase.storage();
    
    let selectedLiveChatId = null;
    let unsubscribeLiveChat = null;
    let currentEditAdId = null;

// ===== NAVIGATION: Sidebar Tab Switching =====
document.querySelectorAll('.sidebar li').forEach(tab => {
  tab.addEventListener('click', () => {
    // reset active
    document.querySelectorAll('.sidebar li').forEach(t => t.classList.remove('active'));
    tab.classList.add('active');

    // hide all
    document.querySelectorAll('.tab-content').forEach(sec => sec.style.display = 'none');

    // show target
    const target = tab.getAttribute('data-tab');
    document.getElementById(target).style.display = 'block';

    // ==== per-tab extra logic ====
    if (target === 'dashboardTab') {
      renderAdsStatusChart();
    }

    if (target === 'categoryTab') {
      loadCategories();   
    }

    if (target === 'noticesTab') {
      loadNotices();
    }

    if (target === 'amountTab') {
      loadAmountReceived();
    }

    if (target === 'deletedAdsTab') {
      loadDeletedAds();
    }
  });
});



// === DASHBOARD LISTENER SYSTEM ===
let dashboardUnsubs = [];

function renderBoostRequests(docs) {
  // Minimal example - update to real HTML as needed
  const el = document.getElementById('boostRequestsList');
  if (el) el.innerHTML = docs.length ? docs.map(doc => `<div>${doc.id}</div>`).join('') : "No requests.";
}
function renderAllAds(docs) {
  const el = document.getElementById('adsList');
  if (el) el.innerHTML = docs.length ? docs.map(doc => `<div>${doc.id}</div>`).join('') : "No ads.";
}
function renderReports(docs) {
  const el = document.getElementById('reportList');
  if (el) el.innerHTML = docs.length ? docs.map(doc => `<div>${doc.id}</div>`).join('') : "No reports.";
}
function renderUserList(docs) {
  const el = document.getElementById('userList');
  if (el) el.innerHTML = docs.length ? docs.map(doc => `<div>${doc.id}</div>`).join('') : "No users.";
}
function renderPendingAds(docs) {
  const el = document.getElementById('adsReviewList');
  if (el) el.innerHTML = docs.length ? docs.map(doc => `<div>${doc.id}</div>`).join('') : "No pending ads.";
}
function updatePendingBadge(count) {
  const el = document.getElementById('pendingBadge');
  if (el) {
    el.textContent = count;
    el.style.display = count ? 'inline-block' : 'none';
  }
}
function renderAllChats(docs) {
  const el = document.getElementById('chatList');
  if (el) el.innerHTML = docs.length ? docs.map(doc => `<div>${doc.id}</div>`).join('') : "No chats.";
}
function renderAdminUserChatList(adminChats) {
  const el = document.getElementById('userChatList');
  if (el) el.innerHTML = adminChats.length ? adminChats.map(doc => `<div>${doc.id}</div>`).join('') : "No admin-user chats.";
}
function renderAdsStatusChart() {
  const canvas = document.getElementById('adsStatusChart');
  if (!canvas) return;
  // Example: Replace with Chart.js logic as per your need
  const ctx = canvas.getContext('2d');
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.font = "18px Arial";
  ctx.fillText("Chart Live!", 30, 50);
}

// Dummy stubs for any others needed
function renderDeletedAds() {}
function renderNotices() {}

function updateAdsTabCounts(docs) {
  const total = docs.length;
  const pending = docs.filter(doc => doc.data().status === 'pending').length;
  const approved = docs.filter(doc => doc.data().status === 'approved').length;
  const rejected = docs.filter(doc => doc.data().status === 'rejected').length;
  const expired = docs.filter(doc => doc.data().status === 'expired').length;

  document.getElementById('adsCountAll').innerText = total;
  document.getElementById('adsCountPending').innerText = pending;
  document.getElementById('adsCountApproved').innerText = approved;
  document.getElementById('adsCountRejected').innerText = rejected;
  document.getElementById('adsCountExpired').innerText = expired;
}


// LIVE LISTENER
function listenLiveDashboard() {
  dashboardUnsubs.forEach(fn => fn && fn());
  dashboardUnsubs = [];

  // 1) Users
  dashboardUnsubs.push(
  db.collection('users').onSnapshot(userSnap => {
    // ðŸ”’ count only users that actually have an email
    const emailUsers = userSnap.docs.filter(d => {
      const e = (d.data().email || '').trim();
      return e && e.includes('@');
    });

    const el = document.getElementById('totalUsers');
    if (el) el.textContent = emailUsers.length;

    // (optional) agar yahi list render karni ho, to email-only pass karo:
    if (typeof renderUserListTabbed === 'function') {
      renderUserListTabbed(emailUsers, "active");
    } else if (typeof renderUserList === 'function') {
      renderUserList(emailUsers);
    }
  })
);

  // 2) Ads
  db.collection('items')
  .where('status', 'in', ['pending','approved','rejected','expired'])
  .onSnapshot(adsSnap => {
    const el = document.getElementById('totalAds');
    if (el) el.textContent = adsSnap.size;

    renderAllAds(adsSnap.docs);
    renderAdsStatusChart();
    updateAdsTabCounts(adsSnap.docs);
  });

  // 3) Reports
 dashboardUnsubs.push(
  db.collection('reports').onSnapshot(reportSnap => {
    const docs = reportSnap.docs || [];

    const userDocs = docs.filter(d => (String(d.data()?.type || '')).toLowerCase() === 'user');
    const adDocs   = docs.filter(d => (String(d.data()?.type || 'ad')).toLowerCase() !== 'user');

    const adsCountEl  = document.getElementById('totalReports');
    const userCountEl = document.getElementById('totalUserReports');
    if (adsCountEl)  adsCountEl.textContent  = String(adDocs.length);
    if (userCountEl) userCountEl.textContent = String(userDocs.length);

    // ADS list
    const cleanAds = dedupeAds(adDocs);
    const adsListEl = document.getElementById('reportList');
    if (adsListEl) adsListEl.innerHTML = '';
    renderAdsReports(cleanAds);

    // User Reports tab refresh if visible
    const tabEl = document.getElementById('userReportsTab');
    if (tabEl && tabEl.style.display !== 'none' && typeof loadUserReports === 'function') {
      loadUserReports(getActiveUsrTabStatus());
    }
  })
);

  // 4) Pending Ads
  dashboardUnsubs.push(
    db.collection('items').where('status', '==', 'pending').onSnapshot(pendingSnap => {
      const el = document.getElementById('totalPendingAds');
      if (el) el.textContent = pendingSnap.size;
      updatePendingBadge(pendingSnap.size);
      renderPendingAds(pendingSnap.docs);
    })
  );

  
  // 5) Chats  â€”  bring this back
dashboardUnsubs.push(
  db.collection('chats').onSnapshot(async (chatSnap) => {
    // All Chats (User â†” User / Non-Admin)
    if (typeof renderAllChats === 'function') {
      renderAllChats(chatSnap.docs);
    }

    // Admin â†” User new (ticket-like) counter
    const adminChats = chatSnap.docs.filter(doc => {
      const users = doc.data().users || [];
      return users.includes('admin') && users.length === 2;
    });

    let newChatsCount = 0;
    await Promise.all(adminChats.map(async doc => {
      const lastMsgSnap = await db.collection('chats')
        .doc(doc.id).collection('messages')
        .orderBy('timestamp', 'desc').limit(1).get();
      if (!lastMsgSnap.empty) {
        const lastSender = lastMsgSnap.docs[0].data().sender;
        if (lastSender !== 'admin') newChatsCount++;
      }
    }));

    const el = document.getElementById('totalTickitChats');
    if (el) el.textContent = String(newChatsCount);
    if (typeof renderAdminUserChatList === 'function') {
      renderAdminUserChatList(adminChats);
    }
  })
);

 // 6) Tickets (LIVE): count Open tickets with NEW user message
dashboardUnsubs.push(
  db.collection('tickets')
    .where('status', '==', 'Open')
    .onSnapshot({ includeMetadataChanges: true }, async (snap) => {
      // Maintain a live map using docChanges to avoid re-fetching everything
      const jobs = [];
      snap.docChanges().forEach((ch) => {
        const id = ch.doc.id;
        const t  = ch.doc.data() || {};
        if (ch.type === 'removed') {
          delete openTicketNewMap[id];
          return;
        }
        // If ticket doc keeps lastBy, we can use it directly
        if (t.lastBy) {
          openTicketNewMap[id] = (t.lastBy === 'user');
        } else {
          // Fallback: fetch last message just for this changed ticket
          jobs.push(
            ch.doc.ref.collection('messages')
              .orderBy('createdAt', 'desc').limit(1)
              .get({ source: 'server' })
              .then(ms => {
                const last = ms.docs[0]?.data();
                openTicketNewMap[id] = (last?.by === 'user');
              })
              .catch(() => { openTicketNewMap[id] = false; })
          );
        }
      });

      await Promise.all(jobs);

      // Update the dashboard card
      const totalNew = Object.values(openTicketNewMap).filter(Boolean).length;
      const el = document.getElementById('totalTickitChats');
      if (el) el.textContent = String(totalNew);
    })
);


  // 7) Boost Requests
  dashboardUnsubs.push(
    db.collection('boostRequests').where('status', '==', 'pending').onSnapshot(boostSnap => {
      const el = document.getElementById('totalPendingBoost');
      if (el) el.textContent = boostSnap.size;
      renderBoostRequests(boostSnap.docs);
    })
  );

  // 8) Deleted Ads
  dashboardUnsubs.push(
    db.collection('deletedAds').onSnapshot(deletedSnap => {
      const el = document.getElementById('totalDeletedAds');
      if (el) el.textContent = deletedSnap.size;
      renderDeletedAds(deletedSnap.docs);
    })
  );

  // 9) Amount Received (Payments) - for now, still as function; make live for production
  loadAmountReceived && loadAmountReceived();

  // 10) Notices, Slider, etc. can be handled same way when their tab is shown
}

let openTicketNewMap = {};
// Unsubscribe dashboard listeners when switching away
function cleanupDashboardListeners() {
  dashboardUnsubs.forEach(fn => fn && fn());
  dashboardUnsubs = [];
  
}

// Call listenLiveDashboard() when dashboard tab is loaded/shown
// Example:
document.addEventListener('DOMContentLoaded', function() {
  listenLiveDashboard();
  // If using tab system, call it when switching to dashboard tab
});


let allUsersDocs = [];

function renderUserListTabbed(users, filter = "all") {
  const container = document.getElementById('userList');

  // ðŸ”’ Base: sirf email-present users
  const emailUsers = users.filter(u => {
    const e = (u.data().email || '').trim();
    return e && e.includes('@');
  });

  // Status filter apply on top of email-only base
  let filtered = [];
  if (filter === "active") {
    filtered = emailUsers.filter(u => u.data().suspended !== true);
  } else if (filter === "suspended") {
    filtered = emailUsers.filter(u => u.data().suspended === true);
  } else {
    filtered = emailUsers; // "all" = email-only sab
  }

  if (filtered.length === 0) {
    container.innerHTML = "<div style='color:#999;padding:22px 0;'>No users found.</div>";
  } else {
    container.innerHTML = '';
    filtered.forEach(doc => {
      const data = doc.data();
      const userId = doc.id;
      const email = data.email || 'No Email';
      const suspended = data.suspended === true;
      const statusText = suspended
        ? '<span style="color:#d63031;font-weight:bold;">Suspended</span>'
        : '<span style="color:#23ad4a;font-weight:bold;">Active</span>';
      const buttonText = suspended ? 'Reactivate' : 'Suspend';
      const buttonColor = suspended ? '#28a745' : '#dc3545';

      const div = document.createElement('div');
      div.className = 'list-item';
      div.innerHTML = `
        <div>
          <strong>${email}</strong> (ID: ${userId})<br>
          Status: ${statusText}
        </div>
        <div style="display:flex; gap:6px; flex-wrap:wrap;">
          <button class="btn" style="background:${buttonColor}; color:white;"
            onclick="toggleSuspendUser('${userId}', ${suspended})">
            ${buttonText}
          </button>
          <button class="delete-btn btn" onclick="deleteUser('${userId}')">Delete</button>
          <button class="btn" style="background:#2196F3; color:white;" onclick="viewUserDetails('${userId}')">View</button>
        </div>
      `;
      container.appendChild(div);
    });
  }
}

// dropdown options
const RESOLVE_NOTES = [
  "No issue found",
  "Duplicate report",
  "Info corrected",
  "Harmless / not a policy violation",
  "Otherâ€¦"
];
const REJECT_REASONS = [
  "Prohibited item",
  "Fraud / Scam",
  "Wrong / Misleading info",
  "Bad images / Offensive content",
  "Spam / Repeated posting",
  "Otherâ€¦"
];

// one row HTML
function adsReportRowHTML(row){
  const { doc, thumb, who, adId, ownerId, when, reason, status } = row;

  const resolveOpts = RESOLVE_NOTES.map(v => `<option>${escapeHtml(v)}</option>`).join('');
  const rejectOpts  = REJECT_REASONS.map(v => `<option>${escapeHtml(v)}</option>`).join('');

  return `
    <div class="list-item" style="border:1px solid #e5e7eb;border-radius:12px;padding:12px 10px;background:#fff;margin-bottom:10px;">
      <div style="display:flex;gap:12px;align-items:flex-start;">
        <img src="${escapeHtml(thumb)}" alt="" style="width:72px;height:72px;object-fit:cover;border-radius:8px;border:1px solid #eee;${thumb?'':'display:none'}">
        <div style="flex:1;">
          <div style="display:flex;gap:8px;align-items:center;margin-bottom:4px;">
            <span class="badge" style="border:1px solid #e5e7eb;border-radius:999px;padding:2px 8px;font-size:12px;background:#fff;">${status}</span>
            <small style="color:#6b7280">${when}</small>
            <small style="color:#9ca3af;margin-left:auto;">#${doc.id.slice(0,7)}â€¦</small>
          </div>

          <div><b>Reported By:</b> <code>${escapeHtml(who)}</code></div>
          <div><b>Ad ID:</b> <code>${escapeHtml(adId)}</code>${ownerId ? ` &nbsp;â€¢&nbsp; <b>Owner:</b> <code>${escapeHtml(ownerId)}</code>` : ''}</div>
          <div style="margin-top:6px;"><b>Reason:</b> ${escapeHtml(reason)}</div>

          <div class="ad-actions" style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;">
            <button class="btn btn-view" data-itemid="${escapeHtml(adId)}">View Ad</button>

            <div class="resolve-group" style="display:flex;gap:6px;align-items:center;">
              <select class="sel-resolve" data-docid="${doc.id}" data-itemid="${escapeHtml(adId)}"
                      style="padding:6px 8px;border:1px solid #e5e7eb;border-radius:8px;">
                <option value="">No issue â€” select noteâ€¦</option>
                ${resolveOpts}
              </select>
              <input class="txt-resolve" data-docid="${doc.id}" data-itemid="${escapeHtml(adId)}"
                     placeholder="Note (if â€˜Otherâ€¦â€™)" style="display:none;padding:6px 8px;border:1px solid #e5e7eb;border-radius:8px;min-width:220px;">
              <button class="btn btn-noissue" data-docid="${doc.id}" data-itemid="${escapeHtml(adId)}">Resolve</button>
            </div>

            <div class="reject-group" style="display:flex;gap:6px;align-items:center;">
              <select class="sel-reject" data-docid="${doc.id}" data-itemid="${escapeHtml(adId)}"
                      style="padding:6px 8px;border:1px solid #e5e7eb;border-radius:8px;">
                <option value="">Reject â€” select reasonâ€¦</option>
                ${rejectOpts}
              </select>
              <input class="txt-reject" data-docid="${doc.id}" data-itemid="${escapeHtml(adId)}"
                     placeholder="Note (if â€˜Otherâ€¦â€™)" style="display:none;padding:6px 8px;border:1px solid #e5e7eb;border-radius:8px;min-width:220px;">
              <button class="btn danger btn-reject" data-docid="${doc.id}" data-itemid="${escapeHtml(adId)}">Reject Ad</button>
            </div>

            <button class="btn btn-delreport" data-docid="${doc.id}">Delete Report</button>
          </div>
        </div>
      </div>
    </div>`;
}

// full list render (fetch thumbs)
async function renderAdsReports(adDocs){
  const wrap = document.getElementById('reportList'); // ads reports container
  if (!wrap) return;
  if (!adDocs || adDocs.length === 0){
    wrap.innerHTML = '<p style="color:#6b7280">No ad reports.</p>';
    return;
  }
  const rows = await Promise.all(adDocs.map(async (d)=>{
    const r = d.data() || {};
    const { adId, ownerId } = getAdTarget(r);
    const who = getReporterId(r);
    const when = r.timestamp ? fmtTs(r.timestamp) : fmtTs(r.createdAt);
    const reason = Array.isArray(r.reasons) ? r.reasons.join(', ') : (r.reason || 'â€”');
    const status = (r.status || 'pending').toString().toUpperCase();
    const thumb = await getAdThumb(adId);
    return { doc:d, thumb, who, adId, ownerId, when, reason, status };
  }));
  wrap.innerHTML = rows.map(adsReportRowHTML).join('');
}

// persistent delegated handlers for Ads actions
(function wireAdsActions(){
  if (window.__adsActionsWired) return; window.__adsActionsWired = true;

  document.addEventListener('change', (e)=>{
    // toggle "Other" note inputs
    const selRes = e.target.closest('#reportList select.sel-resolve');
    if (selRes){
      const docId = selRes.getAttribute('data-docid');
      const inp = document.querySelector(`#reportList .txt-resolve[data-docid="${docId}"]`);
      if (inp) inp.style.display = (selRes.value.includes('Other')) ? 'inline-block' : 'none';
    }
    const selRej = e.target.closest('#reportList select.sel-reject');
    if (selRej){
      const docId = selRej.getAttribute('data-docid');
      const inp = document.querySelector(`#reportList .txt-reject[data-docid="${docId}"]`);
      if (inp) inp.style.display = (selRej.value.includes('Other')) ? 'inline-block' : 'none';
    }
  });

  document.addEventListener('click', async (e)=>{
    const btn = e.target.closest('#reportList .ad-actions button');
    if (!btn) return;

    const itemId = btn.getAttribute('data-itemid');
    const docId  = btn.getAttribute('data-docid');

    try{
      if (btn.classList.contains('btn-view')) {
        if (window.viewAdDetails) return viewAdDetails(itemId);
        alert(`Open ad: ${itemId}`);
      }

      if (btn.classList.contains('btn-noissue')) {
        // read dropdown/note
        const sel = document.querySelector(`#reportList .sel-resolve[data-docid="${docId}"]`);
        const noteInput = document.querySelector(`#reportList .txt-resolve[data-docid="${docId}"]`);
        let details = (sel?.value || '').trim();
        if (!details) return alert('Select a resolution note.');
        if (details.includes('Other')) details = (noteInput?.value || '').trim();
        await resolveAdReport(docId, itemId, details);
        alert('Resolved (no issue). Sent to History.');
      }

      if (btn.classList.contains('btn-reject')) {
        const sel = document.querySelector(`#reportList .sel-reject[data-docid="${docId}"]`);
        const noteInput = document.querySelector(`#reportList .txt-reject[data-docid="${docId}"]`);
        let reason = (sel?.value || '').trim();
        if (!reason) return alert('Select a reject reason.');
        if (reason.includes('Other')) reason = (noteInput?.value || '').trim() || 'Other';
        await rejectAdFromReport(docId, itemId, reason);
        alert('Ad rejected. Logged to History.');
      }

      if (btn.classList.contains('btn-delreport')) {
        if (!confirm('Delete this report?')) return;
        await db.collection('reports').doc(docId).delete();
        alert('Report deleted.');
      }
    }catch(err){ console.error(err); alert('Action failed.'); }
  });
})();

(function(){
  if (window.__userReportsPackLoaded) return;
  window.__userReportsPackLoaded = true;

  function ensureUserReportsDom() {
    const tab = document.getElementById('userReportsTab');
    if (!tab) return {tab:null,list:null,badge:null};
    let list  = document.getElementById('userReportList');
    if (!list) { list = document.createElement('div'); list.id='userReportList'; list.setAttribute('data-scroll',''); list.style.minHeight='80px'; tab.appendChild(list); }
    let badge = document.getElementById('userReportsCountBadge');
    if (!badge) { badge = document.createElement('span'); badge.id='userReportsCountBadge'; badge.textContent='0 items'; (tab.querySelector('.user-reports-toolbar')||tab).appendChild(badge); }
    return { tab, list, badge };
  }

  function getActiveUsrTabStatus(){
    const btn = document.querySelector('#userReportsTab .ads-tab-btn.urt.active');
    return btn?.getAttribute('data-usr-status') || 'active';
  }
  window.getActiveUsrTabStatus = getActiveUsrTabStatus;

  async function loadUserReports(status = 'active') {
    const { list, badge } = ensureUserReportsDom();
    if (!list) return;
    list.innerHTML = 'Loadingâ€¦';

    if (!window.db) { list.innerHTML = 'Waiting for databaseâ€¦'; return; }

    const snap = await db.collection('reports').orderBy('createdAt','desc').limit(300).get();
    const userDocs = snap.docs.filter(d => (String(d.data()?.type || '')).toLowerCase() === 'user');

    const RESOLVED_SET = new Set(['resolved','closed','done']);
    const filtered = userDocs.filter(d => {
      const st = String(d.data()?.status || 'pending').toLowerCase().trim();
      return (status === 'resolved') ? RESOLVED_SET.has(st) : !RESOLVED_SET.has(st);
    });

    renderUserReports(filtered, status);
    if (badge) badge.textContent = `${filtered.length} items`;
  }
  window.loadUserReports = loadUserReports;

  function renderUserReports(docs, status = 'active') {
    const box = document.getElementById('userReportList');
    if (!box) return;

    if (!docs || docs.length === 0) {
      box.innerHTML = status === 'resolved'
        ? '<p style="color:#6b7280">No resolved user reports found.</p>'
        : '<p style="color:#6b7280">No active user reports.</p>';
      return;
    }

    const rows = [];
    docs.forEach(d => {
      const r = d.data() || {};
      const rid = d.id;

      const who   = r.reporterUserId || r.userId || r.reporter || r.createdBy || 'unknown';
      const whom  = r.reportedUserId || r.targetUserId || 'â€”';
      const when  = fmtTs(r.createdAt);
      const reasons = Array.isArray(r.reasons) ? r.reasons.join(', ') : (r.reason || 'â€”');

      const resolvedBlock = `
        <div style="margin-top:6px;"><b>Details:</b> ${escapeHtml((r.details??'').toString()) || 'â€”'}</div>
        <div style="margin-top:4px;color:#6b7280">
          <b>Resolved At:</b> ${fmtTs(r.resolvedAt)}
          ${r.resolvedBy ? ` â€¢ <b>By:</b> <code>${escapeHtml(r.resolvedBy)}</code>` : ''}
        </div>`;

      const actionBlock = (status === 'active')
        ? `<div class="resolve-ui" style="display:flex;gap:6px;flex-wrap:wrap;align-items:center;margin-top:6px;">
             <select class="resolve-note" data-rid="${rid}" style="padding:6px 8px;border:1px solid #e5e7eb;border-radius:8px;">
               <option value="">Select resolution noteâ€¦</option>
               <option>Warning issued</option>
               <option>Issue clarified with reporter</option>
               <option>User verified â€” no action</option>
               <option>Account action taken</option>
               <option>Duplicate/Invalid report</option>
               <option value="__OTHER__">Otherâ€¦</option>
             </select>
             <textarea class="resolve-other" data-rid="${rid}" placeholder="Add note (if â€˜Otherâ€™)"
                       style="display:none;min-width:220px;min-height:34px;padding:6px 8px;border:1px solid #e5e7eb;border-radius:8px;"></textarea>
             <button class="btn act-resolve" data-rid="${rid}" style="background:#2563eb;color:#fff">Resolve</button>
             <button class="btn danger act-delete" data-rid="${rid}">Delete</button>
           </div>`
        : `<div style="display:flex;gap:6px;flex-wrap:wrap;margin-top:6px;">
             <button class="btn act-reopen" data-rid="${rid}">Reopen</button>
             <button class="btn danger act-delete" data-rid="${rid}">Delete</button>
           </div>`;

      rows.push(`
        <div class="list-item usrRpt" style="border:1px solid #e5e7eb;border-radius:12px;padding:10px;background:#fff;margin-bottom:8px;">
          <div style="display:flex;gap:8px;align-items:center;margin-bottom:4px;">
            <span class="badge" style="border:1px solid #e5e7eb;border-radius:999px;padding:2px 8px;font-size:12px;background:#fff;">
              ${status === 'resolved' ? 'Resolved' : 'Pending'}
            </span>
            <small style="color:#6b7280">${when}</small>
            <small style="color:#9ca3af;margin-left:auto;">#${rid.slice(0,7)}â€¦</small>
          </div>

          <div><b>Reported By â†’ User:</b>
            <code>${escapeHtml(who)}</code> â†’ <code>${escapeHtml(whom)}</code>
          </div>
          <div style="margin-top:4px;"><b>Reason(s):</b> ${escapeHtml(reasons)}</div>

          ${status === 'resolved' ? resolvedBlock : ''}

          <div style="display:flex;gap:6px;flex-wrap:wrap;margin-top:6px;">
            <button class="btn act-view-user" data-whom="${escapeHtml(whom)}">View User</button>
          </div>
          ${actionBlock}
        </div>
      `);
    });

    box.innerHTML = rows.join('');

    // Toggle textarea when "Otherâ€¦" selected
    box.querySelectorAll('select.resolve-note').forEach(sel=>{
      sel.addEventListener('change', ()=>{
        const rid = sel.getAttribute('data-rid');
        const ta = box.querySelector(`textarea.resolve-other[data-rid="${rid}"]`);
        if (!ta) return;
        ta.style.display = (sel.value === '__OTHER__') ? 'block' : 'none';
      });
    });

    // Delegated actions
    box.addEventListener('click', async (e) => {
      const t = e.target.closest('button');
      if (!t) return;

      if (t.classList.contains('act-view-user')) {
        const uid = t.getAttribute('data-whom');
        if (window.viewUserDetails) viewUserDetails(uid);
        return;
      }

      const rid = t.getAttribute('data-rid');
      if (!rid) return;

      if (t.classList.contains('act-resolve')) {
        const sel = box.querySelector(`select.resolve-note[data-rid="${rid}"]`);
        const ta  = box.querySelector(`textarea.resolve-other[data-rid="${rid}"]`);
        let details = sel?.value || '';
        if (details === '__OTHER__') details = (ta?.value || '').trim();
        if (!details) { alert('Please select/add a resolution note.'); return; }
        await markUserReportResolved(rid, details);
        return;
      }
      if (t.classList.contains('act-reopen'))  return reopenUserReport(rid);
      if (t.classList.contains('act-delete'))  return deleteUserReport(rid);
    }, { once: true });
  }
  window.renderUserReports = renderUserReports;

  // Actions
  async function markUserReportResolved(reportId, details){
    try{
      const resolvedBy = (window.auth && auth.currentUser && (auth.currentUser.uid || auth.currentUser.email)) || 'admin';
      await db.collection('reports').doc(reportId).set({
        status: 'resolved',
        details: (details || '').toString(),
        resolvedAt: firebase.firestore.FieldValue.serverTimestamp(),
        resolvedBy
      }, { merge:true });
      loadUserReports(getActiveUsrTabStatus());
      alert('Marked resolved.');
    }catch(e){ console.error(e); alert('Failed.'); }
  }
  window.markUserReportResolved = markUserReportResolved;

  async function reopenUserReport(reportId){
    if(!confirm('Move this report back to Active (pending)?')) return;
    try{
      await db.collection('reports').doc(reportId).set({ status:'pending' }, { merge:true });
      loadUserReports(getActiveUsrTabStatus());
    }catch(e){ console.error(e); alert('Failed.'); }
  }
  window.reopenUserReport = reopenUserReport;

  async function deleteUserReport(reportId){
    if(!confirm('Delete this report permanently?')) return;
    try{
      await db.collection('reports').doc(reportId).delete();
      loadUserReports(getActiveUsrTabStatus());
    }catch(e){ console.error(e); alert('Failed.'); }
  }
  window.deleteUserReport = deleteUserReport;

  // Inner-tab wiring (Active/Resolved)
  if (!window.__userReportsInnerTabsWired){
    document.addEventListener('click', (e)=>{
      const btn = e.target.closest('#userReportsTab .ads-tab-btn.urt');
      if(!btn) return;
      const all = document.querySelectorAll('#userReportsTab .ads-tab-btn.urt');
      all.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      const st = btn.getAttribute('data-usr-status') || 'active';
      loadUserReports(st);
    });
    window.__userReportsInnerTabsWired = true;
  }

  // for refresh button
  window.__tabReloaders = Object.assign(window.__tabReloaders||{}, {
    userReportsTab: () => loadUserReports(getActiveUsrTabStatus())
  });
})();

const __adThumbCache = Object.create(null);

function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function fmtTs(ts){
  try{
    if (!ts) return 'â€”';
    if (ts.seconds) return new Date(ts.seconds*1000).toLocaleString();
    if (typeof ts === 'number') return new Date(ts).toLocaleString();
    return new Date(ts).toLocaleString();
  }catch{ return 'â€”'; }
}
function getReporterId(r){
  return (
    r.reporterUserId || r.userId || r.reporterUid || r.reporter_id ||
    (r.reporter && (r.reporter.uid || r.reporter.id)) ||
    r.createdBy || r.created_by || r.createdUid || r.submittedBy ||
    r.senderId || r.by || r.uid || r.owner || 'unknown'
  );
}
function getAdTarget(r){
  const adId    = r.itemId || r.adId || r.targetAdId || 'â€”';
  const ownerId = r.ownerUserId || r.targetUserId || r.sellerId || '';
  return { adId, ownerId };
}
async function getAdThumb(itemId){
  if (!itemId) return '';
  if (__adThumbCache[itemId] !== undefined) return __adThumbCache[itemId];
  try{
    const snap = await db.collection('items').doc(itemId).get();
    const it = snap.data() || {};
    const url =
      it.thumbnail || it.thumb || it.image || it.photo ||
      (Array.isArray(it.images) && it.images[0]) ||
      (Array.isArray(it.photos) && it.photos[0]) ||
      (Array.isArray(it.media)  && it.media[0])  || '';
    __adThumbCache[itemId] = url || '';
    return __adThumbCache[itemId];
  }catch{
    __adThumbCache[itemId] = '';
    return '';
  }
}
// smarter de-dupe for Ads (reporter + item + reason)
function dedupeAds(docs){
  const seen = new Set(), out=[];
  for (const d of docs){
    const r = d.data() || {};
    const key = [ (r.reporterUserId||r.userId||'x'), (r.itemId||r.adId||'y'), (r.reason||'z') ].join('|');
    if (seen.has(key)) continue;
    seen.add(key); out.push(d);
  }
  return out;
}

// Tab count update
function updateUserTabCounts(users) {
  // ðŸ”’ sirf email-present users ko count karo
  const emailUsers = users.filter(u => {
    const e = (u.data().email || '').trim();
    return e && e.includes('@');
  });

  const allCount = emailUsers.length;
  const activeCount = emailUsers.filter(u => u.data().suspended !== true).length;
  const suspendedCount = emailUsers.filter(u => u.data().suspended === true).length;

  document.getElementById('activeUsersCount').innerText = activeCount;
  document.getElementById('suspendedUsersCount').innerText = suspendedCount;
  document.getElementById('allUsersCount').innerText = allCount;
}


// Live Firestore listener for users
db.collection('users').onSnapshot(userSnap => {
  allUsersDocs = userSnap.docs;
  updateUserTabCounts(allUsersDocs);
  // Default tab: Active
  renderUserListTabbed(allUsersDocs, "active");
});

// Tab click event
document.querySelectorAll('.users-tab-btn').forEach(btn => {
  btn.addEventListener('click', function() {
    document.querySelectorAll('.users-tab-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    const status = btn.getAttribute('data-status');
    renderUserListTabbed(allUsersDocs, status);
  });
});



async function loadAmountReceived() {
  // Get success + rejected payments (gateway)
  const successSnap = await db.collection('payments').where('status', '==', 'success').get();
  const rejectedSnap = await db.collection('payments').where('status', '==', 'rejected').get();

  // Filter BOOST from gateway payments
  const approvedDocs = successSnap.docs.filter(doc => !doc.data().paymentId?.startsWith("BOOST-"));
  window.lastApprovedPayments = [];
 window.lastRejectedPayments = [];
  const rejectedDocs = rejectedSnap.docs;

  // Get approved boostRequests
  const boostSnap = await db.collection('boostRequests').where('status', '==', 'approved').get();
  boostSnap.forEach(doc => {
    const d = doc.data();
    approvedDocs.push({
      data: () => ({
        timestamp: d.timestamp,
        userId: d.userId,
        adId: d.adId,
        amount: d.amount || 0,
        plan: d.plan || 'Boost',
        paymentId: d.paymentId || 'Boost-Auto',
        status: 'success',
        screenshot: d.screenshot || '',
        rejectedAt: null,
        rejectReason: null
      })
    });
  });

  // Get rejected boostRequests
  const rejectedBoostSnap = await db.collection('boostRequests').where('status', '==', 'rejected').get();
  rejectedBoostSnap.forEach(doc => {
    const d = doc.data();
    rejectedDocs.push({
      data: () => ({
        timestamp: d.timestamp,
        userId: d.userId,
        adId: d.adId,
        amount: d.amount || 0,
        plan: d.plan || 'Boost',
        paymentId: d.paymentId || 'Boost-Auto',
        status: 'rejected',
        screenshot: d.screenshot || '',
        rejectedAt: d.rejectedAt || null,
        rejectReason: d.rejectReason || '-'  
      })
    });
  });

  // === Helper to render table ===
  function renderTable(docs) {
    if (docs.length === 0) return '<p>No payments found.</p>';

    let rows = docs.map(doc => {
      const d = doc.data();
      const dt = d.timestamp?.toDate()?.toLocaleString() || '';
      const rejectedAt = d.rejectedAt?.toDate?.()?.toLocaleString?.() || '-';
      const reason = d.rejectReason || '-';

      return `<tr>
        <td style="padding:6px;border:1px solid #eee;">${dt}</td>
        <td style="padding:6px;border:1px solid #eee;">${d.userId || '-'}</td>
        <td style="padding:6px;border:1px solid #eee;">${d.adId || '-'}</td>
        <td style="padding:6px;border:1px solid #eee;">â‚¹${Number(d.amount).toLocaleString('en-IN')}</td>
        <td style="padding:6px;border:1px solid #eee;">${d.plan || '-'}</td>
        <td style="padding:6px;border:1px solid #eee;">
          ${d.paymentId 
            ? `<span style="cursor:pointer;color:#007bff;" onclick="navigator.clipboard.writeText('${d.paymentId}'); alert('Payment ID copied!')">${d.paymentId}</span>` 
            : '<em style="color:#999;">Not provided</em>'}
        </td>
        <td style="padding:6px;border:1px solid #eee;">${d.status || '-'}</td>
        <td style="padding:6px;border:1px solid #eee;">
          ${d.paymentMethod 
        ? d.paymentMethod 
        : '<em style="color:#999;">Unknown</em>'}
        </td>
        <td style="padding:6px;border:1px solid #eee;">${rejectedAt}</td>
        <td style="padding:6px;border:1px solid #eee;">${reason}</td>
      </tr>`;
    }).join('');

    return `<table style="width:100%;border-collapse:collapse;">
      <tr style="background:#f4f4f4;">
        <th style="padding:8px;border:1px solid #ccc;">Date</th>
        <th style="padding:8px;border:1px solid #ccc;">User ID</th>
        <th style="padding:8px;border:1px solid #ccc;">Ad ID</th>
        <th style="padding:8px;border:1px solid #ccc;">Amount (â‚¹)</th>
        <th style="padding:8px;border:1px solid #ccc;">Plan</th>
        <th style="padding:8px;border:1px solid #ccc;">Transaction ID</th>
        <th style="padding:8px;border:1px solid #ccc;">Status</th>
        <th style="padding:8px;border:1px solid #ccc;">Payment Method</th>
        <th style="padding:8px;border:1px solid #ccc;">Rejected At</th>
        <th style="padding:8px;border:1px solid #ccc;">Reject Reason</th>
      </tr>
      ${rows}
    </table>`;
  }

  // === Total amount received (approved only) ===
  const total = approvedDocs.reduce((sum, doc) => sum + (Number(doc.data().amount) || 0), 0);
  const dash = document.getElementById('totalAmountReceivedDashboard');
  if (dash) dash.innerText = 'â‚¹' + total.toLocaleString('en-IN');
  const amtTab = document.getElementById('totalAmountReceivedAmountTab');
  if (amtTab) amtTab.innerText = 'â‚¹' + total.toLocaleString('en-IN');

  // === Show in tabs ===
  document.getElementById('approvedPaymentsList').innerHTML = renderTable(approvedDocs);
  document.getElementById('rejectedPaymentsList').innerHTML = renderTable(rejectedDocs);
 window.lastApprovedPayments = approvedDocs.filter(d => d && typeof d.data === 'function');
window.lastRejectedPayments = rejectedDocs.filter(d => d && typeof d.data === 'function');

}



    // ===== RENDER ADSâ€STATUS DISTRIBUTION CHART =====
    async function renderAdsStatusChart() {
      const approvedSnap = await db.collection('items').where('status', '==', 'approved').get();
      const pendingSnap  = await db.collection('items').where('status', '==', 'pending').get();
      const rejectedSnap = await db.collection('items').where('status', '==', 'rejected').get();

      const approvedCount = approvedSnap.size;
      const pendingCount  = pendingSnap.size;
      const rejectedCount = rejectedSnap.size;

      // If chart instance already exists, destroy it first (to avoid duplicates)
      if (window.adsStatusChartInstance) {
        window.adsStatusChartInstance.destroy();
      }

      const el = document.getElementById('adsStatusChart');
if (!el) return;
const ctx = el.getContext('2d');

      window.adsStatusChartInstance = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: ['Approved', 'Pending', 'Rejected'],
          datasets: [{
            data: [approvedCount, pendingCount, rejectedCount],
            backgroundColor: [
              'rgba(40, 167, 69, 0.7)',   // green for approved
              'rgba(255, 193, 7, 0.7)',   // yellow for pending
              'rgba(220, 53, 69, 0.7)'    // red for rejected
            ],
            borderColor: [
              'rgba(40, 167, 69, 1)',
              'rgba(255, 193, 7, 1)',
              'rgba(220, 53, 69, 1)'
            ],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'bottom',
            },
            title: {
              display: false
            }
          }
        }
      });
    }

    // ===== RENDER ADMINâ†”USER Chat List (only those Admin hasn't replied) =====
    function renderAdminUserChatList(adminChatDocs) {
      const userChatContainer = document.getElementById('userChatList');
      userChatContainer.innerHTML = '';
      let any = false;

      adminChatDocs.forEach(async doc => {
        const chat = doc.data();
        const chatId = doc.id;
        const userId = (chat.users || []).find(u => u !== 'admin');

        // Fetch the last message to check if admin has replied
        const lastMsgSnap = await db.collection('chats')
          .doc(chatId)
          .collection('messages')
          .orderBy('timestamp', 'desc')
          .limit(1)
          .get();

        let showChat = false;
        let lastPreview = 'No messages yet';
        if (!lastMsgSnap.empty) {
          const lastMsgData = lastMsgSnap.docs[0].data();
          lastPreview = lastMsgData.text || '';
          if (lastMsgData.sender !== 'admin') {
            showChat = true;
          }
        }

        if (showChat) {
          any = true;
          // Create the list item DOM
          const div = document.createElement('div');
          div.className = 'list-item';
          div.style.cursor = 'pointer';
          div.setAttribute('data-chat-id', chatId);
          div.setAttribute('data-user-id', userId);

          // Insert User ID, NEW badge, last message preview
          div.innerHTML = `
            <div>
              <strong>UserID: <code>${userId}</code></strong>
              <span class="new-badge" style="display:inline-block;">NEW</span>
              <br>
              <small>Last Message:â€œ${lastPreview.substring(0, 30)}â€¦â€</small>
            </div>
          `;

          // Click handler to open chat
          div.onclick = () => openLiveChat(chatId, userId);
          userChatContainer.appendChild(div);
        }
      });

     if (!any) {
  userChatContainer.innerHTML = '<p style="margin-top:34px;margin-bottom:34px;font-size:17px;color:#a0a0a0;">No new admin-user chats (awaiting reply).</p>';
}

    }

    // ===== OPEN LIVE CHAT (when a chat is selected) =====
    function openLiveChat(chatId, userId) {
      selectedLiveChatId = chatId;
      const chatBox = document.getElementById('liveChatBox');
      chatBox.innerHTML = `<em>Loading messages with ${userId}...</em>`;

      // Unsubscribe previous listener if any
      if (unsubscribeLiveChat) unsubscribeLiveChat();

      unsubscribeLiveChat = db.collection('chats')
        .doc(chatId)
        .collection('messages')
        .orderBy('timestamp')
        .onSnapshot(snapshot => {
          chatBox.innerHTML = '';
          snapshot.forEach(doc => {
            const msg = doc.data();
            const isAdmin = msg.sender === 'admin';
            const msgClass = isAdmin ? 'admin-message' : 'user-message';
            const time = msg.timestamp?.toDate()?.toLocaleTimeString() || '';

            const bubble = document.createElement('div');
            bubble.className = `chat-bubble ${msgClass}`;
            bubble.innerHTML = `<div>${msg.text}</div><div class="message-time">${time}</div>`;
            chatBox.appendChild(bubble);
          });
          chatBox.scrollTop = chatBox.scrollHeight;

          // Once admin opens this chat, hide its NEW badge
          const chatDiv = document.querySelector(`.list-item[data-chat-id="${chatId}"]`);
          if (chatDiv) {
            const badgeSpan = chatDiv.querySelector('.new-badge');
            if (badgeSpan) badgeSpan.style.display = 'none';
          }
        });
    }

    // ===== SEND LIVE ADMIN REPLY =====
    function sendLiveAdminReply() {
      const textInput = document.getElementById('liveChatInput');
      const text = textInput.value.trim();
      if (!text || !selectedLiveChatId) return;

      // Add new admin message
      db.collection('chats')
        .doc(selectedLiveChatId)
        .collection('messages')
        .add({
          sender: 'admin',
          text: text,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        })
        .then(() => {
          // Update lastMessage in chat doc
          return db.collection('chats')
            .doc(selectedLiveChatId)
            .update({
              lastMessage: text,
              timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
        })
        .then(() => {
          // Clear input after sending
          textInput.value = '';
          // Remove NEW badge for this chat
          const chatDiv = document.querySelector(`.list-item[data-chat-id="${selectedLiveChatId}"]`);
          if (chatDiv) {
            const badgeSpan = chatDiv.querySelector('.new-badge');
            if (badgeSpan) badgeSpan.style.display = 'none';
          }
        })
        .catch(err => {
          console.error('Error sending admin message:', err);
        });
    }

    // ===== RENDER USER MANAGEMENT LIST =====
      function renderUserList(users) {
  const container = document.getElementById('userList');
  container.innerHTML = '';

  // ðŸ”’ Show only users that actually have an email
  users = users.filter(doc => {
    const e = (doc.data().email || '').trim();
    return e && e.includes('@');
  });

  if (users.length === 0) {
    container.innerHTML = '<p>No users found.</p>';
    return;
  }

  users.forEach(doc => {
    const data = doc.data();
    const userId = doc.id;
    const email = data.email || 'No Email';
    const suspended = data.suspended === true;
    const statusText = suspended
      ? '<span style="color:#d63031;font-weight:bold;">Suspended</span>'
      : '<span style="color:#23ad4a;font-weight:bold;">Active</span>';

    const buttonText = suspended ? 'Reactivate' : 'Suspend';
    const buttonColor = suspended ? '#28a745' : '#dc3545';

    const div = document.createElement('div');
    div.className = 'list-item';
    div.innerHTML = `
      <div>
        <strong>${email}</strong> (ID: ${userId})<br>
        Status: <strong>${statusText}</strong>
      </div>
      <div style="display:flex; gap:6px; flex-wrap:wrap;">
        <button class="btn" style="background:${buttonColor}; color:white;"
          onclick="toggleSuspendUser('${userId}', ${suspended})">
          ${buttonText}
        </button>
        <button class="delete-btn btn" onclick="deleteUser('${userId}')">Delete</button>
        <button class="btn" style="background:#2196F3; color:white;" onclick="viewUserDetails('${userId}')">View</button>
      </div>
    `;
    container.appendChild(div);
  });
}

// ===== DELETE USER =====
function deleteUser(userId) {
  if (!confirm('Are you sure you want to delete this user permanently?')) return;
  db.collection('users').doc(userId).delete()
    .then(() => {
      alert('User deleted successfully.');
    })
    .catch(err => {
      console.error('Error deleting user:', err);
      alert('Failed to delete user.');
    });
}

    // ===== TOGGLE SUSPEND / REACTIVATE USER =====
    function toggleSuspendUser(userId, currentlySuspended) {
  db.collection('users').doc(userId).update({
    suspended: !currentlySuspended
  }).then(() => {
    alert(`User has been ${!currentlySuspended ? 'suspended' : 'reactivated'}.`);
  }).catch(err => {
    console.error('Error toggling suspension:', err);
    alert('Failed to update user status.');
  });
}

// Paid/Free
function isPaidAd(d){ return Number(d?.postFee?.amount || 0) > 0; }
function feeBadge(d){
  return isPaidAd(d)
    ? `<span class="fee-badge paid">Paid Ads</span>`
    : `<span class="fee-badge free">Free Ads</span>`;
}
// Dealer categories + sellerType check
function needsDealerBlock(d){
  const cat = (d?.category||'').toLowerCase();
  const isDealer = (d?.sellerType||'').toLowerCase()==='dealer';
  const catOk = ['cars','car','bikes','bike','properties','property'].some(x=>cat.includes(x));
  return isDealer && catOk;
}
// First proof link
function dealerProofLink(d){
  const arr = Array.isArray(d?.dealerDocs) ? d.dealerDocs : [];
  return arr.length ? `<a class="dealer-proof" href="${arr[0]}" target="_blank" rel="noopener">Proof: sample.pdf/jpg/png</a>` : '';
}

// Click handlers for OK / X (delegated)
document.addEventListener('click', async (e)=>{
  const okBtn = e.target.closest('[data-action="dealer-ok"]');
  const noBtn = e.target.closest('[data-action="dealer-no"]');
  const btn = okBtn || noBtn;
  if(!btn) return;
  const id = btn.getAttribute('data-id');
  const approved = !!okBtn;
  try{
    await db.collection('items').doc(id).set({ dealerVerified: approved }, { merge:true });
    alert(approved ? 'âœ… Dealer approved' : 'âŒ Dealer not verified');
  }catch(err){
    console.error(err);
    alert('Update failed');
  }
});

    // ===== RENDER ALL ADS =====
let allAdDocsCache = []; // Keep all docs for filter switching

function renderAllAds(adDocs, filterStatus = "all") {
  // cache all for later switching
  if (!filterStatus || filterStatus === "all") allAdDocsCache = adDocs;

  const adsContainer = document.getElementById('adsList');
  adsContainer.innerHTML = '';

  // Filter logic
  let filtered = adDocs;
  if (filterStatus && filterStatus !== "all") {
    filtered = adDocs.filter(doc => (doc.data().status || '') === filterStatus);
  }

  // Show message if none
  if (filtered.length === 0) {
    adsContainer.innerHTML = '<div style="padding:24px;font-size:17px;color:#a0a0b6;">No ads found for this status.</div>';
    return;
  }

  // ---- RENDER ROWS ----
  filtered.forEach(doc => {
    const data   = doc.data();
    const adId   = doc.id;
    const userId = data.userId || 'Unknown';
    const status = (data.status || 'pending').toLowerCase();
    const thumb  = (Array.isArray(data.images) && data.images[0]) ? data.images[0]
                   : (data.thumbnailUrl || 'https://via.placeholder.com/54x54?text=No+Img');

    const statusClass = {
      approved: 'status-approved',
      pending:  'status-pending',
      rejected: 'status-rejected',
      expired:  'status-expired'
    }[status] || '';

    const statusHTML = `<span class="status-label ${statusClass}">
        ${status.charAt(0).toUpperCase() + status.slice(1)}
      </span>`;

    // Action buttons (keep your logic)
    let buttonsHTML = `
      <button class="btn-view" onclick="viewAdDetails('${adId}')">View</button>
      <button class="btn-edit" onclick="editAd('${adId}')">Edit</button>
      <button class="btn-delete" onclick="deleteAd('${adId}')">Delete</button>
    `;
    if (status === 'pending') {
      buttonsHTML += `
        <button class="btn-approve" onclick="approveAd('${adId}')">Approve</button>
        <button class="btn-reject" onclick="rejectAd('${adId}')">Reject</button>
      `;
    } else if (status === 'approved') {
      buttonsHTML += `<button class="btn-reject" onclick="rejectAd('${adId}')">Reject</button>`;
    } else if (status === 'rejected') {
      buttonsHTML += `<button class="btn-approve" onclick="approveAd('${adId}')">Approve</button>`;
    }

    // ==== Paid/Free + Dealer UI ====
    const feeHtml = feeBadge(data);

    // ==== Dealer UI ====
// ==== Dealer UI ====
let dealerHtml = '';
const proofs = Array.isArray(data.dealerDocs) ? data.dealerDocs : [];

if (needsDealerBlock(data)) {
  if (data.dealerVerified === true && status === 'approved') {
    // âœ… Approved dealer â†’ pill + popup
    dealerHtml = `
      <div class="dealer-verify">
        <span class="dealer-pill dealer-proof-link" data-proof='${JSON.stringify(proofs)}'>
          Verified Dealer <i class="fa-solid fa-circle-check"></i>
        </span>
      </div>`;
  } else {
    // â³ Pending / Rejected â†’ OK/X + Proof link
    dealerHtml = `
      <div class="dealer-verify">
        <span class="title">Dealer Verification</span>
        <button class="btn ok" data-action="dealer-ok" data-id="${adId}">Accept</button>
        <button class="btn no" data-action="dealer-no" data-id="${adId}">Reject</button>
        ${
          proofs.length
            ? `<a href="#" class="dealer-proof-link" data-proof='${JSON.stringify(proofs)}'>Proof</a>`
            : `<em style="font-size:12px;color:#6b7280">No proof</em>`
        }
      </div>`;
  }
}



    const div = document.createElement('div');
    div.className = `list-item ${status === "pending" ? "highlight-pending" : ""}`;
    div.innerHTML = `
      <input type="checkbox" class="ad-select-checkbox" data-adid="${adId}" style="margin-right:11px;transform:scale(1.2);vertical-align:middle;">
      <img src="${thumb}" alt="Thumbnail" style="width:54px;height:54px;object-fit:cover;border-radius:9px;margin-right:13px;vertical-align:middle;">
      <div style="flex:1;">
        <div class="ad-info">
          <strong>${data.title || 'No Title'}</strong>
          â€“ â‚¹${(Number(data.price)||0).toLocaleString('en-IN')}
          (${data.location || 'Unknown'})
          ${feeHtml}
        </div>

        <div class="ad-meta">
          <strong>Posted by:</strong> ${userId}<br>
          <strong>Ad ID:</strong> ${adId}<br>
          <strong>Status:</strong> ${statusHTML}<br>
          ${status === 'rejected'
            ? `<strong>Reason:</strong> <span style="color:#d9534f;">${getItemRejectReason(data)}</span>`
            : ''}
        </div>

        <!-- Dealer section -->
        ${dealerHtml}
      </div>

      <div class="ad-actions">
        ${buttonsHTML}
      </div>
    `;
    adsContainer.appendChild(div);
  });
}



function updatePendingBadge(count) {
  const badge = document.getElementById("pendingBadge");
  if (badge) {
    if (count > 0) {
      badge.textContent = count;
      badge.style.display = "inline-block";
    } else {
      badge.style.display = "none";
    }
  }
}

  
   function renderPendingAds(adDocs) {
  const reviewContainer = document.getElementById('adsReviewList');
  reviewContainer.innerHTML = '';

  if (adDocs.length === 0) {
  reviewContainer.innerHTML = '<p>No pending ads to review.</p>';
  const selectAll = document.getElementById("selectAllPending");
  if (selectAll) selectAll.checked = false; // âœ… uncheck it
  return;
}

  adDocs.forEach(doc => {
    const data = doc.data();
    const div = document.createElement('div');
    div.className = 'list-item';
    div.innerHTML = `
      <div>
        <input type="checkbox" class="pending-checkbox" data-id="${doc.id}" style="margin-right:10px;">
        <strong>${data.title || 'No Title'}</strong> 
        - â‚¹${data.price || '0'} 
        (${data.location || 'Unknown'})<br>
        <small>
          Category: ${data.category || 'N/A'} | 
          Brand: ${data.brand || 'N/A'} | 
          Area: ${data.area || 'N/A'} | 
          Posted by: ${data.userId || 'Unknown'}
        </small>
      </div>
      <div>
        <button onclick="viewUserDetails('${data.userId}')">View User</button>
        <button class="view-btn btn" onclick="viewAdDetails('${doc.id}')">View</button>
        <button class="approve-btn btn" onclick="approveAd('${doc.id}')">Approve</button>
        <button class="reject-btn btn" onclick="rejectAd('${doc.id}')">Reject</button>
      </div>
    `;
    reviewContainer.appendChild(div);
  });

  // âœ… Select All logic
  const selectAll = document.getElementById("selectAllPending");
  if (selectAll) {
    selectAll.checked = false;
    selectAll.onchange = () => {
      document.querySelectorAll(".pending-checkbox").forEach(cb => {
        cb.checked = selectAll.checked;
      });
    };
  }
}


function getSelectedPendingAdIds() {
  return Array.from(document.querySelectorAll('.pending-checkbox:checked'))
    .map(cb => cb.getAttribute('data-id'));
}

async function bulkApprovePending() {
  const ids = getSelectedPendingAdIds();
  if (ids.length === 0) {
    alert("No ads selected.");
    return;
  }

  if (!confirm(`Approve ${ids.length} ad(s)?`)) return;

  const adminName =
    (auth?.currentUser?.displayName || auth?.currentUser?.email) || 'admin';

  let success = 0, fail = 0;
  const failures = [];

  for (const adId of ids) {
    try {
      const adRef = db.collection('items').doc(adId);

      // === Same core logic as approveAd (transaction + boost restore) ===
      await db.runTransaction(async (tx) => {
        const snap = await tx.get(adRef);
        if (!snap.exists) throw new Error('Ad not found');

        const data = snap.data();
        const thumbUrl = (Array.isArray(data.images) && data.images[0])
          ? data.images[0]
          : (data.thumbnailUrl || '');

        // 1) Approve + moderation/approval meta + make public
        tx.set(adRef, {
          status: 'approved',
          visibility: 'public',
          isActive: true,
          moderation: {
            ...(data.moderation || {}),
            reviewedBy: 'admin',
            reviewedByName: adminName,
            reviewedAt: firebase.firestore.FieldValue.serverTimestamp(),
            reason: 'approved',
            thumb: thumbUrl
          },
          approval: {
            by: 'admin',
            byName: adminName,
            at: firebase.firestore.FieldValue.serverTimestamp(),
            thumb: thumbUrl
          },
          thumbnailUrl: thumbUrl
        }, { merge: true });

        // 2) Restore boost from boostReview.original (idempotent)
        const srcCandidate = data?.boostReview?.original;
        const src = (srcCandidate && typeof srcCandidate === 'object')
          ? (srcCandidate.boost && typeof srcCandidate.boost === 'object'
              ? srcCandidate.boost
              : srcCandidate)
          : null;

        if (src) {
          const allow = [
            'active','bumpBudget','bumpCount','bumpsDoneToday','bumpsPerDay',
            'endAt','lastBumpedAt','maxBumps','nextBumpAt','plan','premiumTag','startAt'
          ];
          const boostUpdate = {};
          allow.forEach(k => {
            if (Object.prototype.hasOwnProperty.call(src, k)) boostUpdate[k] = src[k];
          });

          tx.set(adRef, {
            boost: boostUpdate,
            boostReview: firebase.firestore.FieldValue.delete(),
            boostRestoredOnce: true
          }, { merge: true });
        }
      });

      // === After-transaction: optional payment log + notification (same style) ===
      const after = await adRef.get();
      const data = after.data();

      if (data.amount && data.plan) {
        await db.collection('payments').add({
          userId: data.userId,
          adId,
          amount: data.amount,
          plan: data.plan,
          paymentId: 'MANUAL-APPROVE-' + adId,
          status: 'success',
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
      }

      await db.collection('notifications').add({
        userId: data.userId,
        message: `Your ad "${data.title}" has been approved and is now live.`,
        imageUrl: data.images?.[0] || data.thumbnailUrl || '',
        adId,
        type: 'approved',
        adminName,
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        seen: false
      });

      success++;
    } catch (e) {
      fail++;
      failures.push({ adId, error: e.message });
      console.warn('Bulk approve failed for', adId, e);
    }
  }

  alert(`Approved: ${success} / ${ids.length}${fail ? ` | Failed: ${fail}` : ''}`);

  // UI refresh (best-effort)
  try { await loadDashboard(); } catch (e) {}
}


async function bulkRejectPending() {
  const ids = getSelectedPendingAdIds();
  if (ids.length === 0) {
    alert("No ads selected.");
    return;
  }

  const confirmAction = confirm(`Are you sure you want to reject ${ids.length} ad(s)?`);
  if (!confirmAction) return;

  for (let id of ids) {
    await db.collection('items').doc(id).update({
      status: 'rejected',
      rejectReason: 'Bulk rejection'
    });
  }

  alert("âŒ Selected ads rejected!");
}


// inside renderUserReports() ke END me, CLICK listener ko persist rakho:
(function wireUserReportClicks(){
  if (window.__userReportsClickWired) return; window.__userReportsClickWired = true;

  document.addEventListener('click', async (e) => {
    const box = document.getElementById('userReportList');
    if (!box || !box.contains(e.target)) return;

    const t = e.target.closest('button');
    if (!t) return;

    if (t.classList.contains('act-view-user')) {
      const uid = t.getAttribute('data-whom');
      if (window.viewUserDetails) viewUserDetails(uid);
      return;
    }

    const rid = t.getAttribute('data-rid');
    if (!rid) return;

    if (t.classList.contains('act-resolve')) {
      const sel = box.querySelector(`select.resolve-note[data-rid="${rid}"]`);
      const ta  = box.querySelector(`textarea.resolve-other[data-rid="${rid}"]`);
      let details = sel?.value || '';
      if (details === '__OTHER__') details = (ta?.value || '').trim();
      if (!details) { alert('Please select/add a resolution note.'); return; }
      try{
        const by = (auth && auth.currentUser && (auth.currentUser.uid || auth.currentUser.email)) || 'admin';
        await db.collection('reports').doc(rid).set({
          status:'resolved', details: details, resolvedAt: firebase.firestore.FieldValue.serverTimestamp(), resolvedBy: by
        }, { merge:true });
        loadUserReports(getActiveUsrTabStatus());
        alert('Marked resolved.');
      }catch(err){ console.error(err); alert('Failed.'); }
      return;
    }
    if (t.classList.contains('act-reopen'))  {
      if(!confirm('Move this report back to Active (pending)?')) return;
      await db.collection('reports').doc(rid).set({ status:'pending' }, { merge:true });
      loadUserReports(getActiveUsrTabStatus());
      return;
    }
    if (t.classList.contains('act-delete'))  {
      if(!confirm('Delete this user report?')) return;
      await db.collection('reports').doc(rid).delete();
      loadUserReports(getActiveUsrTabStatus());
      return;
    }
  });
})();
// ================== Admin Push Helpers (FINAL UNIFORM STYLE) ==================
const FN_FANOUT =
  (location.hostname.endsWith('netlify.app') || location.hostname.endsWith('netlify.live'))
    ? '/.netlify/functions/fanout-notification'
    : 'https://bechobazaar.netlify.app/.netlify/functions/fanout-notification';

let currentRejectAdId = null;

function buildAdDecisionPayload({ adId, title, decision, reason, thumbUrl }) {
  const isApproved = decision === 'approved';
  const openUrl = '/account';
  const imageUrl = thumbUrl || '';

  return {
    title: isApproved ? 'âœ… Ads Approved' : 'âŒ Ads Rejected',
    body:  isApproved
      ? `Your ad ${title || 'Ad'} is live now.`
      : (reason && reason.trim()
          ? `Your ad ${title || 'Ad'} was rejected. Reason: ${reason}`
          : `Your ad ${title || 'Ad'} was rejected.`),
    imageUrl,                 // <-- for Appilix
    open: openUrl,
    data: {                   // <-- for Service Worker (web)
      type: 'ad_status',
      adStatus: isApproved ? 'approved' : 'rejected',
      adId,
      adTitle: title || 'Ad',
      reason: isApproved ? null : (reason || null),
      url: openUrl,
      image_url: imageUrl,    // <-- SW reads image_url / imageUrl
      imageUrl: imageUrl,
      tag: `ad-status-${adId}`
    }
  };
}

/* Fanout to devices (passes open + data so SW renders same style) */
async function fanoutToOwner(userId, payload) {
  try {
    const res = await fetch(FN_FANOUT, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        userId,
        title:    payload.title,
        body:     payload.body,
        imageUrl: payload.imageUrl || '',
        open:     payload.open || '/account',
        data:     payload.data || null
      })
    });
    if (!res.ok) {
      const t = await res.text().catch(()=> '');
      console.warn('[fanout] failed', res.status, t);
    }
  } catch (e) {
    console.warn('[fanout] error', e);
  }
}

/* ================== Approve ================== */
async function approveAd(adId) {
  if (!confirm('Approve this ad?')) return;
  try {
    const adRef = db.collection('items').doc(adId);
    const adminName = (auth?.currentUser?.displayName || auth?.currentUser?.email) || 'admin';

    await db.runTransaction(async (tx) => {
      const snap = await tx.get(adRef);
      if (!snap.exists) throw new Error('Ad not found');
      const data = snap.data();

      const thumbUrl = (Array.isArray(data.images) && data.images[0]) ? data.images[0] : (data.thumbnailUrl || '');

      tx.set(adRef, {
        status: 'approved',
        visibility: 'public',
        isActive: true,
        moderation: {
          ...(data.moderation || {}),
          reviewedBy: 'admin',
          reviewedByName: adminName,
          reviewedAt: firebase.firestore.FieldValue.serverTimestamp(),
          reason: 'approved',
          thumb: thumbUrl
        },
        approval: {
          by: 'admin',
          byName: adminName,
          at: firebase.firestore.FieldValue.serverTimestamp(),
          thumb: thumbUrl
        },
        thumbnailUrl: thumbUrl
      }, { merge: true });

      const boostSrc = data?.boostReview?.original;
      if (boostSrc) {
        tx.set(adRef, {
          boost: boostSrc,
          boostReview: firebase.firestore.FieldValue.delete(),
          boostRestoredOnce: true
        }, { merge: true });
      }
      const featuredSrc = data?.featuredReview?.original;
      if (featuredSrc) {
        tx.set(adRef, {
          featured: !!featuredSrc.featured,
          featuredExpiry: featuredSrc.featuredExpiry || null,
          featuredReview: firebase.firestore.FieldValue.delete()
        }, { merge: true });
      }
    });

    const after = await db.collection('items').doc(adId).get();
    const data = after.data();
    const thumbUrl = (data?.images && data.images[0]) ? data.images[0] : (data?.thumbnailUrl || '');

    if (data.amount && data.plan) {
      await db.collection('payments').add({
        userId: data.userId,
        adId,
        amount: data.amount,
        plan: data.plan,
        paymentId: 'MANUAL-APPROVE-' + adId,
        status: 'success',
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });
    }

    // In-app notification
    await db.collection('notifications').add({
      userId: data.userId,
      message: `ðŸŽ‰ Congratulations! Your ad ${data.title} is live on Bechobazaar.`,
      imageUrl: thumbUrl,
      adId,
      type: 'approved',
      adminName,
      timestamp: firebase.firestore.FieldValue.serverTimestamp(),
      seen: false
    });

    // Push notification (uniform style)
    const pushPayload = buildAdDecisionPayload({
      adId,
      title: data.title,
      decision: 'approved',
      reason: '',
      thumbUrl
    });
    await fanoutToOwner(data.userId, pushPayload);

    alert('Ad approved.');
  } catch (err) {
    console.error('Error approving ad:', err);
    alert('Failed to approve.');
  }
}

/* ================== Reject ================== */
function rejectAd(adId) {
  currentRejectAdId = adId;
  const sel = document.getElementById('rejectReasonSelect');
  if (sel) sel.value = '';
  document.getElementById('rejectReasonModal').style.display = 'block';
}

async function confirmRejectReason() {
  const sel = document.getElementById('rejectReasonSelect');
  const reason = sel ? (sel.value || '').trim() : '';
  if (!reason) { alert('Please select a rejection reason.'); return; }

  try {
    const adRef = db.collection('items').doc(currentRejectAdId);
    const doc = await adRef.get();
    if (!doc.exists) { alert("Ad not found."); return; }

    const data = doc.data();
    const adminName = (auth?.currentUser?.displayName || auth?.currentUser?.email) || 'admin';
    const thumbUrl  = (data?.images && data.images[0]) ? data.images[0] : (data?.thumbnailUrl || '');

    await adRef.set({
      rejectionReason: reason,
      rejectReason: reason,
      moderation: {
        ...(data.moderation || {}),
        reviewedBy: 'admin',
        reviewedByName: adminName,
        reviewedAt: firebase.firestore.FieldValue.serverTimestamp(),
        reason,
        thumb: thumbUrl
      },
      reject: { code: '', text: reason, by: 'admin', byName: adminName, at: firebase.firestore.FieldValue.serverTimestamp(), thumb: thumbUrl },
      thumbnailUrl: thumbUrl
    }, { merge: true });

    await adRef.update({
      status: 'rejected',
      rejectionReason: reason,
      boosted: false
    });

    await db.collection('rejectionHistory').add({
      adId: currentRejectAdId,
      reason,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });

    // In-app notification
    await db.collection("notifications").add({
      userId: data.userId,
      message: `âŒ Your ad ${data.title} was rejected. Reason: ${reason}`,
      imageUrl: thumbUrl,
      adId: currentRejectAdId,
      type: 'rejected',
      adminName,
      timestamp: firebase.firestore.FieldValue.serverTimestamp(),
      seen: false
    });

    // Push notification (uniform style)
    const pushPayload = buildAdDecisionPayload({
      adId: currentRejectAdId,
      title: data.title,
      decision: 'rejected',
      reason,
      thumbUrl
    });
    await fanoutToOwner(data.userId, pushPayload);

    alert('Ad rejected with reason.');
    closeRejectModal();
  } catch (err) {
    console.error('Error rejecting ad:', err);
    alert('Failed to reject.');
  }
}

function closeRejectModal() {
  document.getElementById('rejectReasonModal').style.display = 'none';
  currentRejectAdId = null;
}

/* ================== Generic notify helper (same style infra) ================== */
async function sendNotification(userId, message, meta = {}) {
  try {
    await db.collection("notifications").add({
      userId,
      message,
      timestamp: firebase.firestore.FieldValue.serverTimestamp(),
      seen: false,
      ...meta
    });

    await fanoutToOwner(userId, {
      title: 'Bechobazaar',
      body: message,
      imageUrl: meta.imageUrl || '',
      open: meta.open || '/notifications',
      data: {
        type: 'in_app',
        url: meta.open || '/notifications',
        tag: `inapp-${userId}`
      }
    });

    console.log("Notification sent + pushed to", userId);
  } catch (err) {
    console.error("Notification error:", err);
  }
}


/* ================== Firestore refs / utils ================== */
const catCol = () => db.collection('categories');
const catDoc = (id) => catCol().doc(id);
const subCol = (catId) => catDoc(catId).collection('subcategories');
const toId = (s) => String(s||'').trim().toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'');

/* UI node helper */
const $ = (id) => document.getElementById(id);

/* STATE: which category is open in subcat editor */
let currentCatId = null;

/* ------- helpers to parse bulk/inline subcategory lines ------- */
function parseSubLines(text){
  const out = [];
  (text || '')
    .split('\n')
    .map(x => x.trim())
    .filter(Boolean)
    .forEach((line, idx) => {
      const parts = line.split('|').map(p => p.trim()).filter(Boolean);
      const name = parts[0] || `Sub-${idx+1}`;
      const order = parts[1] ? parseInt(parts[1],10) || (idx+1) : (idx+1);
      const active = parts[2] ? (String(parts[2]).toLowerCase() === 'true') : true;
      out.push({ id: toId(name), name, order, active });
    });
  return out;
}

function resetCatForm(){
  if ($('catName'))  $('catName').value='';
  if ($('catIcon'))  $('catIcon').value='';
  if ($('catOrder')) $('catOrder').value='1';
  if ($('catActive'))$('catActive').checked=true;
  if ($('catSubs'))  $('catSubs').value='';
  // clear icon preview too
  if (window.setActiveCategoryDocId) setActiveCategoryDocId(null, null);
}

/* ================== LOAD: All categories ================== */
async function loadCategories(){
  const box = $('catList');
  if (!box){ console.warn('catList container not found'); return; }

  box.innerHTML = 'Loading...';
  const snap = await catCol().orderBy('order').get();
  if (snap.empty){ box.innerHTML = '<em>No categories yet.</em>'; return; }

  const rows = [];
  snap.forEach(doc=>{
    const d = doc.data()||{};
    const iconFa = d.icon ? `<i class="${d.icon}" style="margin-right:6px;"></i>` : '';
    const active = d.active ? '<span class="status-approved status-label">Active</span>' : '<span class="status-rejected status-label">Inactive</span>';
    const iconUrlBadge = d.iconUrl ? `<span style="margin-left:6px;font-size:11px;color:#6b7280;">IMG âœ“</span>` : '';
    rows.push(`
      <div class="list-item" data-id="${doc.id}">
        <div>
          <div class="ad-info">${iconFa}<b>${d.name||doc.id}</b> <span>Order: ${d.order||0}</span> ${active} ${iconUrlBadge}</div>
          <div class="ad-meta">ID: <code>${doc.id}</code></div>
        </div>
        <div class="ad-actions">
          <button class="btn-view"    onclick="openSubEditor('${doc.id}','${(d.name||'').replace(/'/g,'\\\'')}')">Subcategories</button>
          <button class="btn-edit"    onclick="editCategoryPrompt('${doc.id}')">Edit</button>
          <button class="btn-delete"  onclick="deleteCategory('${doc.id}')">Delete</button>
        </div>
      </div>
    `);
  });
  box.innerHTML = rows.join('');
}

/* ================== ADD / UPDATE: Category (simple) ================== */
if ($('saveCatBtn')) {
  $('saveCatBtn').onclick = async ()=>{
    const name  = $('catName').value.trim();
    const icon  = $('catIcon').value.trim();
    const order = parseInt($('catOrder').value)||0;
    const active= $('catActive').checked;

    if(!name) return alert('Category name required.');
    const id = toId(name);

    await catDoc(id).set({ name, icon, order, active }, { merge: true });

    // Upload pending icon if any, then bind preview
    let upUrl = null;
    if (typeof handleCatIconPendingUpload === 'function') {
      upUrl = await handleCatIconPendingUpload(id);
    }
    if (typeof setActiveCategoryDocId === 'function') {
      setActiveCategoryDocId(id, upUrl || null);
    }

    $('catName').value=''; $('catIcon').value=''; $('catOrder').value='1'; $('catActive').checked=true;
    $('saveCatBtn').innerText = 'Add Category';
    $('saveCatBtn').onclick = arguments.callee; // restore default
    await loadCategories();
    alert('Saved.');
  };
}

/* ===== Category Icon (PNG/WebP) â€” robust preview + upload manager ===== */
(function(){
  // state for icon manager (separate from subcat editor)
  let _iconCatId = null;
  let tempObjectUrl = null;

  // Always grab fresh elements (prevents stale nulls)
  function els(){
    return {
      fileEl:  document.getElementById('catIconFile'),
      upBtn:   document.getElementById('uploadCatIconBtn'),
      rmBtn:   document.getElementById('removeCatIconBtn'),
      preview: document.getElementById('catIconPreview'),
      urlCode: document.getElementById('catIconUrlCode'),
    };
  }

  const ALLOWED = ['image/png','image/webp'];
  const extOf   = (mime) => mime === 'image/webp' ? 'webp' : 'png';
  const pathFor = (id, ext) => `category-icons/${id}.${ext}`;

  function revokeTemp(){ if (tempObjectUrl){ URL.revokeObjectURL(tempObjectUrl); tempObjectUrl=null; } }

  function showPreview(src){
    const {preview, rmBtn, urlCode} = els();
    if (!preview) return;                    // if tab not mounted yet
    preview.src = src || '';
    preview.style.display = src ? 'inline-block' : 'none';
    if (rmBtn) rmBtn.style.display = src ? 'inline-flex' : 'none';
    if (urlCode){ urlCode.textContent = src || ''; urlCode.style.display = src ? 'inline-block' : 'none'; }
  }
  function clearPreview(){ showPreview(''); }

  // âœ… Always available: edit pe existing icon turant dikhana
  window.setActiveCategoryDocId = function(docId, existingIconUrl){
    _iconCatId = docId || null;
    revokeTemp();

    if (existingIconUrl) {
      showPreview(existingIconUrl);
    } else {
      clearPreview();
      // Optional fallback: if iconUrl missing, try Storage .png then .webp
      try{
        if (window.firebase && firebase.apps?.length && _iconCatId){
          const st = firebase.storage();
          st.ref().child(pathFor(_iconCatId,'png')).getDownloadURL()
            .then(u => showPreview(u))
            .catch(()=> st.ref().child(pathFor(_iconCatId,'webp')).getDownloadURL()
              .then(u => showPreview(u)).catch(()=>{}));
        }
      }catch(_){}
    }
    const {fileEl} = els(); if (fileEl) fileEl.value='';
  };

  // Local instant preview on file choose (PNG/WebP)
  function onFileChange(){
    const {fileEl} = els();
    const f = fileEl?.files?.[0]; if(!f) return;
    if (!ALLOWED.includes(f.type)){ alert('Only PNG or WebP allowed'); fileEl.value=''; return; }
    revokeTemp();
    tempObjectUrl = URL.createObjectURL(f);
    showPreview(tempObjectUrl);
    const {urlCode} = els();
    if (urlCode){ urlCode.textContent = `${f.name} (not uploaded yet)`; urlCode.style.display='inline-block'; }
  }

  // Upload helper (lazy Firebase checks)
  async function uploadCatIcon(docId, file){
    if (!(window.firebase && firebase.apps?.length)) { alert('Firebase not initialized yet. Try again.'); throw new Error('no-firebase'); }
    const st = firebase.storage();
    const db = firebase.firestore();

    const ext = extOf(file.type);
    const ref = st.ref().child(pathFor(docId, ext));
    await ref.put(file, { contentType: file.type });
    const url = await ref.getDownloadURL();

    // clean the sibling format if exists
    const other = ext === 'png' ? 'webp' : 'png';
    try { await st.ref().child(pathFor(docId, other)).delete(); } catch(_){}

    await db.collection('categories').doc(docId)
      .update({ iconUrl: url, iconMime: file.type, iconExt: ext });

    return url;
  }

  async function onUploadClick(){
    const {upBtn, fileEl} = els();
    try{
      if(!_iconCatId){ alert('Save/select a category first.'); return; }
      const f = fileEl?.files?.[0]; if(!f){ alert('Choose an icon file.'); return; }
      if (!ALLOWED.includes(f.type)){ alert('Only PNG or WebP allowed'); return; }

      if (upBtn){ upBtn.disabled = true; upBtn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Uploadingâ€¦'; }
      const url = await uploadCatIcon(_iconCatId, f);
      revokeTemp();
      showPreview(url);
      if (fileEl) fileEl.value = '';
    }catch(e){
      if (e?.message !== 'no-firebase'){ console.error(e); alert('Upload failed.'); }
    }finally{
      const {upBtn} = els(); if (upBtn){ upBtn.disabled = false; upBtn.innerHTML = '<i class="fa fa-upload"></i> Upload PNG'; }
    }
  }

  async function onRemoveClick(){
    const {fileEl} = els();
    // local-only selection
    if (fileEl?.files?.length){
      fileEl.value=''; revokeTemp(); clearPreview(); return;
    }
    // uploaded removal
    try{
      if (!_iconCatId){ clearPreview(); return; }
      if (!(window.firebase && firebase.apps?.length)){ clearPreview(); return; }
      const st = firebase.storage(); const db = firebase.firestore();
      try { await st.ref().child(pathFor(_iconCatId,'png')).delete(); } catch(_){}
      try { await st.ref().child(pathFor(_iconCatId,'webp')).delete(); } catch(_){}
      await db.collection('categories').doc(_iconCatId)
        .update({
          iconUrl: firebase.firestore.FieldValue.delete(),
          iconMime: firebase.firestore.FieldValue.delete?.() ?? undefined,
          iconExt: firebase.firestore.FieldValue.delete?.() ?? undefined
        });
      revokeTemp(); clearPreview();
    }catch(e){ console.error(e); alert('Remove failed.'); }
  }

  // Bind after DOM ready
  function bindOnce(){
    const {fileEl, upBtn, rmBtn} = els();
    fileEl?.addEventListener('change', onFileChange);
    upBtn?.addEventListener('click', onUploadClick);
    rmBtn?.addEventListener('click', onRemoveClick);
  }
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', bindOnce, { once: true });
  } else {
    bindOnce();
  }

  // Post-save hook (called by your save buttons)
  window.handleCatIconPendingUpload = async function(docId){
    const {fileEl} = els();
    const f = fileEl?.files?.[0];
    if (!f) return null;
    if (!ALLOWED.includes(f.type)){ alert('Only PNG or WebP allowed'); return null; }
    const url = await uploadCatIcon(docId, f);
    revokeTemp(); showPreview(url); if (fileEl) fileEl.value='';
    _iconCatId = docId; // keep Remove/Upload bound
    return url;
  };
})();

/* ================== ADD / UPDATE: Category + Subcategories (NEW) ================== */
if ($('saveCatWithSubsBtn')) {
  $('saveCatWithSubsBtn').addEventListener('click', async ()=>{
    const name  = ($('catName')?.value || '').trim();
    const icon  = ($('catIcon')?.value || '').trim();
    const order = parseInt($('catOrder')?.value,10) || 0;
    const active= !!($('catActive')?.checked);
    const subsText = $('catSubs')?.value || '';

    if(!name) { alert('Category name required.'); return; }
    const categoryId = toId(name);

    const catData = { name, icon, order, active };
    const subs = parseSubLines(subsText); // [{id,name,order,active},...]

    try{
      const batch = db.batch();
      batch.set(catDoc(categoryId), catData, { merge: true });

      if (subs.length > 450){
        alert('Too many subcategories in one go. Please add <= 450.');
        return;
      }
      subs.forEach(s => {
        batch.set(subCol(categoryId).doc(s.id), { name: s.name, order: s.order, active: !!s.active }, { merge: true });
      });

      // 1) Save category + subs
      await batch.commit();

      // 2) If file chosen, upload & set preview
      let upUrl = null;
      if (typeof handleCatIconPendingUpload === 'function') {
        upUrl = await handleCatIconPendingUpload(categoryId);
      }

      // 3) Bind preview with saved url
      if (typeof setActiveCategoryDocId === 'function') {
        setActiveCategoryDocId(categoryId, upUrl || null);
      }

      alert(`Saved category "${name}" with ${subs.length} subcategories.`);
      resetCatForm();
      await loadCategories();
    } catch(e){
      console.error(e);
      alert('Failed to save category + subcategories. See console.');
    }
  });
}

/* optional: reset button for top form */
if ($('resetCatFormBtn')) {
  $('resetCatFormBtn').addEventListener('click', resetCatForm);
}

/* ================== EDIT: Category ================== */
async function editCategoryPrompt(id){
  try{
    const snap = await catDoc(id).get();
    if(!snap.exists) return alert('Not found');

    const d = snap.data() || {};

    // 1) Populate form fields
    if ($('catName'))  $('catName').value  = d.name  || '';
    if ($('catIcon'))  $('catIcon').value  = d.icon  || '';
    if ($('catOrder')) $('catOrder').value = d.order ?? 0;
    if ($('catActive'))$('catActive').checked = !!d.active;

    // 2) Preview: AFTER DOM paint
    const url = d.iconUrl || null;
    requestAnimationFrame(()=>{
      if (typeof setActiveCategoryDocId === 'function') {
        setActiveCategoryDocId(id, url);
      } else {
        // fallback direct set
        const img = $('catIconPreview');
        const rm  = $('removeCatIconBtn');
        const code= $('catIconUrlCode');
        if (img) {
          if (url) {
            img.src = url; img.style.display = 'inline-block';
            if (rm) rm.style.display = 'inline-flex';
            if (code) { code.textContent = url; code.style.display='inline-block'; }
          } else {
            img.src = ''; img.style.display = 'none';
            if (rm) rm.style.display = 'none';
            if (code) { code.textContent=''; code.style.display='none'; }
          }
        }
      }
    });

    // 3) (Optional) error guard for broken URLs
    const img = $('catIconPreview');
    if (img) {
      img.onerror = ()=> console.warn('Icon preview failed to load:', url);
    }

    // 4) Switch Save button to Update flow
    if ($('saveCatBtn')) {
      $('saveCatBtn').innerText = 'Update Category';
      $('saveCatBtn').onclick = async ()=>{
        const name   = ($('catName')?.value || '').trim();
        const icon   = ($('catIcon')?.value || '').trim();
        const order  = parseInt($('catOrder')?.value,10) || 0;
        const active = !!($('catActive')?.checked);
        if(!name) return alert('Name required');

        await catDoc(id).update({ name, icon, order, active });

        // pending icon upload + preview sync
        let upUrl = null;
        if (typeof handleCatIconPendingUpload === 'function') {
          upUrl = await handleCatIconPendingUpload(id);
        }
        if (typeof setActiveCategoryDocId === 'function') {
          setActiveCategoryDocId(id, upUrl || d.iconUrl || null);
        }

        // reset UI
        $('catName').value=''; $('catIcon').value=''; $('catOrder').value='1'; $('catActive').checked=true;
        $('saveCatBtn').innerText = 'Add Category';
        $('saveCatBtn').onclick = arguments.callee; // restore default
        await loadCategories();
        alert('Updated.');
      };
    }
  }catch(e){
    console.error(e);
    alert('Edit open failed.');
  }
}

/* ================== DELETE: Category (and all subcategories) ================== */
async function deleteCategory(id){
  if(!confirm('Delete category and all its subcategories?')) return;

  // delete subcollection docs
  const subs = await subCol(id).get();
  const batch = db.batch();
  subs.forEach(doc => batch.delete(doc.ref));
  await batch.commit();

  await catDoc(id).delete();
  await loadCategories();
  alert('Deleted.');
}

/* ================== SUBCATEGORIES UI / CRUD ================== */
function openSubEditor(id, name){
  currentCatId = id;
  if ($('subcatEditor')) $('subcatEditor').style.display = 'block';
  if ($('subcatFor'))    $('subcatFor').textContent = `${name} (${id})`;
  if ($('bulkSubs'))     $('bulkSubs').value = '';
  loadSubcategories(id);
}

/* helper: next order = max(order)+1 */
async function getNextSubOrder(catId){
  const snap = await subCol(catId).orderBy('order','desc').limit(1).get();
  if (snap.empty) return 1;
  const top = snap.docs[0].data()||{};
  const cur = parseInt(top.order,10) || 0;
  return cur + 1;
}

/* helper: ensure Save button above list (once) */
function ensureSaveOrderButton(){
  const host = $('subcatEditor');
  if (!host || $('saveSubOrderBtn')) return;
  const wrap = document.createElement('div');
  wrap.style.display = 'flex';
  wrap.style.justifyContent = 'flex-end';
  wrap.style.gap = '8px';
  wrap.style.margin = '6px 0 10px 0';

  const note = document.createElement('small');
  note.textContent = 'Drag karke arrange karein, phir "Save sub order".';
  note.style.marginRight = 'auto';
  note.style.alignSelf = 'center';
  note.style.color = '#6b7280';

  const btn = document.createElement('button');
  btn.id = 'saveSubOrderBtn';
  btn.className = 'approve-btn';
  btn.textContent = 'Save sub order';
  btn.addEventListener('click', saveSubOrder);

  wrap.appendChild(note);
  wrap.appendChild(btn);

  const list = $('subList');
  if (list) host.insertBefore(wrap, list);
}

/* render + wire DnD */
async function loadSubcategories(catId){
  const box = $('subList'); 
  if (!box){ console.warn('subList container not found'); return; }
  box.innerHTML = 'Loading...';

  const snap = await subCol(catId).orderBy('order').get();
  if (snap.empty){ 
    box.innerHTML = '<em>No subcategories yet.</em>'; 
    ensureSaveOrderButton();
    return; 
  }

  const rows = [];
  snap.forEach(doc=>{
    const d = doc.data()||{};
    const active = d.active ? '<span class="status-approved status-label">Active</span>' : '<span class="status-rejected status-label">Inactive</span>';
    rows.push(`
      <div class="list-item sub-row" data-id="${doc.id}" draggable="true">
        <div>
          <div class="ad-info">
            <span class="drag-handle" style="cursor:grab;font-weight:700;margin-right:8px;color:#64748b;">â‰¡</span>
            <b>${d.name||doc.id}</b> 
            <span>Order: <code class="order-num">${d.order||''}</code></span> ${active}
          </div>
          <div class="ad-meta">ID: <code>${doc.id}</code></div>
        </div>
        <div class="ad-actions">
          <button class="btn-edit"   onclick="editSubPrompt('${doc.id}')">Edit</button>
          <button class="btn-delete" onclick="deleteSub('${doc.id}')">Delete</button>
        </div>
      </div>
    `);
  });
  box.innerHTML = rows.join('');
  ensureSaveOrderButton();
  wireSubDnD();
  renumberPreview();
}

/* DnD wiring */
function wireSubDnD(){
  const list = $('subList');
  if (!list) return;

  let dragging = null;

  list.querySelectorAll('.sub-row').forEach(row=>{
    row.setAttribute('draggable','true');
  });

  list.addEventListener('dragstart', (e)=>{
    const row = e.target.closest('.sub-row');
    if (!row) return;
    dragging = row;
    row.classList.add('dragging');
    e.dataTransfer.effectAllowed = 'move';
    try { e.dataTransfer.setData('text/plain', row.dataset.id || ''); } catch(_){}
  });

  list.addEventListener('dragend', (e)=>{
    const row = e.target.closest('.sub-row');
    if (row) row.classList.remove('dragging');
    dragging = null;
    renumberPreview();
  });

  list.addEventListener('dragover', (e)=>{
    if (!dragging) return;
    e.preventDefault();
    const after = getDragAfterElement(list, e.clientY);
    if (after == null) list.appendChild(dragging);
    else list.insertBefore(dragging, after);
  });
}

function getDragAfterElement(container, y){
  const els = [...container.querySelectorAll('.sub-row:not(.dragging)')];
  let closest = {offset: Number.NEGATIVE_INFINITY, element: null};
  for (const child of els){
    const box = child.getBoundingClientRect();
    const offset = y - box.top - box.height/2;
    if (offset < 0 && offset > closest.offset){
      closest = {offset, element: child};
    }
  }
  return closest.element;
}

function renumberPreview(){
  const list = $('subList'); if (!list) return;
  [...list.querySelectorAll('.sub-row')].forEach((row, idx)=>{
    const badge = row.querySelector('.order-num');
    if (badge) badge.textContent = String(idx+1);
  });
}

/* Persist current DOM order â†’ Firestore */
async function saveSubOrder(){
  if (!currentCatId) return alert('Select a category first.');
  const list = $('subList'); if (!list) return;

  const rows = [...list.querySelectorAll('.sub-row')];
  if (!rows.length) return alert('No subcategories to save.');

  const batch = db.batch();
  rows.forEach((row, idx)=>{
    const subId = row.dataset.id || row.getAttribute('data-id');
    if (subId) batch.update(subCol(currentCatId).doc(subId), { order: idx + 1 });
  });

  const btn = $('saveSubOrderBtn'); 
  if (btn){ btn.disabled = true; btn.textContent = 'Savingâ€¦'; }
  try{
    await batch.commit();
    alert('Sub-order saved.');
  }catch(err){
    console.error(err);
    alert('Save failed. Console dekh lo.');
  }finally{
    if (btn){ btn.disabled = false; btn.textContent = 'Save sub order'; }
    await loadSubcategories(currentCatId);
  }
}

/* ===== Add / Edit / Delete (order-safe) ===== */
if ($('addSubBtn')) {
  $('addSubBtn').onclick = async ()=>{
    if(!currentCatId) return alert('Select a category first.');
    const name  = ($('subName')?.value || '').trim();
    let   order = parseInt($('subOrder')?.value,10) || 0;
    const active= !!($('subActive')?.checked);
    if(!name) return alert('Subcategory name required');

    const id = toId(name);
    if (!order) order = await getNextSubOrder(currentCatId);

    await subCol(currentCatId).doc(id).set({ name, order, active }, { merge:true });

    if ($('subName'))  $('subName').value='';
    if ($('subOrder')) $('subOrder').value='1';
    if ($('subActive'))$('subActive').checked=true;

    await loadSubcategories(currentCatId);
    alert('Subcategory saved.');
  };
}

async function editSubPrompt(subId){
  if(!currentCatId) return;
  const doc = await subCol(currentCatId).doc(subId).get();
  if(!doc.exists) return alert('Not found');
  const d = doc.data()||{};

  if ($('subName'))   $('subName').value  = d.name||'';
  if ($('subOrder'))  $('subOrder').value = d.order||0;
  if ($('subActive')) $('subActive').checked = !!d.active;

  if ($('addSubBtn')) {
    $('addSubBtn').textContent='Update Subcategory';
    $('addSubBtn').onclick = async ()=>{
      const name  = ($('subName')?.value || '').trim();
      let   order = parseInt($('subOrder')?.value,10) || 0;
      const active= !!($('subActive')?.checked);
      if(!name) return alert('Name required');

      // if user left 0, keep existing (no shuffle)
      if (!order) order = d.order || 1;

      await subCol(currentCatId).doc(subId).update({ name, order, active });

      if ($('subName'))   $('subName').value='';
      if ($('subOrder'))  $('subOrder').value='1';
      if ($('subActive')) $('subActive').checked=true;

      $('addSubBtn').textContent='Add Subcategory';
      $('addSubBtn').onclick = arguments.callee; // restore
      await loadSubcategories(currentCatId);
      alert('Updated.');
    };
  }
}

async function deleteSub(subId){
  if(!currentCatId) return;
  if(!confirm('Delete this subcategory?')) return;
  await subCol(currentCatId).doc(subId).delete();
  await loadSubcategories(currentCatId);
  alert('Deleted.');
}

/* ================== BULK: Append / Replace (order-safe) ================== */
if ($('bulkAppendBtn')) {
  $('bulkAppendBtn').addEventListener('click', async ()=>{
    if (!currentCatId){ alert('Select a category first.'); return; }
    const parsed = parseSubLines($('bulkSubs')?.value || '');
    if (!parsed.length){ alert('Nothing to append.'); return; }

    try{
      if (parsed.length > 450){ alert('Too many lines. Please add <= 450.'); return; }

      // start from current max
      let next = await getNextSubOrder(currentCatId);

      const batch = db.batch();
      parsed.forEach(s => {
        const ord = (parseInt(s.order,10) || 0) > 0 ? parseInt(s.order,10) : (next++);
        batch.set(subCol(currentCatId).doc(s.id), { name: s.name, order: ord, active: !!s.active }, { merge: true });
      });
      await batch.commit();

      if ($('bulkSubs')) $('bulkSubs').value='';
      await loadSubcategories(currentCatId);
      alert(`Appended ${parsed.length} subcategories.`);
    }catch(e){
      console.error(e); alert('Append failed. See console.');
    }
  });
}

if ($('bulkReplaceBtn')) {
  $('bulkReplaceBtn').addEventListener('click', async ()=>{
    if (!currentCatId){ alert('Select a category first.'); return; }
    const confirmReplace = confirm('This will DELETE all existing subcategories and write the new list. Continue?');
    if (!confirmReplace) return;

    const parsed = parseSubLines($('bulkSubs')?.value || '');
    if (!parsed.length){ alert('Provide new subcategories to replace with.'); return; }

    try{
      // 1) delete existing
      const existing = await subCol(currentCatId).get();
      const batch1 = db.batch();
      existing.forEach(doc => batch1.delete(doc.ref));
      await batch1.commit();

      // 2) write new with normalized 1..N if order missing
      const batch2 = db.batch();
      parsed.forEach((s, idx) => {
        const ord = (parseInt(s.order,10) || 0) > 0 ? parseInt(s.order,10) : (idx+1);
        batch2.set(subCol(currentCatId).doc(s.id), { name: s.name, order: ord, active: !!s.active });
      });
      await batch2.commit();

      if ($('bulkSubs')) $('bulkSubs').value='';
      await loadSubcategories(currentCatId);
      alert(`Replaced with ${parsed.length} subcategories.`);
    }catch(e){
      console.error(e); alert('Replace failed. See console.');
    }
  });
}



    // ===== EDIT AD =====
   async function editAd(adId) {
  try {
    const doc = await db.collection('items').doc(adId).get();
    if (!doc.exists) {
      alert('Ad not found.');
      return;
    }
    const data = doc.data();
    currentEditAdId = adId;

    // Basic fields
    document.getElementById('editTitle').value = data.title || '';
    document.getElementById('editPrice').value = data.price || '';
    document.getElementById('editLocation').value = data.location || '';
    document.getElementById('editCategory').value = data.category || '';
    document.getElementById('editBrand').value = data.brand || '';
    document.getElementById('editArea').value = data.area || '';

    const desc = data.description || '';
    const plainDesc = desc.replace(/<\/?[^>]+(>|$)/g, '');
    document.getElementById('editDescription').value = plainDesc;

    // Cars/Bikes fields
    document.getElementById('editKmDriven').value = data.kmDriven || '';
    document.getElementById('editYearOfPurchase').value = data.yearOfPurchase || '';
    document.getElementById('editTyreCondition').value = data.tyreCondition || '';
    document.getElementById('editAccidentStatus').value = data.accidentStatus || '';
    document.getElementById('editAllPapersAvailable').value = data.allPapersAvailable || '';
    document.getElementById('editPollutionExpiry').value = data.pollutionExpiry || '';
    document.getElementById('editTaxExpiry').value = data.taxExpiry || '';
    document.getElementById('editInsuranceExpiry').value = data.insuranceExpiry || '';
    document.getElementById('editOwnership').value = data.ownership || '';

    // Properties fields
    document.getElementById('editPropertyType').value = data.propertyType || '';
    document.getElementById('editBhk').value = data.bhk || '';
    document.getElementById('editFurnishing').value = data.furnishing || '';
    document.getElementById('editPropertyArea').value = data.propertyArea || '';
    document.getElementById('editBedrooms').value = data.bedrooms || '';
    document.getElementById('editBathrooms').value = data.bathrooms || '';

    document.getElementById('editModal').style.display = 'block';
  } catch (error) {
    console.error('Error fetching ad to edit:', error);
    alert('Could not load ad data.');
  }
}

function closeEditModal() {
  document.getElementById('editModal').style.display = 'none';
  currentEditAdId = null;
}
function closeAdDetailsModal() {
  document.getElementById('adDetailsModal').style.display = 'none';
}


async function saveAdEdits() {
  if (!currentEditAdId) return;

  const updatedData = {
    title: document.getElementById('editTitle').value,
    price: parseFloat(document.getElementById('editPrice').value) || 0,
    location: document.getElementById('editLocation').value,
    category: document.getElementById('editCategory').value,
    brand: document.getElementById('editBrand').value,
    area: document.getElementById('editArea').value,
    description: document.getElementById('editDescription').value,

    // Cars/Bikes
    kmDriven: document.getElementById('editKmDriven').value,
    yearOfPurchase: document.getElementById('editYearOfPurchase').value,
    tyreCondition: document.getElementById('editTyreCondition').value,
    accidentStatus: document.getElementById('editAccidentStatus').value,
    allPapersAvailable: document.getElementById('editAllPapersAvailable').value,
    pollutionExpiry: document.getElementById('editPollutionExpiry').value,
    taxExpiry: document.getElementById('editTaxExpiry').value,
    insuranceExpiry: document.getElementById('editInsuranceExpiry').value,
    ownership: document.getElementById('editOwnership').value,

    // Properties
    propertyType: document.getElementById('editPropertyType').value,
    bhk: document.getElementById('editBhk').value,
    furnishing: document.getElementById('editFurnishing').value,
    propertyArea: document.getElementById('editPropertyArea').value,
    bedrooms: document.getElementById('editBedrooms').value,
    bathrooms: document.getElementById('editBathrooms').value
  };

  try {
    await db.collection('items').doc(currentEditAdId).update(updatedData);
    alert('Ad updated successfully.');
    closeEditModal();
    loadDashboard(); // or reload the ads list if needed
  } catch (err) {
    console.error('Error updating ad:', err);
    alert('Failed to update.');
  }
}

function deleteAd(adId) {
  if (!confirm('Delete this ad permanently?')) return;
  db.collection('items').doc(adId).delete()
    .then(() => {
      alert('Ad deleted.');
    })
    .catch(err => {
      console.error('Error deleting ad:', err);
      alert('Failed to delete.');
    });
}

    // ===== RENDER REPORTS =====
    function renderReports(reportDocs) {
      const container = document.getElementById('reportList');
      container.innerHTML = '';

      if (reportDocs.length === 0) {
        container.innerHTML = '<p>No reports found.</p>';
        return;
      }

      reportDocs.forEach(async reportDoc => {
        const report = reportDoc.data();
        const reporterId = report.userId || 'Unknown';
        const itemId     = report.itemId || 'Unknown';
        const reason = report.reason || 'No reason given';
        const fraudDetails = report.fraudDetails || {};
        const wrongInfo = fraudDetails.wrong || '';

        let adExists     = false;
        let adInfo       = '<span style="color:red;">Ad not found</span>';

        // Fetch the adâ€™s details (if it still exists)
        try {
          const adDoc = await db.collection('items').doc(itemId).get();
          if (adDoc.exists) {
            adExists = true;
            const ad       = adDoc.data();
            const imgUrl   = (ad.images && ad.images.length > 0) ? ad.images[0] : '';
            const imageTag = imgUrl
              ? `<img src="${imgUrl}" alt="Ad Image" style="max-width:80px; margin-top:8px; border-radius:6px;">`
              : '<span style="color:gray;">No image</span>';
            const desc      = ad.description || 'No description';
            const plainDesc = desc.replace(/<\/?[^>]+(>|$)/g, '');

            adInfo = `
              <strong>${ad.title || 'No Title'}</strong><br>
              â‚¹${ad.price || 'N/A'} | ${ad.location || 'Unknown'}<br>
              Category: ${ad.category || 'N/A'}<br>
              ${imageTag}<br>
              <em>${plainDesc.substring(0, 80)}${plainDesc.length > 80 ? 'â€¦' : ''}</em>
            `;
          }
        } catch (e) {
          console.error('Error loading ad for report:', e);
        }

        
        const div = document.createElement('div');
        div.className = 'list-item report-card';

        div.innerHTML = `
          <div style="flex:1;">
          <strong>Reported by:</strong> ${reporterId}<br>
          <div class="reason"><i class="fas fa-flag"></i> ${reason}</div>
          <strong>Ad ID:</strong> <span class="ad-id">${itemId}</span><br>
          <strong>Ad Info:</strong><br> ${adInfo}
          </div>
          <div>
            ${adExists
              ? `
                <!-- View Ad -->
          <button class="btn-view btn"onclick="viewAdDetails('${itemId}')">View Ad</button>
          <button class="reject-btn btn"onclick="rejectAd('${itemId}')">Reject Ad</button>
          <button class="delete-btn btn"onclick="deleteAd('${itemId}')">Delete Ad</button>`: ''}
          <button class="view-btn btn"onclick="resolveReport('${reportDoc.id}')">Resolve Report</button></div>`;
        container.appendChild(div);
      });
    }

    function resolveReport(reportId) {
  if (!confirm('Mark this report as resolved?')) return;
  db.collection('reports').doc(reportId).delete()
    .then(() => {
      alert('Report resolved and removed.');
    })
    .catch(err => {
      console.error('Error resolving report:', err);
      alert('Failed to resolve report.');
    });
}

    // ===== VIEW AD DETAILS =====
  async function viewAdDetails(adId) {
  try {
    const doc = await db.collection('items').doc(adId).get();
    if (!doc.exists) {
      alert('Ad not found.');
      return;
    }

    const data = doc.data();

    // ðŸ” Setup image carousel
    const wrapper = document.getElementById("adImageWrapper");
    const counter = document.getElementById("imageCounter");
    const images = data.images || [];

    wrapper.innerHTML = ''; 
    counter.textContent = ''; 

    if (images.length > 0) {
      images.forEach((url) => {
        const img = document.createElement('img');
        img.src = url;
        img.style.height = '200px';
        img.style.borderRadius = '10px';
        img.style.objectFit = 'contain';
        img.style.scrollSnapAlign = 'start';
        img.style.flexShrink = '0';
        img.style.cursor = 'pointer';
        img.style.maxWidth = '100%';
        img.onclick = () => openImageInFullScreen(url);
        wrapper.appendChild(img);
      });

      
      if (images.length > 1) {
        wrapper.addEventListener("scroll", () => {
          const childWidth = wrapper.firstChild?.offsetWidth || 1;
          const scrollLeft = wrapper.scrollLeft;
          const index = Math.round(scrollLeft / (childWidth + 8)) + 1;
          counter.textContent = `Image ${index} of ${images.length}`;
        });
        counter.textContent = `Image 1 of ${images.length}`;
      }
    } else {
      wrapper.innerHTML = '<p>No images available</p>';
    }

    
    document.getElementById('adTitle').innerText = data.title || 'No Title';
    document.getElementById('adPrice').innerText = data.price || '0';
    document.getElementById('adCategory').innerText = data.category || 'N/A';
    document.getElementById('adBrand').innerText = data.brand || 'N/A';
    document.getElementById('adLocation').innerText = data.location || 'Unknown';
    document.getElementById('adArea').innerText = data.area || 'N/A';

    const rawDesc = data.description || '';
    const plainDesc = rawDesc.replace(/<\/?[^>]+(>|$)/g, '');
    document.getElementById('adDescription').innerText = plainDesc;

    
    const extraFields = document.getElementById('extraFields');
    extraFields.innerHTML = '';

    function addField(label, value) {
      if (value) {
        extraFields.innerHTML += `<p><strong>${label}:</strong> ${value}</p>`;
      }
    }

    if (data.category === "Cars" || data.category === "Bikes") {
      addField("KM Driven", data.kmDriven);
      addField("Year of Purchase", data.yearOfPurchase);
      addField("Tyre Condition", data.tyreCondition);
      addField("Accident History", data.accidentStatus);
      addField("All Papers Available", data.allPapersAvailable);
      addField("Pollution Expiry", data.pollutionExpiry);
      addField("Tax Expiry", data.taxExpiry);
      addField("Insurance Expiry", data.insuranceExpiry);
      addField("Ownership", data.ownership);
    }

    if (data.category === "Properties") {
      addField("Property Type", data.propertyType);
      addField("BHK", data.bhk);
      addField("Furnishing", data.furnishing);
      addField("Area (sq ft)", data.propertyArea);
      addField("Bedrooms", data.bedrooms);
      addField("Bathrooms", data.bathrooms);
    }

    document.getElementById('adDetailsModal').style.display = 'block';

  } catch (err) {
    console.error('Error fetching ad details:', err);
    alert('Failed to load ad details.');
  }
}

function closeAdDetailsModal() {
  document.getElementById('adDetailsModal').style.display = 'none';
}

function openImageInFullScreen(url) {
  const modal = document.getElementById("boostImageModal");
  const img = document.getElementById("boostImageLarge");
  img.src = url;
  modal.style.display = "flex";
}


    // ===== RENDER ALL USERâ†”USER CHATS =====
async function renderAllChats(chatDocs) {
  const chatListContainer = document.getElementById('chatList');
  chatListContainer.innerHTML = '';
  let any = false;

  for (const doc of chatDocs) {
    const chat   = doc.data();
    const chatId = doc.id;
    const users  = chat.users || [];

    // only 2-person chats and neither may be "admin" or null
    if (
      users.length !== 2 ||
      users.includes('admin') ||
      users.includes(null) ||
      users.includes(undefined)
    ) {
      continue;
    }
    any = true;

    // fetch both user profiles to get their emails
    const userDocs = await Promise.all(
      users.map(uid => db.collection('users').doc(uid).get())
    );

    // build a single UID+email block per user
    const blocks = userDocs.map((uDoc, i) => {
      const uid   = users[i];
      const email = uDoc.exists ? uDoc.data().email : 'â€”';
      return `
        <code>${uid}</code><br/>
        <small class="chat-email" onclick="viewUserAds('${uid}')">${email}</small>
      `;
    });

    const div = document.createElement('div');
    div.className = 'list-item';
    div.innerHTML = `
  <div>
    <strong>Chats between:</strong><br/>
    <span style="display:inline-block; margin-right:24px; text-align:left;">
      ${blocks[0]}
    </span>
     &amp; 
    <span style="display:inline-block; margin-left:24px; text-align:left;">
      ${blocks[1]}
    </span>
  </div>
  <div>
    <button class="view-btn btn" onclick="viewMessagesModal('${chatId}')">
      View
    </button>
  </div>
`;

    chatListContainer.appendChild(div);
  }

  if (!any) {
    chatListContainer.innerHTML = '<p>No user-to-user chats found.</p>';
  }
}

    // ===== VIEW CHAT MESSAGES MODAL =====
    async function viewMessagesModal(chatId) {
  try {
    // 1) Load chat & participant UIDs
    const chatDoc = await db.collection('chats').doc(chatId).get();
    const userIds = chatDoc.data()?.users || [];

    // 2) Fetch emails
    const userDocs = await Promise.all(
      userIds.map(uid => db.collection('users').doc(uid).get())
    );
    const emailByUid = {};
    userDocs.forEach((doc, i) => {
      emailByUid[userIds[i]] = doc.exists ? doc.data().email : 'â€”';
    });

    // 3) Header (UID + email)
    const header = document.querySelector('#messageModal .modal-content h3');
    const headerBlocks = userIds.map(uid => {
      const email = emailByUid[uid] || 'â€”';
      return `
        <div style="display:inline-block; vertical-align:top; margin-right:16px; text-align:left;">
          <code>${uid}</code><br/>
          <small class="chat-email">${email}</small>
        </div>
      `;
    });
    header.innerHTML = `Chat between:<br/>${headerBlocks.join('&nbsp;&nbsp;&amp;&nbsp;&nbsp;')}`;

    const msgsSnap = await db
      .collection('chats').doc(chatId)
      .collection('messages')
      .orderBy('timestamp')
      .get();

    const container = document.getElementById('messageContent');
    container.innerHTML = '';
    const currentUid = firebase.auth().currentUser.uid;

    msgsSnap.forEach(doc => {
      const msg = doc.data();
      // determine sender UID
      const uid = msg.sender   ||
                  msg.senderId ||
                  msg.userId   ||
                  msg.uid      ||
                  msg.from     ||
                  'unknown-uid';
      const senderEmail = emailByUid[uid] || uid;
      const isSent = uid === currentUid;
      const time = msg.timestamp
        ? msg.timestamp.toDate().toLocaleTimeString([], { hour:'2-digit', minute:'2-digit' })
        : '';

      
      const bubble = document.createElement('div');
      bubble.classList.add('chat-message', isSent ? 'sent' : 'received');

      // build inner HTML: always show sender, then either image or text
      let inner = `
        <div class="sender">${senderEmail}</div>
      `;
      if (msg.imageUrl) {
        inner += `<img src="${msg.imageUrl}" alt="chat image"/>`;
        if (msg.text) {
          inner += `<div class="text">${msg.text}</div>`;
        }
      } else {
        inner += `<div class="text">${msg.text || ''}</div>`;
      }
      inner += `<div class="time">${time}</div>`;

      bubble.innerHTML = inner;
      container.appendChild(bubble);
    });

    
    document.getElementById('messageModal').style.display = 'block';
  } catch (err) {
    console.error('Error loading messages:', err);
    alert('Failed to load chat messages.');
  }
}

function closeMessageModal() {
      document.getElementById('messageModal').style.display = 'none';
      document.getElementById('messageContent').innerHTML = '';
    }


// ===== Approve Reject Payment Tab switch =====

function showPaymentsTab(tabName) {
  document.getElementById('approvedTabBtn').classList.remove('active');
  document.getElementById('rejectedTabBtn').classList.remove('active');
  document.getElementById('approvedPaymentsList').style.display = 'none';
  document.getElementById('rejectedPaymentsList').style.display = 'none';

  if (tabName === 'approved') {
    document.getElementById('approvedTabBtn').classList.add('active');
    document.getElementById('approvedPaymentsList').style.display = 'block';
  } else {
    document.getElementById('rejectedTabBtn').classList.add('active');
    document.getElementById('rejectedPaymentsList').style.display = 'block';
  }
}

// ===================== Notices Module (file-upload version) =====================

(function(){
  // ---- tiny helpers ----
  const $ = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => [...root.querySelectorAll(sel)];
  const escapeHTML = s => String(s ?? '')
    .replace(/&/g,'&amp;').replace(/</g,'&lt;')
    .replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');

  // ---- state ----
  let __savingNotice = false;

  // ---- build one notice row ----
  function rowHTML(id, data){
    const safeText = escapeHTML(data.text || '');
    const img = data.imageUrl ? `<img src="${escapeHTML(data.imageUrl)}" alt="Notice Image" style="max-width:100%;border-radius:8px;margin-top:6px;">` : '';
    const statusChip = data.active ? 'Active' : 'Inactive';
    const statusCls  = data.active ? 'status-active' : 'status-inactive';

    return `
      <div class="notice-item ${statusCls}" data-notice-id="${id}" style="border:1px solid #e5e7eb;border-radius:10px;padding:10px;background:#fff;margin-bottom:10px;">
        <div class="notice-header" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
          <span class="status-indicator" style="font-size:12px;padding:2px 8px;border-radius:999px;background:${data.active ? '#dcfce7' : '#eef2ff'}">${statusChip}</span>
          <label style="display:flex;gap:6px;align-items:center;font-size:12px;">
            <input type="checkbox" class="notice-toggle" ${data.active ? 'checked' : ''}>
            <span>Active</span>
          </label>
        </div>
        <div class="notice-body" style="white-space:pre-wrap;margin:6px 0;">${safeText}</div>
        ${img}
        <div class="notice-actions" style="display:flex;gap:8px;margin-top:8px;">
          <button class="btn edit-btn" style="padding:8px 10px;border:1px solid #ddd;border-radius:8px;background:#f9fafb;cursor:pointer;">
            <i class="fa fa-pen"></i> Edit
          </button>
          <button class="btn del-btn" style="padding:8px 10px;border:1px solid #ddd;border-radius:8px;background:#f9fafb;cursor:pointer;">
            <i class="fa fa-trash"></i> Delete
          </button>
        </div>
      </div>
    `;
  }

  // ---- overlay (optional; safe no-op if not defined) ----
  const overlayOn  = (el)=>{ try{ window._overlayOn && window._overlayOn(el); }catch{} };
  const overlayOff = (el)=>{ try{ window._overlayOff && window._overlayOff(el); }catch{} };

  // ---- load all notices ----
  async function loadNotices(){
    const tab  = $('#noticesTab');
    const list = $('#noticesList');
    if (!list) return;

    overlayOn(tab);
    list.innerHTML = '<p>Loadingâ€¦</p>';

    try{
      const snap = await db.collection('notices')
        .orderBy('timestamp','desc')
        .get();

      if (snap.empty){
        list.innerHTML = '<p>No notices found.</p>';
        return;
      }
      let html = '';
      snap.forEach(doc => { html += rowHTML(doc.id, doc.data() || {}); });
      list.innerHTML = html;
    }catch(err){
      console.error('Error loading notices:', err);
      list.innerHTML = '<p>Failed to load notices.</p>';
    }finally{
      overlayOff(tab);
    }
  }

  // ---- upload helper (Storage). Returns downloadURL or '' ----
  async function uploadImageFileIfAny(file){
    if (!file) return '';
    const safeName = file.name.replace(/[^\w.\-]/g,'_');
    const path = `notices/${Date.now()}_${safeName}`;
    const ref = firebase.storage().ref(path);
    const snap = await ref.put(file);
    return await snap.ref.getDownloadURL();
  }

  // ---- create/save new notice ----
  async function saveNotice(){
    if (__savingNotice) return;
    __savingNotice = true;

    const btn = $('#saveNoticeBtn');
    const oldHtml = btn ? btn.innerHTML : '';

    const textEl = $('#noticeText');
    const fileEl = $('#noticeImageFile');
    const actEl  = $('#noticeActive');

    const text   = (textEl?.value || '').trim();
    const active = !!actEl?.checked;
    const file   = fileEl?.files?.[0] || null;

    if (!text && !file){
      alert('Please enter notice text or upload an image.');
      __savingNotice = false; return;
    }

    try{
      if (btn){ btn.disabled = true; btn.innerHTML = '<i class="fa fa-rotate fa-spin"></i> Savingâ€¦'; }

      let imageUrl = '';
      if (file) imageUrl = await uploadImageFileIfAny(file);

      await db.collection('notices').add({
        text,
        imageUrl,
        active,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });

      // reset form
      if (textEl) textEl.value = '';
      if (fileEl) fileEl.value = '';
      if (actEl)  actEl.checked = true;

      await loadNotices();
      alert('Notice saved.');
    }catch(err){
      console.error('Error saving notice:', err);
      alert('Failed to save notice.');
    }finally{
      if (btn){ btn.disabled = false; btn.innerHTML = oldHtml || 'Save Notice'; }
      __savingNotice = false;
    }
  }

  // ---- edit (populate form + one-time update handler) ----
  async function editNotice(noticeId){
    try{
      const doc = await db.collection('notices').doc(noticeId).get();
      if (!doc.exists){ alert('Notice not found.'); return; }
      const data = doc.data() || {};

      // populate form
      $('#noticeText').value = data.text || '';
      $('#noticeActive').checked = !!data.active;
      const fileEl = $('#noticeImageFile'); if (fileEl) fileEl.value = ''; // clear file chooser

      const btn = $('#saveNoticeBtn');
      const originalLabel = btn.textContent;
      btn.textContent = 'Update Notice';

      // clear old handler then attach one-time update handler
      btn.onclick = async () => {
        const newText = ($('#noticeText')?.value || '').trim();
        const newAct  = !!$('#noticeActive')?.checked;
        const newFile = $('#noticeImageFile')?.files?.[0] || null;

        if (!newText && !newFile && !data.imageUrl){
          alert('Please enter text or upload image.'); return;
        }

        try{
          btn.disabled = true; btn.innerHTML = '<i class="fa fa-rotate fa-spin"></i> Updatingâ€¦';

          let imageUrl = data.imageUrl || '';
          if (newFile){
            imageUrl = await uploadImageFileIfAny(newFile);
          }

          await db.collection('notices').doc(noticeId).update({
            text: newText || '',
            imageUrl: imageUrl,
            active: newAct,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
          });

          // reset form & button
          $('#noticeText').value = '';
          if (fileEl) fileEl.value = '';
          $('#noticeActive').checked = true;

          btn.textContent = originalLabel || 'Save Notice';
          btn.onclick = saveNotice; // back to create mode

          await loadNotices();
          alert('Notice updated.');
        }catch(e){
          console.error('Error updating notice:', e);
          alert('Failed to update notice.');
        }finally{
          btn.disabled = false; btn.innerHTML = btn.innerHTML.includes('Updating') ? (originalLabel || 'Save Notice') : btn.innerHTML;
        }
      };
    }catch(err){
      console.error('Error fetching notice:', err);
      alert('Could not load notice for editing.');
    }
  }

  // ---- delete ----
  async function deleteNotice(noticeId){
    if (!noticeId) return;
    if (!confirm('Delete this notice permanently?')) return;

    try{
      await db.collection('notices').doc(noticeId).delete();

      // optimistic DOM removal
      const row = document.querySelector(`.notice-item[data-notice-id="${noticeId}"]`);
      if (row) row.remove();

      await loadNotices();
    }catch(err){
      console.error('Error deleting notice:', err);
      alert('Failed to delete notice.');
    }
  }

  // ---- list actions (delegation) ----
  document.addEventListener('click', (e)=>{
    const row = e.target.closest('.notice-item');
    if (row && e.target.closest('.del-btn')){
      deleteNotice(row.getAttribute('data-notice-id'));
      return;
    }
    if (row && e.target.closest('.edit-btn')){
      editNotice(row.getAttribute('data-notice-id'));
      return;
    }
  });

  // active toggle
  document.addEventListener('change', (e)=>{
    const toggle = e.target.closest('.notice-toggle');
    if (!toggle) return;
    const row = e.target.closest('.notice-item');
    const id  = row?.getAttribute('data-notice-id');
    const active = !!toggle.checked;
    if (!id) return;
    db.collection('notices').doc(id).update({active}).catch(err=>{
      console.error('Toggle active failed:', err);
      toggle.checked = !active;
      alert('Failed to update status.');
    });
  });

  // ---- bind + initial load when tab first opens ----
  document.addEventListener('DOMContentLoaded', ()=>{
    const saveBtn = $('#saveNoticeBtn');
    if (saveBtn) saveBtn.onclick = saveNotice;

    // If this tab is visible on first load, fetch; warna refreshTab se aayega
    if ($('#noticesTab')?.style.display !== 'none') {
      loadNotices();
    }
  }, {once:true});

  // ---- hook into your refresh system ----
  window.__tabReloaders = window.__tabReloaders || {};
  window.__tabReloaders['noticesTab'] = () => loadNotices();

  // ---- expose a minimal API (optional) ----
  window.loadNotices = loadNotices;
  window.editNotice  = editNotice;
  window.deleteNotice= deleteNotice;

})(); // IIFE end

// =================== End Notices Module ====================
    

    // ===== INITIALIZATION ON DOM CONTENT LOADED =====
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('liveChatSendBtn').addEventListener('click', sendLiveAdminReply);

      const liveInput = document.getElementById('liveChatInput');
      if (liveInput) {
        liveInput.addEventListener('focus', function() {
          this.value = '';
        });
      }

     document.getElementById('saveNoticeBtn').onclick = async () => {
     const text = document.getElementById('noticeText').value.trim();
     const fileInput = document.getElementById('noticeImageFile');
     const isActive = document.getElementById('noticeActive').checked;

  if (!text && fileInput.files.length === 0) {
    alert('Please enter notice text or select an image.');
    return;
  }

  let imageUrl = '';

  if (fileInput.files.length > 0) {
    const file = fileInput.files[0];
    const fileName = `notices/${Date.now()}_${file.name}`;
    const storageRef = firebase.storage().ref(fileName);
    const snapshot = await storageRef.put(file);
    imageUrl = await snapshot.ref.getDownloadURL();
  }

  try {
    await db.collection('notices').add({
      text: text,
      imageUrl: imageUrl,
      active: isActive,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });

    document.getElementById('noticeText').value = '';
    fileInput.value = '';
    document.getElementById('noticeActive').checked = true;
    loadNotices();
    alert('Notice saved.');
  } catch (err) {
    console.error('Error saving notice:', err);
    alert('Failed to save notice.');
  }
};
      loadDashboard();
    });


// ======= Ads Status Tabs Filter (NEW) =======
const adsTabs = document.querySelectorAll('.ads-tab-btn');
if (adsTabs.length) {
  adsTabs.forEach(btn => {
    btn.addEventListener('click', function () {
      adsTabs.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      const status = btn.getAttribute('data-status');
      // allAdDocsCache aapka renderAllAds me maintain ho raha hai!
      renderAllAds(allAdDocsCache, status);
    });
  });
}


async function viewUserAds(uid) {
  try {
    
    const userDoc = await db.collection('users').doc(uid).get();
    const email   = userDoc.exists ? userDoc.data().email : 'Unknown';

    
    document.getElementById('modalUserId').innerText    = uid;
    document.getElementById('modalUserEmail').innerText = email;

    // 3) Fetch all ads where data.userId == uid
    const adsSnap = await db
      .collection('items')
      .where('userId', '==', uid)
      .get();
    document.getElementById('totalAdsCount').innerText = adsSnap.size;

   
    // 4) Render each adâ€™s basic info (with image)
const list = document.getElementById('userAdsList');
list.innerHTML = '';

adsSnap.forEach(doc => {
  const data = doc.data();
  const imgUrl = (data.images && data.images.length > 0) ? data.images[0] : null;
  const status = data.status || 'N/A';

  const div = document.createElement('div');
  div.className = 'user-ad-item';

  div.innerHTML = `
    <img src="${imgUrl || 'https://via.placeholder.com/44?text=No+Image'}" alt="Ad">

    <div class="user-ad-info">
      <div class="user-ad-title">
        ${data.title || 'No Title'} â€” â‚¹${Number(data.price || 0).toLocaleString('en-IN')}
      </div>
      <span class="user-status-badge status-${status}">
        ${status.charAt(0).toUpperCase() + status.slice(1)}
      </span>
      <div class="user-ad-meta">
        ${data.category || 'N/A'} | ${data.location || 'Unknown'}
      </div>
      <div class="user-ad-id">ID: <code>${doc.id}</code></div>
      ${status === 'rejected'
  ? `<div class="user-ad-reason"><strong>Reason:</strong> ${getItemRejectReason(data)}</div>`
  : ''}

    </div>
  `;

  list.appendChild(div);
});





    // 5) Show the modal
    document.getElementById('userAdsModal').style.display = 'block';
  } catch (err) {
    console.error('Error loading user ads:', err);
    alert('Failed to load ads for this user.');
  }
}

function closeUserAdsModal() {
  document.getElementById('userAdsModal').style.display = 'none';
}

// Track selected ads
let selectedAdIds = [];

function updateBulkBar() {
  const checkboxes = document.querySelectorAll('.ad-select-checkbox');
  selectedAdIds = Array.from(checkboxes).filter(chk => chk.checked).map(chk => chk.getAttribute('data-adid'));
  // Enable/Disable bulk buttons
  document.getElementById('bulkApproveBtn').disabled = selectedAdIds.length === 0;
  document.getElementById('bulkRejectBtn').disabled  = selectedAdIds.length === 0;
  document.getElementById('bulkDeleteBtn').disabled  = selectedAdIds.length === 0;
  document.getElementById('bulkSelectedCount').textContent = selectedAdIds.length > 0 ? `${selectedAdIds.length} selected` : '';
}

document.addEventListener('change', function (e) {
  if (e.target.classList.contains('ad-select-checkbox')) updateBulkBar();
  if (e.target.id === 'selectAllAds') {
    document.querySelectorAll('.ad-select-checkbox').forEach(chk => chk.checked = e.target.checked);
    updateBulkBar();
  }
});

// Whenever ads re-render, reset checkboxes & select-all
function afterAdsRender() {
  document.getElementById('selectAllAds').checked = false;
  updateBulkBar();
  // (If you want: scroll to top, etc)
}

// Call after renderAllAds() each time!
document.getElementById('bulkApproveBtn').onclick = async function() {
  if (!selectedAdIds.length || !confirm(`Approve ${selectedAdIds.length} ads?`)) return;
  try {
    for (let id of selectedAdIds) {
      await db.collection('items').doc(id).update({ status: 'approved' });
    }
    alert('Selected ads approved.');
  } catch (err) {
    alert('Bulk approval failed.');
    console.error(err);
  }
};
document.getElementById('bulkRejectBtn').onclick = async function() {
  if (!selectedAdIds.length || !confirm(`Reject ${selectedAdIds.length} ads?`)) return;
  try {
    for (let id of selectedAdIds) {
      await db.collection('items').doc(id).update({ status: 'rejected' });
    }
    alert('Selected ads rejected.');
  } catch (err) {
    alert('Bulk reject failed.');
    console.error(err);
  }
};
document.getElementById('bulkDeleteBtn').onclick = async function() {
  if (!selectedAdIds.length || !confirm(`Delete ${selectedAdIds.length} ads?`)) return;
  try {
    for (let id of selectedAdIds) {
      await db.collection('items').doc(id).delete();
    }
    alert('Selected ads deleted.');
  } catch (err) {
    alert('Bulk delete failed.');
    console.error(err);
  }
};

async function loadBoostRequests() {
  const snap = await db.collection('boostRequests')
    .where('status', '==', 'pending')
    .orderBy('timestamp', 'desc')
    .limit(30)
    .get();

  let html = `<table style="width:100%; border-collapse:collapse; font-size:13px; margin-top:10px;">
    <thead style="background:#f9f9f9;">
      <tr style="border-bottom:1px solid #ccc;">
        <th style="padding:6px;">#</th>
        <th style="padding:6px;">User</th>
        <th style="padding:6px;">Ad</th>
        <th style="padding:6px;">Plan</th>
        <th style="padding:6px;">Amt</th>
        <th style="padding:6px;">Date</th>
        <th style="padding:6px;">Trans ID</th>
        <th style="padding:6px;">SS</th>
        <th style="padding:6px;">Action</th>
      </tr>
    </thead>
    <tbody>`;

  let count = 0;
  snap.forEach(doc => {
    const d = doc.data();
    const dateStr = d.timestamp ? d.timestamp.toDate().toLocaleString() : '-';
    count++;
    html += `<tr style="border-bottom:1px solid #eee;">
      <td style="padding:5px;">${count}</td>
      <td style="padding:5px;">${d.userId || '-'}</td>
      <td style="padding:5px;">${d.adId || '-'}</td>
      <td style="padding:5px;">${d.plan || '-'}</td>
      <td style="padding:5px;">â‚¹${d.amount || '-'}</td>
      <td style="padding:5px;">${dateStr}</td>
      <td style="padding:5px;">${d.paymentId || '-'}</td>
      <td style="padding:5px;">
        ${d.screenshot ? `<img src="${d.screenshot}" height="50" style="cursor:pointer;" onclick="enlargeBoostImage('${d.screenshot}')">` : 'â€”'}
      </td>
      <td style="padding:5px;">
  <button onclick="confirmApproveBoost('${doc.id}', '${d.adId}', '${d.userId}')" style="padding:6px 10px;font-size:13px;background:#4caf50;color:#fff;border:none;border-radius:4px;">Approve</button>
  <button onclick="openBoostRejectModal('${doc.id}', '${d.userId}')" style="padding:6px 10px;font-size:13px;background:#e53935;color:#fff;border:none;border-radius:4px;margin-left:6px;">Reject</button>

</td>

    </tr>`;
  });

  html += '</tbody></table>';
  document.getElementById('boostRequestsList').innerHTML = html;
}

function confirmApproveBoost(docId, adId, userId) {
  if (confirm("Are you sure you want to approve this boost request?")) {
    approveBoost(docId, adId, userId);
  }
}

function confirmRejectBoost(docId) {
  if (confirm("Are you sure you want to reject this boost request?")) {
    rejectBoost(docId);
  }
}

// Approve new boost request (admin panel)
async function approveBoost(requestId, adId, userId, screenshotUrl = '') {
  try {
    const doc = await db.collection('boostRequests').doc(requestId).get();
    if (!doc.exists) return alert('Request not found!');
    const data = doc.data();

    // Mark request approved
    await db.collection('boostRequests').doc(requestId).update({
      status: 'approved',
      approvedAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    const now = Date.now();

    // ðŸ”¹ Plan days
    let days = 3;
    if (String(data.plan).includes('15')) days = 15;
    if (String(data.plan).includes('30')) days = 30;

    const expiry = now + days * 24 * 60 * 60 * 1000;

    // âœ… Build boost snapshot
    const boostSnapshot = {
      active: true,
      plan: data.plan || '',
      planDays: days,
      amount: data.amount || 0,
      mode: data.mode || 'manual',
      provider: data.provider || 'admin',
      orderId: data.orderId || ('BOOST-' + requestId),

      activatedAt: firebase.firestore.FieldValue.serverTimestamp(),
      startAt: now,
      endAt: expiry,

      // bump-related fields
      lastBumpedAt: now,
      nextBumpAt: now + 24 * 60 * 60 * 1000,
      bumpsDoneToday: 0,
      bumpCount: 0,
      bumpsPerDay: 1,
      maxBumps: 0,
      boostRestoredOnce: false
    };

    // ðŸ”¹ Update item â†’ force featured true + expiry intact
    await db.collection('items').doc(adId).update({
      boost: boostSnapshot,
      featured: true,
      featuredExpiry: expiry,
      premiumTag: true,
      boostStatus: 'active',
      isActive: true,
      status: 'approved',
      visibility: 'public'
    });

    // ðŸ”¹ Discount check
    if (data.amount == 5) {
      await db.collection('users').doc(userId).set(
        { discountBoostUsed: true },
        { merge: true }
      );
    }

    // ðŸ”¹ Save payment log
    await db.collection('payments').add({
      thumb: screenshotUrl,
      userId,
      adId,
      amount: data.amount || 0,
      plan: data.plan || '',
      paymentId: 'BOOST-' + requestId,
      status: 'success',
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });

    alert("âœ… Boost approved & snapshot set!");
  } catch (err) {
    alert('Failed to approve boost.');
    console.error(err);
  }
}



// Resume paused boost (after edit approval by admin)
async function resumeBoostAfterApproval(adId, oldBoost) {
  if (!oldBoost || !oldBoost.plan) {
    console.warn("âš ï¸ No old boost snapshot found, skipping resume.");
    return;
  }

  const now = Date.now();

  // ðŸ”¹ Restore old snapshot with active flag
  const boostSnapshot = {
    ...oldBoost,
    active: true,
    boostRestoredOnce: true,
    lastBumpedAt: now,
    nextBumpAt: now + 24 * 60 * 60 * 1000
  };

  // ðŸ”¹ Firestore update (featured always true, expiry intact)
  await db.collection('items').doc(adId).update({
    boost: boostSnapshot,
    featured: true,
    featuredExpiry: boostSnapshot.endAt,
    premiumTag: true,
    boostStatus: 'active',
    isActive: true,
    status: 'approved',
    visibility: 'public',
    boostReview: firebase.firestore.FieldValue.delete()
  });

  console.log("âœ… Boost resumed for", adId, "till", new Date(boostSnapshot.endAt).toLocaleString());
}


function loadUserReports() {
  const list = document.getElementById("userReportsList");
  list.innerHTML = "<p>Loading user reports...</p>";

  firebase.firestore().collection("userReports")
    .orderBy("timestamp", "desc")
    .get()
    .then(snapshot => {
      if (snapshot.empty) {
        list.innerHTML = "<p>No reports found.</p>";
        return;
      }

      list.innerHTML = "";
      snapshot.forEach(doc => {
        const data = doc.data();
        const html = `
          <div class="report-card">
            <div>
              <p><strong>${data.reportType || 'General Report'}</strong></p>
              <p class="reason">${data.message || ''}</p>
              <small><b>User:</b> ${data.userEmail || 'N/A'}</small><br>
              <small><b>Date:</b> ${new Date(data.timestamp?.toDate?.() || Date.now()).toLocaleString()}</small>
            </div>
            <div>
              <button class="delete-btn" onclick="deleteUserReport('${doc.id}')">Delete</button>
            </div>
          </div>`;
        list.innerHTML += html;
      });
    })
    .catch(err => {
      list.innerHTML = `<p style='color:red'>Error: ${err.message}</p>`;
    });
}

function deleteUserReport(id) {
  if (confirm("Delete this report?")) {
    firebase.firestore().collection("userReports").doc(id).delete()
      .then(() => {
        alert("Deleted");
        loadUserReports();
      })
      .catch(err => alert("Error deleting: " + err.message));
  }
}



// Reject boost
async function rejectBoost(requestId) {
  try {
    await db.collection('boostRequests').doc(requestId).update({
      status: 'rejected',
      rejectedAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    alert("Boost rejected.");
  } catch (err) {
    alert("Failed to reject boost.");
    console.error(err);
  }
}



// Call this when admin tab loads:
if (window.location.hash.includes('boostRequestsTab')) {
  loadBoostRequests();
}

// Or, sidebar tab click par:
document.querySelector('[data-tab="boostRequestsTab"]').addEventListener('click', function(){
  document.querySelectorAll('.tab-content').forEach(t => t.style.display = 'none');
  document.getElementById('boostRequestsTab').style.display = 'block';
  loadBoostRequests();
});

// Enlarge image function
function enlargeBoostImage(url) {
  document.getElementById('boostImageLarge').src = url;
  document.getElementById('boostImageModal').style.display = 'flex';
}

// Hide modal on click outside image
document.getElementById('boostImageModal').onclick = function(e) {
  if (e.target === this) this.style.display = 'none';
};

window.currentRejectAdId = window.currentRejectAdId ?? null;
const currentRejectAdIdGetter = () => window.currentRejectAdId;
const currentRejectAdIdSetter = (v) => { window.currentRejectAdId = v; };




function showReportSection(section) {
  document.getElementById('activeReportsSection').style.display = section === 'active' ? 'block' : 'none';
  document.getElementById('historyReportsSection').style.display = section === 'history' ? 'block' : 'none';

  document.getElementById('tabActiveBtn').style.backgroundColor = section === 'active' ? '#d9efff' : '#f1f1f1';
  document.getElementById('tabHistoryBtn').style.backgroundColor = section === 'history' ? '#d9efff' : '#f1f1f1';

  // âœ… this must trigger
  if (section === 'history') {
    loadReportHistory();
  }
}


async function loadReportHistory() {
  const container = document.getElementById('reportHistoryList');
  container.innerHTML = 'Loading...';

  const snap = await db.collection('reportHistory')
    .orderBy('resolvedAt', 'desc').where('resolvedAt', '!=', null)

    .limit(30)
    .get();

  console.log("History reports found:", snap.size);

  let html = '';
  snap.forEach(doc => {
    const r = doc.data();
    console.log("Resolved report:", r); // âœ… DEBUG
    html += `
      <div class="report-card" style="background:#f9f9f9; border-left:4px solid green; padding:12px; margin-bottom:10px; border-radius:8px;">
        <strong>Ad ID:</strong> ${r.adId}<br>
        <strong>Reported by:</strong> ${r.reporterId}<br>
        <strong>Reason:</strong> ${r.reason}<br>
        <small style="color:#666;">Resolved: ${r.resolvedAt?.toDate().toLocaleString() || ''}</small>
      </div>
    `;
  });

  container.innerHTML = html || `<p style="color:#777;">No resolved reports found.</p>`;
}


  </script>
<script>
let fullChartInstance;

function updateFullDashboardChart() {
  const range = document.getElementById('dateRange').value;
  const chartType = document.getElementById('chartType').value;
  const startInput = document.getElementById('startDate');
  const endInput = document.getElementById('endDate');

  if (range === 'custom') {
    startInput.style.display = 'inline-block';
    endInput.style.display = 'inline-block';
    return;
  } else {
    startInput.style.display = 'none';
    endInput.style.display = 'none';
  }

  const endDate = new Date();
  const startDate = new Date();
  startDate.setDate(endDate.getDate() - parseInt(range));
  fetchFullDashboardData(startDate, endDate, chartType);
}

async function fetchFullDashboardData(startDate, endDate, type = 'bar') {
  const labels = {};
  const format = d => d.toISOString().split('T')[0];

  // Prepare map for date range
  for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
    labels[format(new Date(d))] = {
      ads: 0, pending: 0, approved: 0, rejected: 0,
      users: 0, reports: 0, amount: 0
    };
  }

  // Fetch & aggregate
  const [adsSnap, usersSnap, reportsSnap, paymentsSnap] = await Promise.all([
    db.collection('items').where('timestamp', '>=', firebase.firestore.Timestamp.fromDate(startDate)).where('timestamp', '<=', firebase.firestore.Timestamp.fromDate(endDate)).get(),
    db.collection('users').where('createdAt', '>=', firebase.firestore.Timestamp.fromDate(startDate)).where('createdAt', '<=', firebase.firestore.Timestamp.fromDate(endDate)).get(),
    db.collection('reports').where('timestamp', '>=', firebase.firestore.Timestamp.fromDate(startDate)).where('timestamp', '<=', firebase.firestore.Timestamp.fromDate(endDate)).get(),
    db.collection('payments').where('timestamp', '>=', firebase.firestore.Timestamp.fromDate(startDate)).where('timestamp', '<=', firebase.firestore.Timestamp.fromDate(endDate)).get()
  ]);

  // Ads
  adsSnap.forEach(doc => {
    const data = doc.data();
    const dateKey = format(data.timestamp.toDate());
    labels[dateKey].ads++;
    labels[dateKey][data.status || 'pending']++;
  });

  // Users
  usersSnap.forEach(doc => {
    const dateKey = format(doc.data().createdAt?.toDate?.() || new Date());
    if (labels[dateKey]) labels[dateKey].users++;
  });

  // Reports
  reportsSnap.forEach(doc => {
    const dateKey = format(doc.data().timestamp?.toDate?.() || new Date());
    if (labels[dateKey]) labels[dateKey].reports++;
  });

  // Payments
  paymentsSnap.forEach(doc => {
    const data = doc.data();
    const dateKey = format(data.timestamp?.toDate?.() || new Date());
    if (labels[dateKey]) labels[dateKey].amount += Number(data.amount || 0);
  });

  const sortedKeys = Object.keys(labels).sort();

  const datasets = [
    { label: 'Ads', field: 'ads', color: '#007bff' },
    { label: 'Approved', field: 'approved', color: '#28a745' },
    { label: 'Pending', field: 'pending', color: '#ffc107' },
    { label: 'Rejected', field: 'rejected', color: '#dc3545' },
    { label: 'Users', field: 'users', color: '#6f42c1' },
    { label: 'Reports', field: 'reports', color: '#fd7e14' },
    { label: 'Amount Received (â‚¹)', field: 'amount', color: '#17a2b8' }
  ];

  const chartData = {
    labels: sortedKeys,
    datasets: datasets.map(ds => ({
      label: ds.label,
      data: sortedKeys.map(k => labels[k][ds.field]),
      borderColor: ds.color,
      backgroundColor: ds.color + (type === 'bar' ? '88' : ''),
      fill: false,
      tension: 0.3
    }))
  };

  // Save for export
  window.fullDashboardExport = sortedKeys.map(k => ({
    date: k,
    ...labels[k]
  }));

  renderFullChart(chartData, type);
}

function renderFullChart(chartData, type) {
  const ctx = document.getElementById('fullDashboardChart').getContext('2d');
  if (fullChartInstance) fullChartInstance.destroy();

  fullChartInstance = new Chart(ctx, {
    type,
    data: chartData,
    options: {
      responsive: true,
      plugins: {
        title: {
          display: true,
          text: 'ðŸ“ˆ Complete Analytics Overview',
          font: { size: 18 }
        },
        legend: {
          position: 'bottom'
        }
      },
      interaction: {
        mode: 'index',
        intersect: false
      },
      scales: {
        x: { title: { display: true, text: 'Date' } },
        y: { title: { display: true, text: 'Count / â‚¹ Amount' }, beginAtZero: true }
      }
    }
  });
}

function downloadFullReportCSV() {
  const data = window.fullDashboardExport || [];
  if (!data.length) return alert("No data to export");

  const headers = ['Date', 'Ads', 'Pending', 'Approved', 'Rejected', 'Users', 'Reports', 'Amount'];
  let csv = headers.join(',') + '\n';
  data.forEach(row => {
    csv += `${row.date},${row.ads},${row.pending},${row.approved},${row.rejected},${row.users},${row.reports},${row.amount}\n`;
  });

  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "full_dashboard_report.csv";
  a.click();
  URL.revokeObjectURL(url);
}

document.addEventListener("DOMContentLoaded", () => updateFullDashboardChart());

async function loadDeletedAds() {
  const container = document.getElementById('deletedAdsList');
  container.innerHTML = 'Loading...';

  try {
    const snap = await db.collection("deletedAds").orderBy("deletedAt", "desc").get();
    container.innerHTML = '';

    if (snap.empty) {
      container.innerHTML = '<p style="color:#999;">No deleted ads found.</p>';
      return;
    }

    snap.forEach(doc => {
      const d = doc.data();
      const timestamp = d.deletedAt?.toDate().toLocaleString() || 'N/A';
      const reason = d.deleteReason || 'N/A';
      const thumb = (d.images && d.images.length > 0) ? d.images[0] : 'https://via.placeholder.com/80x80?text=No+Image';

      const el = document.createElement('div');
      el.className = 'list-item';
      el.style.alignItems = 'flex-start';
      el.style.marginBottom = '16px';
      el.style.paddingBottom = '16px';
      el.style.borderBottom = '1px solid #ccc';

      // Build chat messages
      const chatsHTML = (d.chats && d.chats.length)
        ? d.chats.map(chat => {
            const time = chat.timestamp?.toDate?.().toLocaleString('en-IN', {
              hour: '2-digit', minute: '2-digit', day: '2-digit', month: 'short'
            });
            return `<div style='font-size:12px;margin-bottom:4px;'>
              <b>${chat.sender}:</b> ${chat.text}
              <span style='color:#888;font-size:11px;'>(${time || 'Time N/A'})</span>
            </div>`;
          }).join('')
        : '<div style="font-size:12px;color:#777;">No chat history found.</div>';

      // Main HTML block
     el.innerHTML = `
  <img src="${thumb}" style="width:80px;height:80px;object-fit:cover;border-radius:10px;margin-right:14px;">
  <div style="flex:1;">
    <div style="font-size:16px;font-weight:bold;color:#333;">${d.title || 'Untitled Ad'}</div>
    <div style="font-size:13px;margin:4px 0;">
      <b>User ID:</b> <code>${d.userId}</code><br>
      <b>Ad ID:</b> <code>${d.adId}</code><br>
      <b>Reason:</b> <span style="color:#c0392b;">${reason}</span><br>
      <b>Deleted At:</b> ${timestamp}
    </div>
    <div style="font-size:13px;color:#666;">
      <b>Price:</b> â‚¹${d.price?.toLocaleString('en-IN') || '0'}<br>
      <b>Location:</b> ${d.area || ''}, ${d.location || ''}
    </div>

    <div style="margin-top:12px; display: flex; gap: 10px; flex-wrap: wrap;">
      <button onclick='showChatPopup(${JSON.stringify(d.chats || [])})'
        style="padding:6px 12px; background:#3498db; color:white; border:none; border-radius:4px; cursor:pointer;">
        View Chat
      </button>

      <button onclick="restoreDeletedAd('${d.adId}', '${d.userId}')"
        style="padding:6px 12px; background:#2ecc71; color:white; border:none; border-radius:4px; cursor:pointer;">
        Restore
      </button>

      <button onclick="deleteDeletedAd('${doc.id}')"
        style="padding:6px 12px; background:#e74c3c; color:white; border:none; border-radius:4px; cursor:pointer;">
        Delete Permanently
      </button>
    </div>
  </div>
`;


      container.appendChild(el);
    });
  } catch (err) {
    console.error("Error loading deleted ads:", err);
    container.innerHTML = '<p style="color:red;">Failed to load deleted ads.</p>';
  }
}

function showChatPopup(chatArray) {
  const chatDiv = document.getElementById('chatPopupContent');
  if (!chatArray || chatArray.length === 0) {
    chatDiv.innerHTML = '<p>No chat history available.</p>';
  } else {
    chatDiv.innerHTML = chatArray.map(chat => {
      const time = chat.timestamp?.seconds
        ? new Date(chat.timestamp.seconds * 1000).toLocaleString('en-IN')
        : 'Time N/A';
      return `<div style="margin-bottom:6px;font-size:14px;">
        <b>${chat.sender}:</b> ${chat.text} <br>
        <span style="font-size:12px;color:gray;">${time}</span>
      </div>`;
    }).join('');
  }
  document.getElementById('chatPopup').style.display = 'block';
  document.getElementById('popupBackdrop').style.display = 'block';
}

function closeChatPopup() {
  document.getElementById('chatPopup').style.display = 'none';
  document.getElementById('popupBackdrop').style.display = 'none';
}

async function restoreDeletedAd(adId, userId) {
  if (!confirm("Are you sure you want to restore this ad to the user?")) return;

  const deletedRef = db.collection("deletedAds").doc(adId);
  const doc = await deletedRef.get();
  if (!doc.exists) return alert("Ad not found!");

  const adData = doc.data();

  // ðŸ”¥ Clean fields that hide ads
  delete adData.deletedAt;
  delete adData.deleteReason;
  delete adData.userDeleted;

  // âœ… Force-set userDeleted to false
  adData.userDeleted = false;

  // âœ… (Optional) update timestamp to bring ad to top of index
  adData.timestamp = firebase.firestore.FieldValue.serverTimestamp();

  // âœ… Restore to main collection
  await db.collection("items").doc(adId).set(adData);
  await deletedRef.delete();

  alert("Ad restored successfully.");
  loadDeletedAds(); // refresh deleted tab
}

function loadDashboard() {
  if (typeof listenLiveDashboard === 'function') {
    return listenLiveDashboard();
  }
  console.warn('listenLiveDashboard() not available');
}

function openBoostRejectModal(boostId, userId) {
  selectedBoostId = boostId;
  selectedBoostUserId = userId;
  document.getElementById('boostRejectReasonModal').style.display = 'block';
}

function confirmBoostRejection() {
  const reason = document.getElementById('boostRejectReasonSelect').value;
  if (!reason) return alert("Please select a rejection reason.");

  db.collection("boostRequests").doc(selectedBoostId).update({
    status: "rejected",
    rejectedAt: firebase.firestore.FieldValue.serverTimestamp(),
    rejectReason: reason
  }).then(() => {
    alert("Boost request rejected with reason.");
    document.getElementById('boostRejectReasonModal').style.display = 'none';
    loadDashboard();
  }).catch(err => {
    console.error("Error rejecting boost:", err);
    alert("Failed to reject boost request.");
  });
}

// ========== VIEW USERS DETAILS ==========
async function viewUserDetails(userId) {
  try {
    // 1. Fetch current user details
    const userDoc = await db.collection('users').doc(userId).get();
    if (!userDoc.exists) return alert('User not found.');

    const u = userDoc.data();
    const displayName = u.displayName || 'Not provided';
    const email = u.email || 'Not provided';
    const phone = u.phoneNumber || 'Not provided';
    const createdAt = u.createdAt?.toDate?.().toLocaleString() || 'Unknown';
    const lastLogin = u.lastLogin?.toDate?.().toLocaleString() || 'Unknown';
    const photoURL = u.photoURL || '';
    const platform = u.platform || '-';
    const referralCode = u.referralCode || '-';
    const accountType = u.accountType || 'Free';
    const lastIP = u.lastIP || '-';
    const lastUA = u.lastUA || '-';

    // 2. Handle referrer display name from referrals collection (referrerUid)
    let referredByDisplayName = '-';
    let referredByUid = '-';

    // Check if this user was referred (by looking for a referral document where newUserUid == userId)
    const referralQuery = await db.collection('referrals').where('newUserUid', '==', userId).limit(1).get();
    if (!referralQuery.empty) {
      const referralDoc = referralQuery.docs[0].data();
      referredByUid = referralDoc.referrerUid || '-';
      // Now fetch display name
      if (referredByUid && referredByUid !== '-') {
        try {
          const refUserDoc = await db.collection('users').doc(referredByUid).get();
          if (refUserDoc.exists) {
            referredByDisplayName = refUserDoc.data().displayName || referredByUid;
          } else {
            referredByDisplayName = referredByUid;
          }
        } catch (err) {
          referredByDisplayName = referredByUid;
        }
      }
    }

    // 3. Ad stats
    const adsSnap = await db.collection('items').where('userId', '==', userId).get();
    const totalAds = adsSnap.size;
    let approved = 0, rejected = 0, pending = 0, expired = 0;
    adsSnap.forEach(doc => {
      const status = doc.data().status;
      if (status === 'approved') approved++;
      else if (status === 'rejected') rejected++;
      else if (status === 'pending') pending++;
      else if (status === 'expired') expired++;
    });

    // 4. Deleted Ads
    let deletedCount = 0;
    try {
      const deletedSnap = await db.collection('deletedAds').where('userId', '==', userId).get();
      deletedCount = deletedSnap.size;
    } catch (e) {}

    // 5. Boost info
    let totalBoosts = 0;
    let totalBoostSpent = 0;
    try {
      const boostSnap = await db.collection('boostRequests').where('userId', '==', userId).get();
      totalBoosts = boostSnap.size;
      boostSnap.forEach(doc => {
        totalBoostSpent += Number(doc.data().amount || 0);
      });
    } catch (e) {}

    // 6. Recent activity
    const recentActivities = [];
    adsSnap.forEach(doc => {
      const d = doc.data();
      const title = d.title || 'Ad';
      const ts = d.timestamp?.toDate()?.toLocaleString() || '';
      recentActivities.push(`ðŸ“ <b>${title}</b> posted (${ts})`);
    });
    // You can add more activities here if needed (e.g., boosts)
    const sortedActivities = recentActivities.sort().reverse().slice(0, 5).join('<br>');

    // 7. HTML
    const html = `
      ${photoURL ? `<img src="${photoURL}" style="width:80px;height:80px;border-radius:50%;object-fit:cover;margin-bottom:12px;">` : ''}
      <p><strong>Name:</strong> ${displayName}</p>
      <p><strong>Email:</strong> ${email}</p>
      <p><strong>Phone:</strong> ${phone}</p>
      <p><strong>Registered At:</strong> ${createdAt}</p>
      <p><strong>Last Login:</strong> ${lastLogin}</p>
      <p><strong>Email Verified:</strong> ${email !== 'Not provided' ? 'âœ…' : 'âŒ'}</p>
      <p><strong>Phone Verified:</strong> ${phone !== 'Not provided' ? 'âœ…' : 'âŒ'}</p>
      <hr>
      <p><strong>Account Type:</strong> ${accountType}</p>
      <p><strong>Last IP:</strong>
  <span id="ipTxt">${lastIP}</span>
  <button class="copy-btn" onclick="
    navigator.clipboard.writeText('${lastIP}')
      .then(()=>alert('Copied'))
  ">
    <i class="fa fa-copy"></i>
  </button>
</p>
      <p><strong>Last UA:</strong>
  <span id="uaTxt" style="word-break:break-all">${escapeHtml(lastUA)}</span>
  <button class="copy-btn" onclick="
    navigator.clipboard.writeText('${(lastUA||'').replace(/'/g,'\\\'')}')
      .then(()=>alert('Copied'))
  ">
    <i class="fa fa-copy"></i>
  </button>
</p>

      <p><strong>Platform:</strong> ${platform}</p>
      <p><strong>Referral Code:</strong> ${referralCode}</p>
      <p><strong>Referred By:</strong> ${referredByDisplayName} ${referredByUid !== '-' ? `<span style="font-size:12px;color:#888;">(${referredByUid})</span>` : ''}</p>
      <hr>
      <h4 style="margin-top:10px;">ðŸ“Š Ad Stats</h4>
      <p>Total Ads: <strong>${totalAds}</strong></p>
      <ul style="font-size:14px; margin-left:16px; line-height:1.7;">
        <li>âœ”ï¸ Approved: ${approved}</li>
        <li>â³ Pending: ${pending}</li>
        <li>âŒ Rejected: ${rejected}</li>
        <li>ðŸ“… Expired: ${expired}</li>
        <li>ðŸ—‘ï¸ Deleted: ${deletedCount}</li>
      </ul>
      <h4 style="margin-top:10px;">ðŸš€ Boost Info</h4>
      <p>Total Boosts Used: <strong>${totalBoosts}</strong></p>
      <p>Total Boost Spend: â‚¹<strong>${totalBoostSpent.toLocaleString('en-IN')}</strong></p>
      <hr>
      <h4 style="margin-top:10px;">ðŸ“… Recent Activity</h4>
      <div style="font-size:13px; color:#444; line-height:1.6;">
        ${sortedActivities || '<i>No recent activity.</i>'}
      </div>
      <hr>
      ${email !== 'Not provided' ? `<a href="mailto:${email}" style="color:#007bff;">ðŸ“§ Send Email</a><br>` : ''}
      ${phone !== 'Not provided' ? `<a href="tel:${phone}" style="color:#d63031;">ðŸ“ž Call User</a>` : ''}
    `;

    document.getElementById('userDetailsContent').innerHTML = html;
    document.getElementById('userDetailsModal').style.display = 'block';

  } catch (err) {
    console.error('Error loading user details:', err);
    alert('Failed to load user details.');
  }
}




(function () {
  'use strict';

  // -------- util --------
  const $ = (id) => document.getElementById(id);
  const near = (a, b, tol = 0.08) => Math.abs(a - b) <= tol; // Â±8%

  async function getImageMeta(file) {
    const url = URL.createObjectURL(file);
    try {
      const img = await new Promise((res, rej) => {
        const i = new Image();
        i.onload = () => res(i);
        i.onerror = rej;
        i.src = url;
      });
      // BUGFIX: return the same variable we actually loaded (was using wrong name)
      const w = img.naturalWidth || img.width;
      const h = img.naturalHeight || img.height;
      return { w, h, r: w / h };
    } finally {
      URL.revokeObjectURL(url);
    }
  }

  // -------- previews (fixed frames; image adjusts) --------
  function wireSliderPreviews() {
    const dFile = $('desktopImageFile');
    const mFile = $('mobileImageFile');

    const dImg = $('sliderPreviewImgDesktop');
    const mImg = $('sliderPreviewImgMobile');

    const dEmp = $('sliderPreviewEmptyDesktop');
    const mEmp = $('sliderPreviewEmptyMobile');

    const note = $('sliderPreviewNote');

    function show(elImg, elEmp, file) {
      if (!elImg || !elEmp) return;
      if (!file) {
        elImg.style.display = 'none';
        elEmp.style.display = 'inline-block';
        return;
      }
      const url = URL.createObjectURL(file);
      elImg.src = url;
      elImg.style.display = 'block';
      elEmp.style.display = 'none';
      // Revoke after the image element has loaded it
      elImg.onload = () => URL.revokeObjectURL(url);
    }

    dFile?.addEventListener('change', async () => {
      const f = dFile.files?.[0];
      show(dImg, dEmp, f);
      if (note) note.textContent = '';
      if (f) {
        const m = await getImageMeta(f);
        if (note && !near(m.r, 11.5)) {
          note.innerHTML = `âš ï¸ Desktop should be <b>920Ã—80</b> (~11.5:1). Selected <b>${m.w}Ã—${m.h}</b> (${m.r.toFixed(2)}:1).`;
        }
      }
    });

    mFile?.addEventListener('change', async () => {
      const f = mFile.files?.[0];
      show(mImg, mEmp, f);
      if (f && note) {
        const m = await getImageMeta(f);
        if (!near(m.r, 3)) {
          note.innerHTML = `âš ï¸ Mobile should be <b>360Ã—120</b> (~3:1). Selected <b>${m.w}Ã—${m.h}</b> (${m.r.toFixed(2)}:1).`;
        }
      }
    });
  }

  // -------- helpers --------
  function screensFromForm() {
    const s = [];
    if ($('showOnDesktop')?.checked) s.push('desktop');
    if ($('showOnMobile')?.checked) s.push('mobile');
    return s;
  }

  function resetSliderForm() {
    const ids = ['sliderText', 'sliderLink', 'sliderOrder'];
    ids.forEach((id) => {
      const el = $(id);
      if (!el) return;
      el.value = id === 'sliderOrder' ? '1' : '';
    });
    $('sliderActive') && ($('sliderActive').checked = true);
    $('showOnDesktop') && ($('showOnDesktop').checked = true);
    $('showOnMobile') && ($('showOnMobile').checked = true);
    $('desktopImageFile') && ($('desktopImageFile').value = '');
    $('mobileImageFile') && ($('mobileImageFile').value = '');

    // ensure the save button is only bound once via onclick (no addEventListener)
    const btn = $('saveSliderBtn');
    if (btn) {
      btn.type = 'button';      // prevent form submit dupes
      btn.innerText = 'Add Slider';
      btn.onclick = (e) => { e?.preventDefault?.(); addSlider(); };
    }

    // reset previews
    const dImg = $('sliderPreviewImgDesktop');
    const mImg = $('sliderPreviewImgMobile');
    const dEmp = $('sliderPreviewEmptyDesktop');
    const mEmp = $('sliderPreviewEmptyMobile');
    if (dImg) dImg.style.display = 'none';
    if (mImg) mImg.style.display = 'none';
    if (dEmp) dEmp.style.display = 'inline-block';
    if (mEmp) mEmp.style.display = 'inline-block';

    const note = $('sliderPreviewNote');
    if (note) note.textContent = '';
  }

  // -------- CRUD --------
  async function loadSliders() {
    const container = $('sliderList');
    if (!container) return;
    container.textContent = 'Loading slidersâ€¦';

    try {
      const snap = await db.collection('slider').orderBy('order', 'asc').get();

      if (snap.empty) {
        container.innerHTML = '<p>No sliders added.</p>';
        return;
      }

      // clear once to avoid dupes
      container.innerHTML = '';

      snap.forEach((doc) => {
        const d = doc.data();
        const id = doc.id;
        const hasD = !!d.desktopImage;
        const hasM = !!d.mobileImage;

        const row = `
          <div class="list-item" data-id="${id}">
            <div class="meta">
              <span class="slider-mini">
                <span class="box">${hasD ? `<img src="${d.desktopImage}" alt="">` : `<span style="font-size:11px;color:#8aa0bd;">No D</span>`}</span>
                <span class="box m">${hasM ? `<img src="${d.mobileImage}" alt="">` : `<span style="font-size:11px;color:#8aa0bd;">No M</span>`}</span>
              </span>
              <b>${d.text || ''}</b>
              ${d.link ? `<a href="${d.link}" target="_blank" style="font-size:12px;margin-left:6px;">${d.link}</a>` : ''}
              <span style="margin-left:10px;font-size:12px;">Order: ${d.order || 1}</span>
              ${d.active
                ? `<span class="badge" style="background:#d7ffe3;color:#23ad4a;">Active</span>`
                : `<span class="badge" style="background:#ffd9d9;color:#c82020;">Inactive</span>`}
              ${Array.isArray(d.screens) && d.screens.includes('desktop') ? `<span class="badge d">D</span>` : ''}
              ${Array.isArray(d.screens) && d.screens.includes('mobile') ? `<span class="badge m">M</span>` : ''}
            </div>
            <div>
              <button class="edit-btn" onclick="editSliderPrompt('${id}')">Edit</button>
              <button class="delete-btn" onclick="deleteSlider('${id}')">Delete</button>
            </div>
          </div>
        `;
        // small perf win & avoids innerHTML += reparsing the whole container
        container.insertAdjacentHTML('beforeend', row);
      });
    } catch (e) {
      console.error(e);
      container.innerHTML = '<p style="color:#c00;">Failed to load sliders.</p>';
    }
  }

  async function addSlider() {
    try {
      const text = $('sliderText')?.value?.trim() || '';
      const link = $('sliderLink')?.value?.trim() || '';
      const order = parseInt($('sliderOrder')?.value, 10) || 1;
      const active = !!$('sliderActive')?.checked;
      const screens = screensFromForm();

      const dFile = $('desktopImageFile')?.files?.[0] || null;
      const mFile = $('mobileImageFile')?.files?.[0] || null;

      if (!screens.length) {
        alert('Select Desktop and/or Mobile.');
        return;
      }
      if (!text && !link && !dFile && !mFile) {
        alert('Provide text or at least one image or a link.');
        return;
      }

      let desktopImage = '';
      let mobileImage  = '';

      if (dFile) {
        const m = await getImageMeta(dFile);
        if (!near(m.r, 11.5) && !confirm(`Desktop should be 920Ã—80 (~11.5:1).\nSelected ${m.w}Ã—${m.h} (${m.r.toFixed(2)}:1).\nContinue?`))
          return;
        const ref = firebase.storage().ref('slider/desktop/' + Date.now() + '-' + dFile.name);
        await ref.put(dFile);
        desktopImage = await ref.getDownloadURL();
      }

      if (mFile) {
        const m = await getImageMeta(mFile);
        if (!near(m.r, 3) && !confirm(`Mobile should be 360Ã—120 (~3:1).\nSelected ${m.w}Ã—${m.h} (${m.r.toFixed(2)}:1).\nContinue?`))
          return;
        const ref = firebase.storage().ref('slider/mobile/' + Date.now() + '-' + mFile.name);
        await ref.put(mFile);
        mobileImage = await ref.getDownloadURL();
      }

      // reuse one if missing but selected
      if (screens.includes('desktop') && !desktopImage && mobileImage) desktopImage = mobileImage;
      if (screens.includes('mobile') && !mobileImage && desktopImage)  mobileImage  = desktopImage;

      await db.collection('slider').add({ text, link, order, active, screens, desktopImage, mobileImage });

      alert('Slider added!');
      resetSliderForm();
      loadSliders();
    } catch (err) {
      console.error(err);
      alert('Failed to add slider. Check console.');
    }
  }

  function editSliderPrompt(sliderId) {
    db.collection('slider').doc(sliderId).get().then((doc) => {
      if (!doc.exists) return alert('Not found.');
      const d = doc.data();

      $('sliderText').value = d.text || '';
      $('sliderLink').value = d.link || '';
      $('sliderOrder').value = d.order || 1;
      $('sliderActive').checked = !!d.active;
      $('showOnDesktop').checked = Array.isArray(d.screens) ? d.screens.includes('desktop') : false;
      $('showOnMobile').checked  = Array.isArray(d.screens) ? d.screens.includes('mobile')  : false;

      // show current images in preview
      const dImg = $('sliderPreviewImgDesktop');
      const mImg = $('sliderPreviewImgMobile');
      const dEmp = $('sliderPreviewEmptyDesktop');
      const mEmp = $('sliderPreviewEmptyMobile');

      if (dImg && dEmp) {
        if (d.desktopImage) { dImg.src = d.desktopImage; dImg.style.display = 'block'; dEmp.style.display = 'none'; }
        else { dImg.style.display = 'none'; dEmp.style.display = 'inline-block'; }
      }
      if (mImg && mEmp) {
        if (d.mobileImage) { mImg.src = d.mobileImage; mImg.style.display = 'block'; mEmp.style.display = 'none'; }
        else { mImg.style.display = 'none'; mEmp.style.display = 'inline-block'; }
      }

      const btn = $('saveSliderBtn');
      if (btn) {
        btn.type = 'button';
        btn.innerText = 'Update';
        btn.onclick = async (e) => {
          e?.preventDefault?.();
          try {
            const text = $('sliderText').value.trim();
            const link = $('sliderLink').value.trim();
            const order = parseInt($('sliderOrder').value, 10) || 1;
            const active = $('sliderActive').checked;
            const screens = screensFromForm();

            let desktopImage = d.desktopImage || '';
            let mobileImage  = d.mobileImage  || '';

            const dFile = $('desktopImageFile')?.files?.[0] || null;
            const mFile = $('mobileImageFile')?.files?.[0] || null;

            if (dFile) {
              const meta = await getImageMeta(dFile);
              if (!near(meta.r, 11.5) && !confirm(`Desktop should be 920Ã—80 (~11.5:1).\nSelected ${meta.w}Ã—${meta.h} (${meta.r.toFixed(2)}:1).\nContinue?`))
                return;
              const ref = firebase.storage().ref('slider/desktop/' + Date.now() + '-' + dFile.name);
              await ref.put(dFile);
              desktopImage = await ref.getDownloadURL();
            }
            if (mFile) {
              const meta = await getImageMeta(mFile);
              if (!near(meta.r, 3) && !confirm(`Mobile should be 360Ã—120 (~3:1).\nSelected ${meta.w}Ã—${meta.h} (${meta.r.toFixed(2)}:1).\nContinue?`))
                return;
              const ref = firebase.storage().ref('slider/mobile/' + Date.now() + '-' + mFile.name);
              await ref.put(mFile);
              mobileImage = await ref.getDownloadURL();
            }

            if (screens.includes('desktop') && !desktopImage && mobileImage) desktopImage = mobileImage;
            if (screens.includes('mobile')  && !mobileImage  && desktopImage) mobileImage  = desktopImage;

            if (!text && !link && !desktopImage && !mobileImage) {
              alert('Provide text or at least one image or a link.');
              return;
            }

            await db.collection('slider').doc(sliderId).update({
              text, link, order, active, screens, desktopImage, mobileImage
            });

            alert('Slider updated!');
            resetSliderForm();
            loadSliders();
          } catch (e) {
            console.error(e);
            alert('Failed to update. Check console.');
          }
        };
      }
    });
  }

  function deleteSlider(sliderId) {
    if (!confirm('Delete this slider?')) return;
    db.collection('slider').doc(sliderId).delete()
      .then(() => { alert('Deleted!'); loadSliders(); })
      .catch((e) => { console.error(e); alert('Failed to delete.'); });
  }

  // -------- expose for inline onclicks & other files --------
  window.loadSliders = loadSliders;
  window.editSliderPrompt = editSliderPrompt;
  window.deleteSlider = deleteSlider;

  // -------- boot (guarded to avoid double listeners if file included twice) --------
  document.addEventListener('DOMContentLoaded', () => {
    if (window.__SLIDER_BOOTED__) return;
    window.__SLIDER_BOOTED__ = true;

    try { wireSliderPreviews(); } catch (e) { console.warn('[slider] preview wiring failed', e); }

    // IMPORTANT: do NOT addEventListener on save button here.
    // It's bound via .onclick in reset/edit so it doesn't double-fire.

    document.querySelector('[data-tab="sliderTab"]')?.addEventListener('click', loadSliders);

    // If tab already visible on first paint, load immediately
    const tabPanel = $('sliderTab');
    if (tabPanel && tabPanel.style.display !== 'none') loadSliders();

    // Ensure fresh state for the button on first load
    resetSliderForm();
  });
})();


function downloadPaymentsCSV(type) {
  const rows = [
    ["Date", "User ID", "Ad ID", "Amount (â‚¹)", "Plan", "Payment ID", "Status", "Payment Method", "Reject Reason"]
  ];

  const dataSource = type === 'approved' ? window.lastApprovedPayments : window.lastRejectedPayments;

  if (!dataSource || dataSource.length === 0) {
    alert("No data to export.");
    return;
  }

  dataSource.forEach(doc => {
    const d = doc.data();
    const date = d.timestamp?.toDate()?.toLocaleDateString("en-IN") || '';
    const userId = d.userId || '';
    const adId = d.adId || '';
    const amount = d.amount || '';
    const plan = d.plan || 'General';
    const paymentId = d.paymentId || '';
    const status = d.status || '';
    const reason = d.rejectReason || '-';

    rows.push([date, userId, adId, amount, plan, paymentId, status, (d.paymentMethod || ''), reason]);
  });

  const csvContent = "data:text/csv;charset=utf-8," + rows.map(e => e.join(",")).join("\n");
  const encodedUri = encodeURI(csvContent);
  const link = document.createElement("a");
  link.setAttribute("href", encodedUri);
  link.setAttribute("download", `${type}_payments_report.csv`);
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}


</script>
<script>
// Inner tab toggle
document.getElementById('btnBoostTab').addEventListener('click', () => {
  document.getElementById('btnBoostTab').classList.add('active');
  document.getElementById('btnPostFeeTab').classList.remove('active');
  document.getElementById('boostRequestsList').style.display = 'block';
  document.getElementById('postFeeRequestsList').style.display = 'none';
  loadBoostRequests(); // existing
});

document.getElementById('btnPostFeeTab').addEventListener('click', () => {
  document.getElementById('btnPostFeeTab').classList.add('active');
  document.getElementById('btnBoostTab').classList.remove('active');
  document.getElementById('postFeeRequestsList').style.display = 'block';
  document.getElementById('boostRequestsList').style.display = 'none';

  if (typeof loadPostFeeRequests === 'function') {
    loadPostFeeRequests();
  } else {
    console.warn('loadPostFeeRequests() is not loaded yet');
  }
});


// Open image in modal (reuse)
function enlargeBoostImage(url){
  const img = document.getElementById('boostImageLarge');
  const modal = document.getElementById('boostImageModal');
  if(!img || !modal) return;
  img.src = url;
  modal.style.display = 'flex';
}
</script>
<script>

// Safe guards for globals used elsewhere
window.dashboardUnsubs = Array.isArray(window.dashboardUnsubs) ? window.dashboardUnsubs : [];

function getItemRejectReason(d){
  return (
    d?.reject?.text ||          // structured
    d?.rejection?.reason ||     // structured (alt)
    d?.rejectionReason ||       // âœ… put this BEFORE moderation.reason
    d?.rejectReason ||          // legacy alias
    d?.moderation?.reason ||    // approved/review text
    d?.reason ||                // very generic
    '-'
  );
}


async function loadPostFeeRequests() {
  const container = document.getElementById('postFeeRequestsList');
  if (!container) return;
  container.innerHTML = 'Loadingâ€¦';

  try {
    const snap = await db.collection('postFeeRequests')
      .where('status', '==', 'pending')
      .orderBy('createdAt', 'desc')
      .limit(50)
      .get();

    if (snap.empty) {
      container.innerHTML = '<p>No pending requests.</p>';
      return;
    }

    let html = `<table style="width:100%; border-collapse:collapse; font-size:13px; margin-top:10px;">
      <thead style="background:#f9f9f9;">
        <tr style="border-bottom:1px solid #ccc;">
          <th style="padding:6px;">#</th>
          <th style="padding:6px;">User</th>
          <th style="padding:6px;">Ad</th>
          <th style="padding:6px;">Amt</th>
          <th style="padding:6px;">Date</th>
          <th style="padding:6px;">Payment ID</th>
          <th style="padding:6px;">SS</th>
          <th style="padding:6px;">Action</th>
        </tr>
      </thead>
      <tbody>`;

    let i = 0;
    snap.forEach(doc => {
      const d  = doc.data() || {};
      const dt = d.createdAt?.toDate?.()?.toLocaleString('en-IN') || '-';
      const ss = d.screenshot
        ? `<img src="${d.screenshot}" height="50" style="cursor:pointer;" onclick="enlargeBoostImage('${d.screenshot}')">`
        : 'â€”';

      const hasAd = !!d.adId;

      const viewBtn = `<button onclick="safeViewAd('${d.adId||''}')"
                  ${hasAd ? '' : 'disabled'}
                  title="${hasAd ? 'Open Ad' : 'No Ad ID'}"
                  style="padding:6px 10px;font-size:13px;background:#e8f2fd;color:#0071f3;border:none;border-radius:4px;margin-right:6px;opacity:${hasAd?1:.6};cursor:${hasAd?'pointer':'not-allowed'};">
            View
          </button>`;

      html += `<tr style="border-bottom:1px solid #eee;">
        <td style="padding:6px;">${++i}</td>
        <td style="padding:6px;">${d.userId || '-'}</td>
        <td style="padding:6px;">${d.adId || '-'}</td>
        <td style="padding:6px;">â‚¹${Number(d.amount||0).toLocaleString('en-IN')}</td>
        <td style="padding:6px;">${dt}</td>
        <td style="padding:6px;">${d.paymentId || '-'}</td>
        <td style="padding:6px;">${ss}</td>
        <td style="padding:6px; white-space:nowrap;">
          ${viewBtn}
          <button onclick="confirmApprovePostFee('${doc.id}','${d.adId||''}','${d.userId||''}', ${Number(d.amount||0)})"
                  style="padding:6px 10px;font-size:13px;background:#4caf50;color:#fff;border:none;border-radius:4px;">
            Approve
          </button>
          <button onclick="openPostFeeRejectModal('${doc.id}','${d.userId||''}','${d.paymentId||''}', ${Number(d.amount||0)}, '${d.adId||''}')"
                  style="padding:6px 10px;font-size:13px;background:#e53935;color:#fff;border:none;border-radius:4px;margin-left:6px;">
            Reject
          </button>
        </td>
      </tr>`;
    });

    html += '</tbody></table>';
    container.innerHTML = html;
  } catch (err) {
    console.error('loadPostFeeRequests error', err);
    container.innerHTML = '<p style="color:red;">Failed to load.</p>';
  }
}

// -----------------------------
// View helper (modal or fallback)
// -----------------------------
function safeViewAd(adId){
  if(!adId) return;
  if (typeof window.viewAdDetails === 'function') {
    try { return window.viewAdDetails(adId); } catch(e){ console.warn(e); }
  }
  // fallback (update path if your details page route differs)
  window.open(`/item-details.html?id=${encodeURIComponent(adId)}`, '_blank');
}

// -----------------------------
// Approve (direct live)
// -----------------------------
function confirmApprovePostFee(reqId, adId, userId, amount){
  if(confirm('Approve this paid post?')) approvePostFee(reqId, adId, userId, amount);
}

async function approvePostFee(requestId, adId, userId, amount){
  try {
    const reqDoc = await db.collection('postFeeRequests').doc(requestId).get();
    if (!reqDoc.exists) return alert('Request not found');
    const req = reqDoc.data();
    const realPaymentId = req.paymentId || '';
    const screenshot = req.screenshot || '';

    // 1) request -> approved
    await db.collection('postFeeRequests').doc(requestId).update({
      status: 'approved',
      approvedAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    // 2) item -> approved/live
    if (adId) {
      const adRef = db.collection('items').doc(adId);
      await adRef.set({
        status: 'approved',
        approvedAt: firebase.firestore.FieldValue.serverTimestamp(),
        postFee: { type: 'one_time', amount: Number(amount)||20, status: 'approved' },
        isActive: true,
        moderation: { reviewedBy: 'admin', reviewedAt: firebase.firestore.FieldValue.serverTimestamp() }
      }, { merge: true });
    }

    // 3) payment log
    await db.collection('payments').add({
      thumb: (screenshot || ''), // store screenshot/receipt as thumb
      userId: userId || '-',
      adId: adId || '-',
      amount: Number(amount)||20,
      plan: 'Post Fee',
      paymentId: realPaymentId,
      status: 'success',
      screenshot: screenshot,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });

// === Inject: add admin name + thumb to postFeeRequests and item on approval ===
const adminName = (auth && auth.currentUser && (auth.currentUser.displayName || auth.currentUser.email)) || 'admin';
const itemSnap = adId ? await db.collection('items').doc(adId).get() : null;
const itemData = itemSnap && itemSnap.exists ? itemSnap.data() : {};
const thumbUrl = itemData?.images?.[0] || itemData?.thumbnailUrl || req?.thumb || '';

await db.collection('postFeeRequests').doc(requestId).set({
  approveMeta: { by: 'admin', byName: adminName, at: firebase.firestore.FieldValue.serverTimestamp(), thumb: thumbUrl }
}, { merge: true });

if (adId) {
  await db.collection('items').doc(adId).set({
    thumbnailUrl: thumbUrl,
    approval: { by: 'admin', byName: adminName, at: firebase.firestore.FieldValue.serverTimestamp(), thumb: thumbUrl },
    moderation: {
      reviewedBy: 'admin',
      reviewedByName: adminName,
      reviewedAt: firebase.firestore.FieldValue.serverTimestamp(),
      reason: 'approved',
      thumb: thumbUrl
    }
  }, { merge: true });
}

    // === Notification: Paid Post Approved with image ===
    try {
      const itemSnapForNotif = adId ? await db.collection('items').doc(adId).get() : null;
      const itemForNotif = itemSnapForNotif && itemSnapForNotif.exists ? itemSnapForNotif.data() : {};
      const notifThumb = itemForNotif?.images?.[0] || itemForNotif?.thumbnailUrl || req?.thumb || '';
      db.collection("notifications").add({
        userId: userId || req.userId,
        message: `Your Ad "${itemForNotif?.title || req?.title || 'your ad'}" is now Live!`,
        imageUrl: notifThumb,
        adId: adId || req.adId || '',
        type: 'postFee_approved',
        adminName: (auth && auth.currentUser && (auth.currentUser.displayName || auth.currentUser.email)) || 'admin',
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        seen: false
      });
    } catch (e) { console.warn('notif error (approvePostFee):', e); }
  } catch (err) {
    console.error('approvePostFee DB error', err);
    alert('Failed to approve.');
    return;
  }

  alert('Paid post approved.');

  try {
    await loadPostFeeRequests();
    if (typeof loadAmountReceived === 'function') await loadAmountReceived();
    if (typeof listenLiveDashboard === 'function') await listenLiveDashboard();
  } catch (e) {
    console.warn('approvePostFee UI refresh failed:', e);
  }
}

// -----------------------------
// Reject (direct final reject) + structured reason
// -----------------------------
let __postFeeRejectCtx = { id:'', userId:'', amount:0, payId:'', adId:'' };

function openPostFeeRejectModal(reqId, userId, payId, amount, adId){
  __postFeeRejectCtx = { id:reqId, userId, amount, payId, adId };
  const modal = document.getElementById('boostRejectReasonModal');
  const btn   = document.getElementById('confirmBoostRejectionBtn');
  if (btn) {
    btn.onclick = confirmPostFeeRejection;
    btn.textContent = 'Reject Paid Post';
  }
  if (modal) {
    const sel = document.getElementById('boostRejectReasonSelect');
    if (sel) sel.value = '';
    modal.style.display = 'block';
  }
}

// If the same modal is used for boost, avoid redeclaration errors:
if (typeof window.selectedBoostId === 'undefined') window.selectedBoostId = null;
if (typeof window.selectedBoostUserId === 'undefined') window.selectedBoostUserId = null;

function openBoostRejectModal(boostId, userId) {
  window.selectedBoostId = boostId;
  window.selectedBoostUserId = userId;
  const modal = document.getElementById('boostRejectReasonModal');
  const btn   = document.getElementById('confirmBoostRejectionBtn');
  if (btn) {
    btn.onclick = confirmBoostRejection; // original boost handler
    btn.textContent = 'Reject';
  }
  if (modal) modal.style.display = 'block';
}

function confirmPostFeeRejection(){
  const sel = document.getElementById('boostRejectReasonSelect');
  const reasonCode = sel && sel.value;
  if (!reasonCode) return alert('Please select a rejection reason.');
  const reasonText = sel.options[sel.selectedIndex]?.text || reasonCode;

  const { id, userId, amount, payId, adId } = __postFeeRejectCtx;
  // pass structured reason
  rejectPostFee(id, userId, amount, payId, { code: reasonCode, text: reasonText }, adId);
}

async function rejectPostFee(requestId, userId, amount, payId, reason, adId){
  try {
    const reqDoc = await db.collection('postFeeRequests').doc(requestId).get();
    const req = reqDoc.exists ? reqDoc.data() : {};
    const realPaymentId = req.paymentId || payId || '';
    const screenshot    = req.screenshot || '';
    const reasonText    = reason?.text || '-';
    const reasonCode    = reason?.code || '';

    // 1) request -> rejected (+ reasons)
    await db.collection('postFeeRequests').doc(requestId).update({
      status: 'rejected',
      rejectedAt: firebase.firestore.FieldValue.serverTimestamp(),
      // legacy + alias for any UI
      rejectReason:    reasonText,
      rejectionReason: reasonText,
      // structured
      reject: {
        code: reasonCode,
        text: reasonText,
        by:  'admin',
        at:  firebase.firestore.FieldValue.serverTimestamp()
      }
    });

    // 2) payment log (+ reason) â€” CSV reads rejectReason
    await db.collection('payments').add({
      thumb: (screenshot || ''), // store screenshot/receipt as thumb
      userId:   userId || '-',
      adId:     adId || null,
      amount:   Number(amount)||20,
      plan:     'Post Fee',
      paymentId: realPaymentId,
      status:   'rejected',
      screenshot: screenshot,
      timestamp:  firebase.firestore.FieldValue.serverTimestamp(),
      rejectedAt: firebase.firestore.FieldValue.serverTimestamp(),
      rejectReason: reasonText,             // <â€” for CSV/old UIs
      reject: { code: reasonCode, text: reasonText }
    });

    // 3) item -> rejected (+ reasons) â€” All Ads reads rejectionReason currently
    if (adId) {
      await db.collection('items').doc(adId).set({
        status:     'rejected',
        rejectedAt: firebase.firestore.FieldValue.serverTimestamp(),
        // write ALL common aliases so any UI can show the reason
        rejectReason:    reasonText,
        rejectionReason: reasonText,
        moderation: {
          reviewedBy: 'admin',
          reviewedAt: firebase.firestore.FieldValue.serverTimestamp(),
          reason:     reasonText
        },
        reject: {
          code: reasonCode,
          text: reasonText,
          by:  'admin',
          at:  firebase.firestore.FieldValue.serverTimestamp()
        }
      }, { merge: true });
    }

// === Inject: add admin name + thumb to postFeeRequests and item ===
const adminName = (auth && auth.currentUser && (auth.currentUser.displayName || auth.currentUser.email)) || 'admin';
const itemSnap = adId ? await db.collection('items').doc(adId).get() : null;
const itemData = itemSnap && itemSnap.exists ? itemSnap.data() : {};
const thumbUrl = itemData?.images?.[0] || itemData?.thumbnailUrl || req?.thumb || '';

await db.collection('postFeeRequests').doc(requestId).set({
  rejectMeta: { by: 'admin', byName: adminName, at: firebase.firestore.FieldValue.serverTimestamp(), thumb: thumbUrl }
}, { merge: true });

if (adId) {
  await db.collection('items').doc(adId).set({
    thumbnailUrl: thumbUrl,
    moderation: {
      reviewedBy: 'admin',
      reviewedByName: adminName,
      reviewedAt: firebase.firestore.FieldValue.serverTimestamp(),
      reason: reasonText,
      thumb: thumbUrl
    },
    reject: { code: reasonCode, text: reasonText, by: 'admin', byName: adminName, at: firebase.firestore.FieldValue.serverTimestamp(), thumb: thumbUrl }
  }, { merge: true });
}

    // === Notification: Paid Post Rejected with image ===
    try {
      const itemSnapForNotif = adId ? await db.collection('items').doc(adId).get() : null;
      const itemForNotif = itemSnapForNotif && itemSnapForNotif.exists ? itemSnapForNotif.data() : {};
      const notifThumb = itemForNotif?.images?.[0] || itemForNotif?.thumbnailUrl || req?.thumb || '';
      db.collection("notifications").add({
        userId: userId || req.userId,
        message: `Your Ad "${itemForNotif?.title || req?.title || 'your ad'}" was rejected! Reason: ${reasonText || reason || 'â€”'}`,
        imageUrl: notifThumb,
        adId: adId || req.adId || '',
        type: 'postFee_rejected',
        reason: reasonText || reason || '',
        adminName: (auth && auth.currentUser && (auth.currentUser.displayName || auth.currentUser.email)) || 'admin',
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        seen: false
      });
    } catch (e) { console.warn('notif error (rejectPostFee):', e); }
  } catch (err) {
    console.error('rejectPostFee DB error', err);
    alert('Failed to reject.');
    return;
  }

  const modal = document.getElementById('boostRejectReasonModal');
  if (modal) modal.style.display = 'none';
  alert('Paid post rejected.');

  try {
    await loadPostFeeRequests();
    if (typeof loadAmountReceived === 'function') await loadAmountReceived();
  } catch(e){
    console.warn('rejectPostFee UI refresh failed:', e);
  }
}

// -----------------------------
// Modal confirm button hook
// -----------------------------
(function wirePostFeeRejectConfirm(){
  const btn = document.getElementById('confirmBoostRejectionBtn');
  if(btn){
    const orig = btn.onclick;
    btn.onclick = function(){
      if(__postFeeRejectCtx && __postFeeRejectCtx.id){
        confirmPostFeeRejection();
      } else if (typeof orig === 'function'){
        orig();
      }
    }
  }
})();

// -----------------------------
// Dashboard pending counters (boost + paid post combined)
// -----------------------------
let __boostPendingCount = 0;
let __postFeePendingCount = 0;

function updatePendingBoostCard(){
  const el = document.getElementById('totalPendingBoost');
  if (el) el.textContent = (__boostPendingCount + __postFeePendingCount);
}

// Boost (existing)
window.dashboardUnsubs.push(
  db.collection('boostRequests').where('status', '==', 'pending')
    .onSnapshot(snap => {
      __boostPendingCount = snap.size || 0;
      updatePendingBoostCard();
    })
);

// Paid post (new)
window.dashboardUnsubs.push(
  db.collection('postFeeRequests').where('status', '==', 'pending')
    .onSnapshot(snap => {
      __postFeePendingCount = snap.size || 0;
      updatePendingBoostCard();
    })
);
</script>

<script>
(() => {
  // ========= ENDPOINTS =========
  const FN_URL_PUSH = 'https://bechobazaar.netlify.app/.netlify/functions/send-admin-push';
  const FN_URL_LOGS = 'https://bechobazaar.netlify.app/.netlify/functions/list-admin-push-logs';

  // ========= ROOT / SCOPED HELPERS =========
  const ROOT_ID = 'pushCenterTab';
  const root = document.getElementById(ROOT_ID);
  const q  = (sel) => root ? root.querySelector(sel) : null;       // scoped query (avoid duplicate-ID clashes)
  const set = (sel, html) => { const n = q(sel); if (n) n.innerHTML = html; };
  const esc = (s) => String(s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

  const getKey = () => sessionStorage.getItem('ADMIN_PUSH_KEY') || '';
  const setKey = (k) => sessionStorage.setItem('ADMIN_PUSH_KEY', k || '');

  const fmtDate = (ms) => ms ? new Date(ms).toLocaleString('en-IN', { timeZone: 'Asia/Kolkata' }) : '-';

  function toast(msg, isErr){
    const d = document.createElement('div');
    d.textContent = msg;
    d.style.cssText = `
      position:fixed; right:16px; bottom:16px; z-index:9999;
      background:${isErr?'#fee2e2':'#ecfdf5'}; color:${isErr?'#991b1b':'#065f46'};
      border:1px solid ${isErr?'#fecaca':'#a7f3d0'}; padding:10px 12px; border-radius:10px;
      box-shadow:0 8px 24px rgba(0,0,0,.12); max-width:80vw; line-height:1.2;
    `;
    document.body.appendChild(d);
    setTimeout(()=>d.remove(), 2500);
  }

  // ========= READ FIELDS =========
  function readCommon() {
    return {
      title:   (q('#pc_title')?.value || '').trim(),
      message: (q('#pc_body')?.value  || '').trim(),
      link:    (q('#pc_link')?.value  || 'https://bechobazaar.com/').trim(),
      image:   (q('#pc_image')?.value || '').trim(),
    };
  }

  // ========= SEND PUSH =========
  async function sendPush(payload){
    const key = getKey();
    if (!key) { alert('Enter & save Admin Key first'); return; }

    try {
      const res = await fetch(FN_URL_PUSH, {
        method: 'POST',
        mode: 'cors',
        headers: { 'Content-Type': 'application/json', 'X-Admin-Key': key },
        body: JSON.stringify(payload)
      });
      const txt = await res.text().catch(()=>res.statusText);
      set('#pc_out', `Status: ${res.status}<br>${esc(txt)}`);

      if (res.ok) {
        toast('âœ… Notification queued');
        await pcLoadHistory(true); // refresh after send
      } else {
        toast('âš ï¸ Failed: ' + txt, true);
      }
    } catch (e) {
      console.error('sendPush error', e);
      toast('âš ï¸ Network error', true);
    }
  }

  // ========= HISTORY RENDER =========
  let nextCursorMs = null;

  function rowHTML(item){
    const aLabel = item.audience === 'all' ? 'All' : `UIDs(${item.uids?.length||0})`;
    const link = item.link ? `<a href="${esc(item.link)}" target="_blank" rel="noopener">${esc(item.link)}</a>` : '-';
    const detailsId = `det_${item.id}`;

    const detRows = (item.detailsSample||[]).map((d,i)=>`
      <tr>
        <td style="padding:6px 8px;border-top:1px dashed #eee;">${i+1}</td>
        <td style="padding:6px 8px;border-top:1px dashed #eee;">${d.ok ? 'Delivered' : 'Failed'}</td>
        <td style="padding:6px 8px;border-top:1px dashed #eee;">${esc(d.code||'')}</td>
        <td style="padding:6px 8px;border-top:1px dashed #eee;"><code style="font-size:12px">${esc(d.token||'')}</code></td>
      </tr>
    `).join('');

    const detailsBox = `
      <div id="${detailsId}" style="display:none;background:#fafafa;border:1px solid #eee;border-radius:8px;margin-top:8px;padding:8px;">
        <div style="font-weight:600;margin-bottom:6px;">Sample tokens (${(item.detailsSample||[]).length})</div>
        ${detRows
          ? `<div style="overflow:auto">
               <table style="width:100%;border-collapse:collapse;font-size:13px;">
                 <thead>
                   <tr>
                     <th style="text-align:left;padding:6px 8px;border-bottom:1px solid #eee;">#</th>
                     <th style="text-align:left;padding:6px 8px;border-bottom:1px solid #eee;">Status</th>
                     <th style="text-align:left;padding:6px 8px;border-bottom:1px solid #eee;">Code</th>
                     <th style="text-align:left;padding:6px 8px;border-bottom:1px solid #eee;">Token</th>
                   </tr>
                 </thead>
                 <tbody>${detRows}</tbody>
               </table>
             </div>`
          : `<div style="color:#666;">No sample details.</div>`
        }
      </div>`;

    const full = esc(item.message||'');
    const short = full.length > 60 ? (full.slice(0,60)+'â€¦') : full;

    return `
      <tr>
        <td style="padding:10px;border-top:1px solid #f1f5f9;">${fmtDate(item.createdAtMs)}</td>
        <td style="padding:10px;border-top:1px solid #f1f5f9;">
          <div style="font-weight:600">${esc(item.title||'-')}</div>
          <div title="${full}" style="color:#475569;font-size:12px;margin-top:2px;">${short || '&nbsp;'}</div>
        </td>
        <td style="padding:10px;border-top:1px solid #f1f5f9;">${aLabel}</td>
        <td style="padding:10px;border-top:1px solid #f1f5f9;">${item.sent}</td>
        <td style="padding:10px;border-top:1px solid #f1f5f9;">${item.failed}</td>
        <td style="padding:10px;border-top:1px solid #f1f5f9;">${item.tokens}</td>
        <td style="padding:10px;border-top:1px solid #f1f5f9;">${item.removedBadTokens || 0}</td>
        <td style="padding:10px;border-top:1px solid #f1f5f9;max-width:240px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${link}</td>
        <td style="padding:10px;border-top:1px solid #f1f5f9;">
          <button class="btn" data-toggle="${detailsId}">View</button>
        </td>
      </tr>
      <tr><td colspan="9" style="padding:0 10px 10px 10px;">${detailsBox}</td></tr>
    `;
  }

  async function pcLoadHistory(reset){
    const key = getKey();
    const body = q('#pc_hist_body');
    if (!body) return; // history UI not present

    if (!key) {
      set('#pc_hist_body','<tr><td colspan="9" style="padding:12px;color:#666;">Enter Admin Key and click <b>Save</b>.</td></tr>');
      return;
    }

    if (reset) {
      nextBeforeMs = null;
      set('#pc_hist_body','');
    }

    try {
      const res = await fetch(FN_URL_LOGS, {
        method:'POST',
        mode: 'cors',
        headers:{ 'Content-Type':'application/json', 'X-Admin-Key': key },
        body: JSON.stringify({limit: 20,cursorMs: nextCursorMs || undefined,})
      });
      if (!res.ok) {
        const txt = await res.text().catch(()=>res.statusText);
        set('#pc_hist_body', `<tr><td colspan="9" style="padding:12px;color:#b91c1c;background:#fee2e2;border:1px solid #fecaca;border-radius:8px;">History load failed: ${esc(txt)}</td></tr>`);
        return;
      }

      const json = await res.json();
      const items = json.items || [];
      if (items.length === 0 && !nextBeforeMs && reset) {
        set('#pc_hist_body','<tr><td colspan="9" style="padding:12px;color:#666;">No logs yet.</td></tr>');
      } else {
        const rows = items.map(rowHTML).join('');
        q('#pc_hist_body')?.insertAdjacentHTML('beforeend', rows);

        // bind detail toggles
        root.querySelectorAll('#pc_hist_table [data-toggle]').forEach(btn=>{
          btn.onclick = () => {
            const id = btn.getAttribute('data-toggle');
            const box = document.getElementById(id);
            if (!box) return;
            const show = box.style.display === 'none';
            box.style.display = show ? '' : 'none';
            btn.textContent = show ? 'Hide' : 'View';
          };
        });
      }

      nextBeforeMs = json.nextBeforeMs || null;
    } catch (e) {
      console.error('pcLoadHistory error', e);
      set('#pc_hist_body', '<tr><td colspan="9" style="padding:12px;color:#b91c1c;background:#fee2e2;border:1px solid #fecaca;border-radius:8px;">Network error loading history</td></tr>');
    }
  }

  // ========= BIND UI =========
  function bindPushCenter() {
    if (!root || bindPushCenter.done) return; bindPushCenter.done = true;

    // Prefill key if present
    const keyInput = q('#pc_adminKey');
    if (keyInput && getKey()) keyInput.value = getKey();

    q('#pc_saveKey')?.addEventListener('click', () => {
      const k = (q('#pc_adminKey')?.value || '').trim();
      if (!k) return alert('Enter Admin Key');
      setKey(k);
      toast('ðŸ” Key saved for this tab');
      pcLoadHistory(true); // load history after saving key
    });

    q('#pc_clearKey')?.addEventListener('click', () => {
      setKey(''); if (q('#pc_adminKey')) q('#pc_adminKey').value='';
      toast('ðŸ§¹ Key cleared');
      set('#pc_hist_body',''); set('#pc_out','');
    });

    q('#pc_sendAll')?.addEventListener('click', async () => {
      const p = readCommon(); if (!p.title) return alert('Title required');
      await sendPush({ audience: 'all', ...p });
    });

    q('#pc_sendUids')?.addEventListener('click', async () => {
      const p = readCommon(); if (!p.title) return alert('Title required');
      const raw = (q('#pc_uids')?.value || '').trim();
      if (!raw) return alert('Add at least one UID');
      const uids = raw.split(/[\n,]+/).map(s=>s.trim()).filter(Boolean);
      await sendPush({ audience: 'uids', uids, ...p });
    });

    q('#pc_hist_refresh')?.addEventListener('click', ()=>pcLoadHistory(true));
    q('#pc_hist_more')?.addEventListener('click', ()=>pcLoadHistory(false));

    // First history load if key already set
    if (getKey()) pcLoadHistory(true);
  }

  // If tab is switched via <li data-tab="pushCenterTab"> style UI:
  document.addEventListener('click', (e) => {
    const li = e.target.closest('li[data-tab]');
    if (!li) return;
    if (li.getAttribute('data-tab') === 'pushCenterTab') bindPushCenter();
  });

  // If visible on load (or even hidden â€” binding is safe)
  document.addEventListener('DOMContentLoaded', bindPushCenter);

  // Expose manual refresh (optional)
  window.pcLoadHistory = pcLoadHistory;
})();
</script>

<script>
// ================== CATEGORY MANAGER (Firebase v8) ==================
(function () {
  // ---- Helpers
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  const show = (el) => { if (typeof el === 'string') el = $(el); if (el) el.style.display = ''; };
  const hide = (el) => { if (typeof el === 'string') el = $(el); if (el) el.style.display = 'none'; };
  const setBtnEnabled = (btn, on) => { btn.disabled = !on; btn.style.opacity = on ? '1' : '0.6'; btn.style.cursor = on ? 'pointer' : 'not-allowed'; };
  const toast = (msg, type = 'info') => { if (window.Swal?.fire) Swal.fire(type.toUpperCase(), msg, type); else alert(msg); };

  // ---- Slugify â†’ deterministic Firestore doc IDs (prevents duplicates)
  function toId(str = '') {
    return String(str)
      .normalize('NFKD')
      .replace(/[\u0300-\u036f]/g, '')     // strip diacritics
      .toLowerCase()
      .replace(/[^a-z0-9]+/g, '-')         // non-alnum â†’ hyphen
      .replace(/^-+|-+$/g, '')             // trim hyphens
      .replace(/-{2,}/g, '-');             // collapse
  }

  // ---- Firestore
  const db = firebase.firestore();

  // ---- State
  let editingCatId = null;
  let currentSubCatParentId = null;
  let catCache = [];    // [{id, ...data}]
  let subCache = [];    // for the open category only

  // single-flight locks (avoid double-click dupes)
  let __savingCat = false;
  let __savingSub = false;
  let __savingSubOrder = false;
  let __savingCatOrder = false;
  let __bulkAppendBusy = false;
  let __bulkReplaceBusy = false;

  // ---- Ensure sidebar item exists (if not in HTML)
  function ensureCategorySidebarItem() {
    const sidebar = document.querySelector('.sidebar');
    if (!sidebar) return;
    if (!sidebar.querySelector('li[data-tab="categoryTab"]')) {
      const li = document.createElement('li');
      li.setAttribute('data-tab', 'categoryTab');
      li.textContent = 'Category Manager';
      sidebar.appendChild(li);

      // attach click (mirroring your existing handler)
      li.addEventListener('click', () => {
        $$('.sidebar li').forEach(t => t.classList.remove('active'));
        li.classList.add('active');
        $$('.tab-content').forEach(sec => sec.style.display = 'none');
        $('#categoryTab').style.display = 'block';
        loadCategories();
      });
    }
  }
  ensureCategorySidebarItem();

  // ---- DOM refs
  const $catName = $('#catName');
  const $catIcon = $('#catIcon');
  const $catOrder = $('#catOrder');
  const $catActive = $('#catActive');
  const $catSubs = $('#catSubs');
  const $saveCat = $('#saveCatWithSubsBtn');
  const $resetCat = $('#resetCatFormBtn');

  const $catTabs = $('#catTabs');
  const $catList = $('#catList');
  const $saveCatOrderBtn = $('#saveCatOrderBtn');

  const $subTabsWrap = $('#subTabsWrap');
  const $subTabs = $('#subTabs');
  const $saveSubOrderBtn = $('#saveSubOrderBtn');
  const $closeSubEditorBtn = $('#closeSubEditorBtn');

  const $subEditor = $('#subcatEditor');
  const $subFor = $('#subcatFor');
  const $subTabsFor = $('#subTabsFor');
  const $closeSubEditorBtn2 = $('#closeSubEditorBtn2');

  const $subName = $('#subName');
  const $subOrder = $('#subOrder');
  const $subActive = $('#subActive');
  const $addSub = $('#addSubBtn');

  const $bulkSubs = $('#bulkSubs');
  const $bulkAppendBtn = $('#bulkAppendBtn');
  const $bulkReplaceBtn = $('#bulkReplaceBtn');

  const $subList = $('#subList');

  // ---- Parse "Name|order|active"
  function parseSubLine(line, defaultOrder) {
    const parts = line.split('|').map(s => s.trim());
    if (!parts[0]) return null;
    const name = parts[0];
    const order = parts[1] ? Number(parts[1]) : defaultOrder;
    const active = (parts[2] === undefined) ? true : (String(parts[2]).toLowerCase() !== 'false');
    return { name, order: isNaN(order) ? defaultOrder : order, active };
  }

  // ---- Load categories (ordered)
  async function fetchCategories() {
    try {
      const snap = await db.collection('categories').orderBy('order', 'asc').get();
      return snap.docs.map(d => ({ id: d.id, ...d.data() }));
    } catch (e) {
      console.warn('orderBy(order) failed, fallback without order:', e);
      const snap = await db.collection('categories').get();
      const arr = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      arr.sort((a, b) => (a.order || 0) - (b.order || 0) || String(a.name || '').localeCompare(b.name || ''));
      return arr;
    }
  }

  // ---- Load subcategories for a cat
  async function fetchSubs(catId) {
    try {
      const snap = await db.collection('categories').doc(catId).collection('subcategories').orderBy('order', 'asc').get();
      return snap.docs.map(d => ({ id: d.id, ...d.data() }));
    } catch (e) {
      console.warn('sub orderBy fallback:', e);
      const snap = await db.collection('categories').doc(catId).collection('subcategories').get();
      const arr = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      arr.sort((a, b) => (a.order || 0) - (b.order || 0) || String(a.name || '').localeCompare(b.name || ''));
      return arr;
    }
  }

  // ---- Render: Category tabs
  function renderCatTabs() {
    $catTabs.innerHTML = '';
    catCache.forEach((c) => {
      const tab = document.createElement('div');
      tab.className = 'cat-pill';
      tab.draggable = true;
      tab.dataset.id = c.id;
      tab.style.cssText = 'border:1px solid #dbeafe;padding:6px 10px;border-radius:999px;background:#f0f7ff;font-weight:600;cursor:grab;display:inline-flex;align-items:center;gap:6px;';
      tab.innerHTML = `
        <span>${c.name || '(no name)'}</span>
        ${c.active === false ? '<small style="color:#ef4444">(inactive)</small>' : ''}
      `;
      $catTabs.appendChild(tab);
    });
    enableReorder($catTabs, '.cat-pill', () => setBtnEnabled($saveCatOrderBtn, true));
  }

  // ---- Render: Category cards
  async function renderCatList() {
    $catList.innerHTML = '';
    if (!catCache.length) {
      $catList.innerHTML = '<div style="padding:10px;color:#666;">No categories yet.</div>';
      return;
    }
    catCache.forEach(c => {
      const card = document.createElement('div');
      card.className = 'cat-card';
      card.style.cssText = 'border:1px solid #eee;border-radius:10px;padding:12px;display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;background:#fff;';
      card.innerHTML = `
        <div style="display:flex;gap:12px;align-items:center;">
          <div style="width:40px;height:40px;border-radius:10px;background:#f1f5f9;display:flex;align-items:center;justify-content:center;">
            <i class="${c.icon || 'fa-solid fa-tags'}"></i>
          </div>
          <div>
            <div style="font-weight:700">${c.name || '(unnamed)'} ${c.active === false ? '<span style="color:#ef4444;font-weight:600;font-size:12px;">(inactive)</span>' : ''}</div>
            <div style="font-size:12px;color:#6b7280">order: ${c.order ?? '-'} â€¢ id: ${c.id}</div>
          </div>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;">
          <button class="btn-view" data-role="sub" data-id="${c.id}">Subcategories</button>
          <button class="approve-btn" data-role="edit" data-id="${c.id}">Edit</button>
          <button class="btn-delete" data-role="del" data-id="${c.id}">Delete</button>
        </div>
      `;
      $catList.appendChild(card);
    });

    // Actions
    $$('#catList .btn-view, #catList .approve-btn, #catList .btn-delete').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        const id = e.currentTarget.dataset.id;
        const role = e.currentTarget.dataset.role;
        const cat = catCache.find(x => x.id === id);
        if (!cat) return;

        if (role === 'edit') {
          editingCatId = cat.id;
          $catName.value = cat.name || '';
          $catIcon.value = cat.icon || '';
          $catOrder.value = Number(cat.order || 1);
          $catActive.checked = (cat.active !== false);

          // Prefill textarea with current subs (Name|order|active)
          const subs = await fetchSubs(cat.id);
          $catSubs.value = subs.map(s => `${s.name || ''}|${s.order ?? ''}|${s.active !== false}`).join('\n');
          $saveCat.textContent = 'Update Category (+ optional sub changes in Sub Editor)';
          toast('Editing mode: Category loaded.');
        }

        if (role === 'del') {
          if (!confirm(`Delete category "${cat.name}"? This will remove ALL its subcategories too.`)) return;
          await deleteCategoryWithSubs(cat.id);
          toast('Category deleted', 'success');
          await loadCategories();
        }

        if (role === 'sub') {
          openSubEditor(cat);
        }
      });
    });
  }

  // ---- Open Sub Editor for a category
  async function openSubEditor(cat) {
    currentSubCatParentId = cat.id;
    $subTabsFor.textContent = cat.name || '';
    $subFor.textContent = cat.name || '';
    show($subTabsWrap);
    show($subEditor);
    await loadSubcategories(cat.id);
  }

  // ---- Load categories and render
  async function loadCategories() {
    try {
      catCache = await fetchCategories();
      renderCatTabs();
      renderCatList();
      setBtnEnabled($saveCatOrderBtn, false);
    } catch (e) {
      console.error(e);
      toast('Failed to load categories', 'error');
    }
  }
  window.loadCategories = loadCategories; // called from your tab switcher

  // ---- Load subcategories of current cat and render
  async function loadSubcategories(catId) {
    try {
      subCache = await fetchSubs(catId);
      renderSubTabs();
      renderSubList();
      setBtnEnabled($saveSubOrderBtn, false);
    } catch (e) {
      console.error(e);
      toast('Failed to load subcategories', 'error');
    }
  }

  function renderSubTabs() {
    $subTabs.innerHTML = '';
    subCache.forEach(s => {
      const tab = document.createElement('div');
      tab.className = 'sub-pill';
      tab.draggable = true;
      tab.dataset.id = s.id;
      tab.style.cssText = 'border:1px solid #e5e7eb;padding:6px 10px;border-radius:999px;background:#fafafa;cursor:grab;font-weight:600;';
      tab.textContent = s.name || '(sub)';
      $subTabs.appendChild(tab);
    });
    enableReorder($subTabs, '.sub-pill', () => setBtnEnabled($saveSubOrderBtn, true));
  }

  function renderSubList() {
    $subList.innerHTML = '';
    if (!subCache.length) {
      $subList.innerHTML = '<div style="padding:10px;color:#666;">No subcategories.</div>';
      return;
    }
    subCache.forEach(s => {
      const row = document.createElement('div');
      row.className = 'sub-row';
      row.draggable = true;
      row.dataset.id = s.id;
      row.style.cssText = 'display:flex;justify-content:space-between;align-items:center;border:1px solid #eee;background:#fff;border-radius:10px;padding:10px;margin-bottom:8px;cursor:grab;';
      row.innerHTML = `
        <div>
          <div style="font-weight:700">${s.name || '(unnamed)'} ${s.active === false ? '<span style="color:#ef4444;font-weight:600;font-size:12px;">(inactive)</span>' : ''}</div>
          <div style="font-size:12px;color:#6b7280">order: ${s.order ?? '-'} â€¢ id: ${s.id}</div>
        </div>
        <div style="display:flex;gap:8px;">
          <button class="approve-btn" data-role="editSub" data-id="${s.id}">Edit</button>
          <button class="btn-delete" data-role="delSub" data-id="${s.id}">Delete</button>
        </div>
      `;
      $subList.appendChild(row);
    });
    enableReorder($subList, '.sub-row', () => setBtnEnabled($saveSubOrderBtn, true));

    // Row actions
    $$('#subList .approve-btn, #subList .btn-delete').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        const id = e.currentTarget.dataset.id;
        const role = e.currentTarget.dataset.role;
        const s = subCache.find(x => x.id === id);
        if (!s) return;

        if (role === 'editSub') {
          // prefill single inputs
          $subName.value = s.name || '';
          $subOrder.value = Number(s.order || 1);
          $subActive.checked = (s.active !== false);
          $addSub.textContent = 'Update Subcategory';
          $addSub.dataset.editingId = id;
          $subName.focus();
        }

        if (role === 'delSub') {
          if (!confirm(`Delete subcategory "${s.name}"?`)) return;
          await db.collection('categories').doc(currentSubCatParentId).collection('subcategories').doc(id).delete();
          toast('Subcategory deleted', 'success');
          await loadSubcategories(currentSubCatParentId);
        }
      });
    });
  }

  // ---- Drag & drop reorder (generic)
  function enableReorder(container, itemSelector, onDirty) {
    let dragEl = null;
    container.querySelectorAll(itemSelector).forEach(el => {
      el.addEventListener('dragstart', (e) => {
        dragEl = el;
        el.style.opacity = '0.5';
        e.dataTransfer.effectAllowed = 'move';
      });
      el.addEventListener('dragend', () => {
        dragEl.style.opacity = '';
        dragEl = null;
      });
      el.addEventListener('dragover', (e) => {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        const target = e.currentTarget;
        if (!dragEl || dragEl === target) return;
        const rect = target.getBoundingClientRect();
        const before = (e.clientY - rect.top) < (rect.height / 2);
        container.insertBefore(dragEl, before ? target : target.nextSibling);
        if (onDirty) onDirty();
      });
    });
  }

  // ---- Save category + optional initial subs (on NEW only)
  $saveCat.addEventListener('click', async () => {
    if (__savingCat) return;
    __savingCat = true;
    setBtnEnabled($saveCat, false);

    const name = ($catName.value || '').trim();
    if (!name) { toast('Category name required', 'error'); __savingCat = false; setBtnEnabled($saveCat, true); return; }
    const icon = ($catIcon.value || '').trim();
    const order = Number($catOrder.value || 1);
    const active = $catActive.checked;

    try {
      if (!editingCatId) {
        // NEW: deterministic doc id to prevent duplicates
        const categoryId = toId(name);
        const catRef = db.collection('categories').doc(categoryId);

        await catRef.set({
          name, icon, order: isNaN(order) ? 1 : order, active,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true }); // overwrite if same slug exists

        // create subs from textarea (Name|order|active) using deterministic IDs
        const lines = ($catSubs.value || '').split('\n').map(x => x.trim()).filter(Boolean);
        if (lines.length) {
          const batch = db.batch();
          lines.forEach((ln, idx) => {
            const parsed = parseSubLine(ln, idx + 1);
            if (!parsed || !parsed.name) return;
            const subId = toId(parsed.name);
            const subRef = catRef.collection('subcategories').doc(subId);
            batch.set(subRef, {
              name: parsed.name,
              order: parsed.order,
              active: parsed.active,
              createdAt: firebase.firestore.FieldValue.serverTimestamp(),
              updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true });
          });
          await batch.commit();
        }
        toast('Category created', 'success');
      } else {
        // UPDATE: keep same doc id for existing
        await db.collection('categories').doc(editingCatId).update({
          name, icon, order: isNaN(order) ? 1 : order, active,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        toast('Category updated', 'success');
      }

      // reset + reload
      resetCategoryForm();
      await loadCategories();
    } catch (e) {
      console.error(e);
      toast('Failed to save category', 'error');
    } finally {
      __savingCat = false;
      setBtnEnabled($saveCat, true);
    }
  });

  function resetCategoryForm() {
    editingCatId = null;
    $catName.value = '';
    $catIcon.value = '';
    $catOrder.value = 1;
    $catActive.checked = true;
    $catSubs.value = '';
    $saveCat.textContent = 'Save Category + Subcategories';
  }
  $resetCat.addEventListener('click', resetCategoryForm);

  // ---- Save Category Order from tabs
  $saveCatOrderBtn.addEventListener('click', async () => {
    if (__savingCatOrder) return;
    __savingCatOrder = true;
    try {
      const ids = Array.from($catTabs.children).map((el, idx) => ({ id: el.dataset.id, order: idx + 1 }));
      for (let i = 0; i < ids.length; i += 400) {
        const batch = db.batch();
        ids.slice(i, i + 400).forEach(({ id, order }) => {
          batch.update(db.collection('categories').doc(id), { order, updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
        });
        await batch.commit();
      }
      toast('Category order saved', 'success');
      setBtnEnabled($saveCatOrderBtn, false);
      await loadCategories();
    } catch (e) {
      console.error(e); toast('Failed to save order', 'error');
    } finally {
      __savingCatOrder = false;
    }
  });

  // ---- Close Sub Editor
  function closeSubEditor() {
    hide($subTabsWrap);
    hide($subEditor);
    currentSubCatParentId = null;
    subCache = [];
    $subName.value = '';
    $subOrder.value = 1;
    $subActive.checked = true;
    $addSub.textContent = 'Add Subcategory';
    delete $addSub.dataset.editingId;
    $bulkSubs.value = '';
  }
  $closeSubEditorBtn.addEventListener('click', closeSubEditor);
  $closeSubEditorBtn2.addEventListener('click', closeSubEditor);

  // ---- Add / Update single sub (deterministic IDs)
  $addSub.addEventListener('click', async () => {
    if (__savingSub) return;
    __savingSub = true;
    setBtnEnabled($addSub, false);

    try {
      if (!currentSubCatParentId) { toast('Open a category first', 'error'); return; }
      const name = ($subName.value || '').trim();
      if (!name) { toast('Subcategory name required', 'error'); return; }
      const order = Number($subOrder.value || 1);
      const active = $subActive.checked;

      const col = db.collection('categories').doc(currentSubCatParentId).collection('subcategories');
      const editingId = $addSub.dataset.editingId;

      if (editingId) {
        await col.doc(editingId).update({
          name, order: isNaN(order) ? 1 : order, active,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        toast('Subcategory updated', 'success');
      } else {
        const subId = toId(name);
        await col.doc(subId).set({
          name, order: isNaN(order) ? 1 : order, active,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true }); // prevents duplicate by same slug
        toast('Subcategory added', 'success');
      }

      // reset mini form
      $subName.value = ''; $subOrder.value = 1; $subActive.checked = true; $addSub.textContent = 'Add Subcategory'; delete $addSub.dataset.editingId;

      await loadSubcategories(currentSubCatParentId);
    } catch (e) {
      console.error(e); toast('Failed to save subcategory', 'error');
    } finally {
      __savingSub = false;
      setBtnEnabled($addSub, true);
    }
  });

  // ---- Bulk Append (deterministic IDs; upserts)
  $bulkAppendBtn.addEventListener('click', async () => {
    if (__bulkAppendBusy) return;
    __bulkAppendBusy = true;

    try {
      if (!currentSubCatParentId) { toast('Open a category first', 'error'); return; }
      const lines = ($bulkSubs.value || '').split('\n').map(x => x.trim()).filter(Boolean);
      if (!lines.length) { toast('Nothing to append', 'error'); return; }

      const col = db.collection('categories').doc(currentSubCatParentId).collection('subcategories');
      const batch = db.batch();
      // Start after last order
      const startOrder = (subCache[subCache.length - 1]?.order || 0);

      let i = 0;
      lines.forEach((ln, idx) => {
        const parsed = parseSubLine(ln, startOrder + idx + 1);
        if (!parsed || !parsed.name) return;
        const subId = toId(parsed.name);
        const ref = col.doc(subId);
        batch.set(ref, {
          name: parsed.name, order: parsed.order, active: parsed.active,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true }); // upsert
        i++;
      });
      await batch.commit();
      toast(`Appended/Upserted ${i} subcategories`, 'success');
      await loadSubcategories(currentSubCatParentId);
    } catch (e) { console.error(e); toast('Bulk append failed', 'error'); }
    finally { __bulkAppendBusy = false; }
  });

  // ---- Bulk Replace (deterministic IDs)
  $bulkReplaceBtn.addEventListener('click', async () => {
    if (__bulkReplaceBusy) return;
    __bulkReplaceBusy = true;

    try {
      if (!currentSubCatParentId) { toast('Open a category first', 'error'); return; }
      if (!confirm('Replace ALL existing subcategories with the new list?')) return;
      const lines = ($bulkSubs.value || '').split('\n').map(x => x.trim()).filter(Boolean);

      const col = db.collection('categories').doc(currentSubCatParentId).collection('subcategories');
      // delete existing (chunked)
      for (let i = 0; i < subCache.length; i += 400) {
        const batch = db.batch();
        subCache.slice(i, i + 400).forEach(s => {
          batch.delete(col.doc(s.id));
        });
        await batch.commit();
      }
      // create new with deterministic IDs
      const batch2 = db.batch();
      lines.forEach((ln, idx) => {
        const parsed = parseSubLine(ln, idx + 1);
        if (!parsed || !parsed.name) return;
        const ref = col.doc(toId(parsed.name));
        batch2.set(ref, {
          name: parsed.name, order: parsed.order, active: parsed.active,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
      });
      await batch2.commit();
      toast('Replaced all subcategories', 'success');
      await loadSubcategories(currentSubCatParentId);
    } catch (e) { console.error(e); toast('Bulk replace failed', 'error'); }
    finally { __bulkReplaceBusy = false; }
  });

  // ---- Save Sub Order
  $saveSubOrderBtn.addEventListener('click', async () => {
    if (__savingSubOrder) return;
    __savingSubOrder = true;

    try {
      if (!currentSubCatParentId) return;
      // Use subList DOM order
      const ids = Array.from($subList.children).map((el, idx) => ({ id: el.dataset.id, order: idx + 1 }));
      for (let i = 0; i < ids.length; i += 400) {
        const batch = db.batch();
        ids.slice(i, i + 400).forEach(({ id, order }) => {
          batch.update(
            db.collection('categories').doc(currentSubCatParentId).collection('subcategories').doc(id),
            { order, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }
          );
        });
        await batch.commit();
      }
      toast('Sub order saved', 'success');
      setBtnEnabled($saveSubOrderBtn, false);
      await loadSubcategories(currentSubCatParentId);
    } catch (e) { console.error(e); toast('Failed to save sub order', 'error'); }
    finally { __savingSubOrder = false; }
  });

  // ---- Delete category + subs
  async function deleteCategoryWithSubs(catId) {
    const col = db.collection('categories').doc(catId).collection('subcategories');
    // delete subs first
    const snap = await col.get();
    const subs = snap.docs;
    for (let i = 0; i < subs.length; i += 400) {
      const batch = db.batch();
      subs.slice(i, i + 400).forEach(d => batch.delete(col.doc(d.id)));
      await batch.commit();
    }
    // delete category
    await db.collection('categories').doc(catId).delete();
  }

  // ---- OPTIONAL: auto-load when opening tab for first time
  document.addEventListener('DOMContentLoaded', () => {
    // no-op here (we rely on your tab switcher)
  });

})();
</script>
<script>
  
  

  const overlay = $("bbLoginOverlay");
  const app     = $("bbAdminApp");
  const msgBox  = $("bbMsg");
  const btn     = $("bbLoginBtn");
  const btnTxt  = $("bbBtnText");

  function showMsg(text, ok=false){
    if(!msgBox) return;
    msgBox.className = "bb-msg " + (ok ? "bb-ok" : "bb-err");
    msgBox.style.display = "block";
    msgBox.textContent = text;
  }
  function clearMsg(){ if(msgBox){ msgBox.style.display = "none"; msgBox.textContent = ""; } }
  function setBusy(b){
    if(!btn || !btnTxt) return;
    if(b){ btn.setAttribute("disabled","true"); btnTxt.innerHTML = '<span class="bb-spin"></span>Signing inâ€¦'; }
    else { btn.removeAttribute("disabled"); btnTxt.textContent = "Login"; }
  }
  function allowUI(){ if(overlay) overlay.style.display = "none"; if(app) app.style.display = "block"; }
  function blockUI(){ if(app) app.style.display = "none"; if(overlay) overlay.style.display = "flex"; }

  function resetLoginUI(){
    clearMsg();
    setBusy(false);
    $("bbLoginForm")?.reset();
    $("bbEmail")?.focus();
  }
  function showLogin(){
    blockUI();
    resetLoginUI();
  }

  // Remember if this session was verified once; don't kick the user out automatically later
  let adminVerified = localStorage.getItem('bb_admin_ok') === '1';
  function setAdminVerified(v){
    adminVerified = !!v;
    try{ localStorage.setItem('bb_admin_ok', v ? '1' : '0'); }catch(_){}
  }

  firebase.auth().setPersistence(firebase.auth.Auth.Persistence.LOCAL).catch(()=>{});

  async function verifyOnServerStatus(user){
    try{
      const token = await user.getIdToken(true);
      const res = await fetch(`${FN_BASE}/check-admin`, {
        method: 'GET',
        headers: { Authorization: 'Bearer ' + token }
      });
      return res.status; // 200, 403, 401, 500, etc.
    }catch(_){
      return 0; // network / unexpected
    }
  }

  firebase.auth().onAuthStateChanged(async (user)=>{
    if(!user){ setAdminVerified(false); showLogin(); return; }

    const status = await verifyOnServerStatus(user);

    if(status === 200){
      setAdminVerified(true);
      allowUI();
      return;
    }

    if(status === 403){
      // Not an admin: keep session, just block admin UI
      setAdminVerified(false);
      blockUI();
      showMsg("This account is not authorized for Admin. Use an admin email to continue.", false);
      return;
    }

    // Network/Server hiccup or 401 without token:
    if(adminVerified){
      // Already verified before â€” keep UI visible, don't sign out
      allowUI();
      // optional: show a subtle message if you want
      // showMsg("Temporary verification issue. Continuing with last verified session.", true);
    }else{
      // Not verified yet â€” block UI but do not sign out
      blockUI();
      showMsg("Verification is temporarily unavailable. Please try again or log in with an admin account.", false);
    }
  });

  $("bbLoginForm")?.addEventListener("submit", async (e)=>{
    e.preventDefault();
    clearMsg(); setBusy(true);
    try{
      const email = $("bbEmail").value.trim();
      const pass  = $("bbPass").value;
      await firebase.auth().signInWithEmailAndPassword(email, pass);
      setBusy(false);
      showMsg("Login successful. Verifyingâ€¦", true);
      // allowUI() will happen after verify in onAuthStateChanged
    } catch (err) {
  setBusy(false);
  const { title, message } = friendlyAuthError(err);
  showAlert({ type:'error', title, message });
}
  });

  $("bbSignOutBtn")?.addEventListener("click", async ()=>{
    try{ await firebase.auth().signOut(); }catch(_){}
    setAdminVerified(false);
    showLogin(); // show login overlay instantly, no reload
  });
  
  function showAlert({ type='error', title='', message='' }){
  if(!msgBox) return;
  msgBox.className = 'bb-msg ' + (type==='success' ? 'bb-ok' : 'bb-err');
  msgBox.style.display = 'flex';
  msgBox.innerHTML = `
    <span class="bb-title">${title || (type==='success'?'Success':'Sign-in failed')}</span>
    <span>${message}</span>
    <button class="bb-close" aria-label="Close" onclick="this.parentElement.style.display='none'">Ã—</button>
  `;
}
function friendlyAuthError(err){
  const code = err?.code || '';
  const raw  = (err?.message || '').toUpperCase();
  if (code === 'auth/invalid-credential' || code === 'auth/invalid-login-credentials' || code === 'auth/wrong-password' || raw.includes('INVALID_LOGIN_CREDENTIALS')) {
    return { title:'Incorrect email or password', message:'Please double-check your credentials and try again.' };
  }
  if (code === 'auth/user-not-found') {
    return { title:'Account not found', message:'No account exists with this email. Create one or try a different email.' };
  }
  if (code === 'auth/invalid-email') {
    return { title:'Invalid email', message:'Enter a valid email address (e.g., name@example.com).' };
  }
  if (code === 'auth/user-disabled') {
    return { title:'Account disabled', message:'This account is disabled. Contact support if you think this is a mistake.' };
  }
  if (code === 'auth/too-many-requests') {
    return { title:'Too many attempts', message:'Weâ€™ve temporarily blocked sign-in due to unusual activity. Please wait a bit or reset your password.' };
  }
  if (code === 'auth/network-request-failed') {
    return { title:'Network error', message:'Check your internet connection and try again.' };
  }
  return { title:'Login failed', message:'An unexpected error occurred. Please try again.' };
}

</script>
<script>
  (function(){
  // === Admin Login/Auth Namespace ===
  const BBAdmin = {};

  // âœ… Single base path (shared)
  window.FN_BASE = window.FN_BASE || 'https://bechobazaar.netlify.app/.netlify/functions';

  // --- UI References (unique)
  BBAdmin.overlay   = $("bbLoginOverlay");
  BBAdmin.appUI     = $("bbAdminApp");
  BBAdmin.msgBox    = $("bbMsg");
  BBAdmin.btn       = $("bbLoginBtn");
  BBAdmin.btnTxt    = $("bbBtnText");

  // === UI Helpers ===
  BBAdmin.showMsg = function (text, ok = false) {
    const box = BBAdmin.msgBox;
    if (!box) return;
    box.className = "bb-msg " + (ok ? "bb-ok" : "bb-err");
    box.style.display = "block";
    box.textContent = text;
  };

  BBAdmin.clearMsg = function () {
    const box = BBAdmin.msgBox;
    if (box) {
      box.style.display = "none";
      box.textContent = "";
    }
  };

  BBAdmin.setBusy = function (busy) {
    const btn = BBAdmin.btn, txt = BBAdmin.btnTxt;
    if (!btn || !txt) return;
    if (busy) {
      btn.setAttribute("disabled", "true");
      txt.innerHTML = '<span class="bb-spin"></span>Signing inâ€¦';
    } else {
      btn.removeAttribute("disabled");
      txt.textContent = "Login";
    }
  };

  BBAdmin.allowUI = function () {
    if (BBAdmin.overlay) BBAdmin.overlay.style.display = "none";
    if (BBAdmin.appUI) BBAdmin.appUI.style.display = "block";
  };

  BBAdmin.blockUI = function () {
    if (BBAdmin.appUI) BBAdmin.appUI.style.display = "none";
    if (BBAdmin.overlay) BBAdmin.overlay.style.display = "flex";
  };

  BBAdmin.resetLoginUI = function () {
    BBAdmin.clearMsg();
    BBAdmin.setBusy(false);
    $("bbLoginForm")?.reset();
    $("bbEmail")?.focus();
  };

  BBAdmin.showLogin = function () {
    BBAdmin.blockUI();
    BBAdmin.resetLoginUI();
  };

  // === Session Persistence Flag (scoped)
  BBAdmin.verified = localStorage.getItem('bb_admin_ok') === '1';

  BBAdmin.setVerified = function (v) {
    BBAdmin.verified = !!v;
    try { localStorage.setItem('bb_admin_ok', v ? '1' : '0'); } catch(_) {}
  };

  // Keep Firebase session persistent
  firebase.auth().setPersistence(firebase.auth.Auth.Persistence.LOCAL).catch(()=>{});

  // === Verify Admin on Server ===
  BBAdmin.verifyServerStatus = async function (user) {
    try {
      const token = await user.getIdToken(true);
      const res = await fetch(`${window.FN_BASE}/check-admin`, {
        method: 'GET',
        headers: { Authorization: 'Bearer ' + token }
      });
      return res.status;
    } catch {
      return 0;
    }
  };

  // === Auth State Change Listener ===
  firebase.auth().onAuthStateChanged(async (user)=>{
    if(!user){ BBAdmin.setVerified(false); BBAdmin.showLogin(); return; }

    const status = await BBAdmin.verifyServerStatus(user);

    if(status === 200){
      BBAdmin.setVerified(true);
      BBAdmin.allowUI();
      return;
    }

    if(status === 403){
      BBAdmin.setVerified(false);
      BBAdmin.blockUI();
      BBAdmin.showMsg("This account is not authorized for Admin. Use an admin email to continue.", false);
      return;
    }

    // network / unknown error
    if(BBAdmin.verified){
      BBAdmin.allowUI();
    } else {
      BBAdmin.blockUI();
      BBAdmin.showMsg("Verification is temporarily unavailable. Please try again or log in with an admin account.", false);
    }
  });

  // === Login Submit ===
  $("bbLoginForm")?.addEventListener("submit", async (e)=>{
    e.preventDefault();
    BBAdmin.clearMsg();
    BBAdmin.setBusy(true);
    try{
      const email = $("bbEmail").value.trim();
      const pass  = $("bbPass").value;
      await firebase.auth().signInWithEmailAndPassword(email, pass);
      BBAdmin.setBusy(false);
      BBAdmin.showMsg("Login successful. Verifyingâ€¦", true);
    }catch(err){
      BBAdmin.setBusy(false);
      const { title, message } = friendlyAuthError(err);
      BBAdmin.showAlert({ type:'error', title, message });
    }
  });

  // === Sign Out ===
  $("bbSignOutBtn")?.addEventListener("click", async ()=>{
    try{ await firebase.auth().signOut(); }catch(_){}
    BBAdmin.setVerified(false);
    BBAdmin.showLogin();
  });

  // === Alerts ===
  BBAdmin.showAlert = function({ type='error', title='', message='' }){
    const box = BBAdmin.msgBox;
    if(!box) return;
    box.className = 'bb-msg ' + (type==='success' ? 'bb-ok' : 'bb-err');
    box.style.display = 'flex';
    box.innerHTML = `
      <span class="bb-title">${title || (type==='success'?'Success':'Sign-in failed')}</span>
      <span>${message}</span>
      <button class="bb-close" aria-label="Close" onclick="this.parentElement.style.display='none'">Ã—</button>
    `;
  };

  // === Error Mapper ===
  function friendlyAuthError(err){
    const code = err?.code || '';
    const raw  = (err?.message || '').toUpperCase();

    if (code === 'auth/invalid-credential' || code === 'auth/invalid-login-credentials' || code === 'auth/wrong-password' || raw.includes('INVALID_LOGIN_CREDENTIALS')) {
      return { title:'Incorrect email or password', message:'Please double-check your credentials and try again.' };
    }
    if (code === 'auth/user-not-found') {
      return { title:'Account not found', message:'No account exists with this email.' };
    }
    if (code === 'auth/invalid-email') {
      return { title:'Invalid email', message:'Enter a valid email address (e.g., name@example.com).' };
    }
    if (code === 'auth/user-disabled') {
      return { title:'Account disabled', message:'This account is disabled. Contact support.' };
    }
    if (code === 'auth/too-many-requests') {
      return { title:'Too many attempts', message:'Temporarily blocked. Please try again later.' };
    }
    if (code === 'auth/network-request-failed') {
      return { title:'Network error', message:'Check your internet connection and try again.' };
    }
    return { title:'Login failed', message:'An unexpected error occurred. Please try again.' };
  }

})(); // end closure
</script>

<script>
  // ======================
  // Abuse / Same-IP module
  // ======================
  window.FN_BASE = window.FN_BASE || "https://bechobazaar.netlify.app/.netlify/functions";

  /* ===== auth-safe helpers ===== */
  function waitForFirebaseAuth(timeoutMs = 12000) {
    return new Promise((resolve, reject) => {
      let tries = 0;
      const tick = setInterval(() => {
        tries++;
        if (window.firebase && firebase.apps && firebase.apps.length) {
          clearInterval(tick);
          resolve(firebase.auth());
        } else if (tries > 60) {
          clearInterval(tick);
          reject(new Error('Firebase not initialized on this page.'));
        }
      }, 200);
    });
  }
  async function getAdminIdTokenSafe(timeoutMs = 15000) {
    const auth = await waitForFirebaseAuth();
    if (auth.currentUser) return await auth.currentUser.getIdToken(true);
    return await new Promise((resolve, reject) => {
      const timer = setTimeout(() => { unsub(); reject(new Error('Not signed in. Please log in as admin.')); }, timeoutMs);
      const unsub = auth.onAuthStateChanged(async (user) => {
        if (!user) return;
        clearTimeout(timer); unsub();
        try { resolve(await user.getIdToken(true)); } catch (e) { reject(e); }
      }, (err) => { clearTimeout(timer); unsub(); reject(err || new Error('Auth state subscription error')); });
    });
  }
  async function adminFetch(path, init = {}) {
    const t = await getAdminIdTokenSafe();
    const headers = Object.assign({}, init.headers, { Authorization: 'Bearer ' + t });
    return fetch(FN_BASE + path, Object.assign({}, init, { headers }));
  }

  /* ===== utils ===== */
  function fmtDate(x){ if(!x) return 'â€”'; const d=new Date(x); return d.toLocaleString(); }

  /* ===== state ===== */
  const AB = { mode:'lastip', raw:[], rawLast:[], minUids:2, q:'' };
  const RowState = new Map();        // ipKey -> { allSuspended:boolean }
  const ContactCache = new Map();    // uid -> { email, phone }  (for reverse index)

  /* ===== UID->contact fetch (reverse index) ===== */
  async function fetchBriefForUids(uids){
    const missing = uids.filter(u => !ContactCache.has(u));
    if (!missing.length) return;
    const res = await adminFetch('/get-users-brief', {
      method:'POST', headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify({ uids: missing.slice(0,500) })
    });
    const data = await res.json();
    for (const u of (data.users||[])) {
      ContactCache.set(u.uid, { email: u.email || '', phone: u.phone || '' });
    }
  }

  /* ===== Tab wiring ===== */
  document.querySelector('[data-tab="abuseTab"]').addEventListener('click', ()=>{
    document.querySelectorAll('.tab-content').forEach(el=>el.style.display='none');
    document.getElementById('abuseTab').style.display='block';
    loadAbuseLastIP(); // default
  });
  document.getElementById('abMode').addEventListener('change', e=>{
    AB.mode = e.target.value || 'lastip';
    RowState.clear();
    if (AB.mode==='lastip') loadAbuseLastIP(); else loadAbuseData();
  });
  document.getElementById('abMinUids').addEventListener('change', e=>{
    AB.minUids=Number(e.target.value||2);
    AB.mode==='lastip'?renderAbListLastIP():renderAbList();
  });
  document.getElementById('abSearch').addEventListener('input', e=>{
    AB.q=(e.target.value||'').toLowerCase();
    AB.mode==='lastip'?renderAbListLastIP():renderAbList();
  });
  document.getElementById('abRefresh').addEventListener('click', ()=>{
    RowState.clear();
    AB.mode==='lastip'?loadAbuseLastIP():loadAbuseData();
  });

  /* ===== LOADERS ===== */
  async function loadAbuseLastIP(){
    const list = document.getElementById('abList');
    list.innerHTML = `<div class="list-item">Scanning users.lastIPâ€¦</div>`;
    try{
      const res = await adminFetch('/get-suspicious-lastip');
      const data = await res.json();
      AB.rawLast = data.results || [];
      RowState.clear();
      for (const g of AB.rawLast) {
        const allSusp = (g.users||[]).length && (g.users||[]).every(u=>!!u.suspended);
        RowState.set(g.ipKey, { allSuspended: allSusp });
      }
      renderAbListLastIP();
    }catch(e){
      list.innerHTML = `<div class="list-item">Error: ${e.message}</div>`;
    }
  }

  async function loadAbuseData(){ // reverse index
    const list = document.getElementById('abList');
    list.innerHTML = `<div class="list-item">Loading (reverse index)â€¦</div>`;
    try{
      const res = await adminFetch('/get-suspicious-ips');
      const data = await res.json();
      AB.raw = data.results || [];
      renderAbList();
    }catch(e){
      list.innerHTML = `<div class="list-item">Error: ${e.message}</div>`;
    }
  }

  /* ===== RENDERERS ===== */
  function renderButtonHTML(ipKey, label){
    return `<button class="delete-btn" data-ipkey="${ipKey}" onclick="bulkToggle('${ipKey}')">${label}</button>`;
  }

  /* ---- lastIP mode ---- */
  async function renderAbListLastIP(){
    const list = document.getElementById('abList');
    let rows = AB.rawLast.filter(r => (r.count||0) >= AB.minUids);

    // ðŸ”’ keep only IP rows having at least one valid email
    rows = rows.filter(r => {
      const arr = (r.emails && r.emails.length ? r.emails : (r.users||[]).map(u=>u.email)).filter(Boolean);
      return arr.some(e => (e||'').includes('@'));
    });

    // Search filter
    if (AB.q) {
      const q = AB.q;
      rows = rows.filter(r => {
        const ipMatch   = (r.ip||'').toLowerCase().includes(q);
        const uidMatch  = (r.users||[]).some(u => (u.uid||'').toLowerCase().includes(q));
        const emailMatch= (r.emails||[]).some(e => (e||'').toLowerCase().includes(q));
        const phoneMatch= (r.phones||[]).some(p => (p||'').toLowerCase().includes(q));
        return ipMatch || uidMatch || emailMatch || phoneMatch;
      });
    }
    if (!rows.length){ list.innerHTML = `<div class="list-item">No results</div>`; return; }

    list.innerHTML = rows.map(r=>{
      // ðŸ”’ email-only view
      const usersWithEmail = (r.users||[]).filter(u => (u.email||'').includes('@'));

      // Sample: UID â€¢ phone (first 4), email-only
      const sample = usersWithEmail.slice(0,4).map(u=>{
        const ph = u.phone ? ` â€¢ ${u.phone}` : '';
        return `<code title="${u.email} ${u.phone||''}">${u.uid}${ph}</code>`;
      }).join(' ');

      // Phones column: unique phones (first 5), email-only base
      const phones = Array.from(new Set(usersWithEmail.map(u=>u.phone).filter(Boolean)))
        .slice(0,5).join(', ') || 'â€”';

      const st = RowState.get(r.ipKey) || { allSuspended:false };
      const label = st.allSuspended ? 'Unblock All' : 'Block All';

      return `
        <div class="list-item" style="display:grid;grid-template-columns:220px 120px 1fr 220px 160px 220px;">
          <div>${r.ip}</div>
          <div>${usersWithEmail.length}</div>
          <div>${sample}</div>
          <div>${phones}</div>
          <div>${fmtDate(r.lastSeen)}</div>
          <div style="display:flex;gap:6px;flex-wrap:wrap;">
            <button class="btn-view" onclick='viewLastIP(${JSON.stringify(r).replace(/'/g,"&#39;")})'>View</button>
            ${renderButtonHTML(r.ipKey, label)}
          </div>
        </div>`;
    }).join('');
  }

  /* ---- reverse index mode ---- */
  async function renderAbList(){
    const list = document.getElementById('abList');
    let rows = AB.raw.filter(r => (r.uids||[]).length >= AB.minUids);
    const q = AB.q;

    // Search
    if (q) {
      const looksLikePhoneOrEmail = /[0-9+@]/.test(q);
      if (looksLikePhoneOrEmail) {
        const allUids = [...new Set(rows.flatMap(r => r.uids||[]))].slice(0,500);
        await fetchBriefForUids(allUids);
        rows = rows.filter(r=>{
          const ipMatch = (r.ip||'').toLowerCase().includes(q);
          const uidMatch = (r.uids||[]).some(u=> (u||'').toLowerCase().includes(q));
          const contactMatch = (r.uids||[]).some(u=>{
            const c = ContactCache.get(u);
            return c && ((c.phone||'').toLowerCase().includes(q) || (c.email||'').toLowerCase().includes(q));
          });
          return ipMatch || uidMatch || contactMatch;
        });
      } else {
        rows = rows.filter(r => (r.ip||'').toLowerCase().includes(q) || (r.uids||[]).some(u=>(u||'').toLowerCase().includes(q)));
      }
    }

    if (!rows.length){ list.innerHTML = `<div class="list-item">No results</div>`; return; }

    // ensure phones for first few UIDs per row (fills ContactCache)
    const needUids = [...new Set(rows.flatMap(r => (r.uids||[]).slice(0,5)))];
    await fetchBriefForUids(needUids);

    // ðŸ”’ hide rows where none of the UIDs have an email
    rows = rows.filter(r => (r.uids || []).some(uid => {
      const c = ContactCache.get(uid) || {};
      return c.email && c.email.includes('@');
    }));

    list.innerHTML = rows.map(r=>{
      // ðŸ”’ email-only set for contents + count
      const uidsWithEmail = (r.uids||[]).filter(uid => {
        const c = ContactCache.get(uid) || {};
        return c.email && c.email.includes('@');
      });

      // Sample from email-only uids
      const sample = uidsWithEmail.slice(0,5).map(uid=>{
        const c = ContactCache.get(uid) || {};
        const ph = c.phone ? ` â€¢ ${c.phone}` : '';
        return `<code title="${c.email} ${c.phone||''}">${uid}${ph}</code>`;
      }).join(' ');

      // Phones from email-only uids
      const phones = Array.from(
        new Set(uidsWithEmail.map(uid => (ContactCache.get(uid)||{}).phone).filter(Boolean))
      ).slice(0,5).join(', ') || 'â€”';

      const st = RowState.get(r.ipKey) || { allSuspended:false };
      const label = st.allSuspended ? 'Unblock All' : 'Block All';

      return `
        <div class="list-item" style="display:grid;grid-template-columns:220px 120px 1fr 220px 160px 220px;">
          <div>${r.ip||r.ipKey}</div>
          <div>${uidsWithEmail.length}</div>
          <div>${sample}</div>
          <div>${phones}</div>
          <div>${fmtDate(r.lastSeen)}</div>
          <div style="display:flex;gap:6px;flex-wrap:wrap;">
            <button class="btn-view" onclick="viewIP('${r.ipKey}')">View</button>
            ${renderButtonHTML(r.ipKey, label)}
          </div>
        </div>`;
    }).join('');
  }

  /* ===== MODALS ===== */
  function viewLastIP(group){
    // ðŸ”’ email-only users in modal
    const users = (group.users || []).filter(u => (u.email||'').includes('@'));
    const allSusp = users.length && users.every(u=>!!u.suspended);
    RowState.set(group.ipKey, { allSuspended: allSusp });

    document.getElementById('abuseModalBody').innerHTML = `
      <div><b>IP:</b> ${group.ip}</div>
      <div><b>Unique Accounts:</b> ${users.length}</div>
      <div><b>Emails:</b> ${(group.emails||[]).filter(e=>e&&e.includes('@')).join(', ') || 'â€”'}</div>
      <div><b>Phones:</b> ${Array.from(new Set(users.map(u=>u.phone).filter(Boolean))).slice(0,5).join(', ') || 'â€”'}</div>
      <h4 style="margin:10px 0 6px;">Accounts</h4>
      ${users.map(u=>`
        <div class="list-item" style="display:flex;justify-content:space-between;align-items:center;">
          <div>
            <div><code>${u.uid}</code></div>
            <div style="font-size:12px;color:#6b7280;">${u.email} Â· ${u.phone||'â€”'}</div>
            <div style="font-size:12px;color:#9ca3af;">Last: ${fmtDate(u.lastLogin||u.lastActive)}</div>
          </div>
          <div style="display:flex;gap:6px;">
            <button class="delete-btn" onclick="toggleUser('${group.ipKey}','${u.uid}', ${!!u.suspended})">
              ${u.suspended ? 'Un-suspend' : 'Suspend'}
            </button>
          </div>
        </div>
      `).join('')}
    `;
    document.getElementById('abuseModal').style.display = 'flex';
    AB.mode==='lastip' ? renderAbListLastIP() : renderAbList();
  }

  async function viewIP(ipKey){
    try{
      const r = await adminFetch('/get-ip-details?ipKey=' + encodeURIComponent(ipKey));
      const data = await r.json();

      // ðŸ”’ email-only UIDs for modal
      const allUids = data.uids || [];
      await fetchBriefForUids(allUids);
      const uids = allUids.filter(uid => {
        const c = ContactCache.get(uid) || {};
        return c.email && c.email.includes('@');
      });

      // get status for modal
      const statusRes = await adminFetch('/get-users-status', {
        method:'POST', headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({ uids })
      });
      const stData = await statusRes.json();
      const stMap = new Map((stData.statuses||[]).map(x=>[x.uid, !!x.suspended]));
      const allSusp = uids.length && uids.every(uid => stMap.get(uid)===true);
      RowState.set(ipKey, { allSuspended: allSusp });

      document.getElementById('abuseModalBody').innerHTML = `
        <div><b>IP:</b> ${data.ip||data.ipKey}</div>
        <div><b>Unique Accounts:</b> ${uids.length}</div>
        <h4 style="margin:10px 0 6px;">Accounts</h4>
        ${uids.map(uid=>{
          const c = ContactCache.get(uid) || {};
          return `
            <div class="list-item" style="display:flex;justify-content:space-between;align-items:center;">
              <div>
                <div><code>${uid}</code></div>
                <div style="font-size:12px;color:#6b7280;">${c.email} Â· ${c.phone||'â€”'}</div>
              </div>
              <div style="display:flex;gap:6px;">
                <button class="delete-btn" onclick="toggleUser('${ipKey}','${uid}', ${stMap.get(uid)===true})">
                  ${stMap.get(uid)===true ? 'Un-suspend' : 'Suspend'}
                </button>
              </div>
            </div>`;
        }).join('')}
      `;
      document.getElementById('abuseModal').style.display='flex';
      renderAbList();
    }catch(e){ alert('Error: '+e.message); }
  }

  /* ===== ACTIONS ===== */
  async function toggleUser(ipKey, uid, currentlySuspended){
    const action = currentlySuspended ? 'enable' : 'disable';
    try{
      await adminFetch('/admin-block-user', {
        method:'POST', headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({ uid, action })
      });
      // refresh status for this uid
      const res = await adminFetch('/get-users-status', {
        method:'POST', headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({ uids:[uid] })
      });
      const { statuses=[] } = await res.json();
      const newSusp = !!(statuses[0]?.suspended);

      if (AB.mode==='lastip') {
        const g = AB.rawLast.find(x=>x.ipKey===ipKey);
        if (g) {
          const u = (g.users||[]).find(x=>x.uid===uid);
          if (u) u.suspended = newSusp;
          const usersWithEmail = (g.users||[]).filter(x => (x.email||'').includes('@'));
          const allSusp = usersWithEmail.length && usersWithEmail.every(x=>!!x.suspended);
          RowState.set(ipKey, { allSuspended: allSusp });
          viewLastIP(g);
          renderAbListLastIP();
        }
      } else {
        await refreshIndexRowState(ipKey);
        viewIP(ipKey);
      }
    }catch(e){ alert('Fail: '+e.message); }
  }

  async function refreshIndexRowState(ipKey){
    const r = await adminFetch('/get-ip-details?ipKey=' + encodeURIComponent(ipKey));
    const d = await r.json();
    const allUids = d.uids || [];

    // ðŸ”’ recompute state only from email-present uids
    await fetchBriefForUids(allUids);
    const uids = allUids.filter(uid => {
      const c = ContactCache.get(uid) || {};
      return c.email && c.email.includes('@');
    });

    if (!uids.length) { RowState.set(ipKey,{allSuspended:false}); renderAbList(); return; }

    const st = await adminFetch('/get-users-status', {
      method:'POST', headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify({ uids })
    });
    const stData = await st.json();
    const allSusp = uids.every(uid => (stData.statuses||[]).find(s=>s.uid===uid)?.suspended === true);
    RowState.set(ipKey, { allSuspended: allSusp });
    renderAbList();
  }

  async function bulkToggle(ipKey){
    try{
      if (AB.mode==='lastip'){
        const g = AB.rawLast.find(x=>x.ipKey===ipKey);
        if (!g) return alert('Group not found');

        // ðŸ”’ act only on email-present users
        const usersWithEmail = (g.users||[]).filter(u => (u.email||'').includes('@'));

        const allSusp = usersWithEmail.length && usersWithEmail.every(u=>!!u.suspended);
        const desired = allSusp ? 'enable' : 'disable';

        for (const u of usersWithEmail) {
          await adminFetch('/admin-block-user', {
            method:'POST', headers:{ 'Content-Type':'application/json' },
            body: JSON.stringify({ uid: u.uid, action: desired })
          });
          u.suspended = (desired==='disable');
        }
        RowState.set(ipKey, { allSuspended: desired==='disable' });
        renderAbListLastIP();
        alert(allSusp ? 'All unblocked' : 'All blocked');
      } else {
        const r = await adminFetch('/get-ip-details?ipKey=' + encodeURIComponent(ipKey));
        const d = await r.json();
        const allUids = d.uids || [];

        await fetchBriefForUids(allUids);
        const uids = allUids.filter(uid => {
          const c = ContactCache.get(uid) || {};
          return c.email && c.email.includes('@');
        });
        if (!uids.length) return;

        const st = await adminFetch('/get-users-status', {
          method:'POST', headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({ uids })
        });
        const stData = await st.json();
        const allSusp = uids.every(uid => (stData.statuses||[]).find(s=>s.uid===uid)?.suspended === true);
        const desired = allSusp ? 'enable' : 'disable';

        for (const uid of uids){
          await adminFetch('/admin-block-user', {
            method:'POST', headers:{ 'Content-Type':'application/json' },
            body: JSON.stringify({ uid, action: desired })
          });
        }
        RowState.set(ipKey, { allSuspended: desired==='disable' });
        renderAbList();
        alert(allSusp ? 'All unblocked' : 'All blocked');
      }
    }catch(e){ alert('Bulk fail: '+e.message); }
  }

  /* ===== Modal close ===== */
  document.getElementById('abuseClose').addEventListener('click', ()=>{
    document.getElementById('abuseModal').style.display='none';
    document.getElementById('abuseModalBody').innerHTML='';
  });
  document.getElementById('abuseModal').addEventListener('click', (e)=>{
    if (e.target.id === 'abuseModal') {
      document.getElementById('abuseModal').style.display='none';
      document.getElementById('abuseModalBody').innerHTML='';
    }
  });
</script>


<script>

(function (w, d) {
  const FN_BASE = (w.FN_BASE || (location.origin + "/.netlify/functions")).replace(/\/$/, "");
  const CFG = { cacheMinutes: 0, maxTries: 5, cooldownMs: 60_000, brandColor: "#2563eb" };

  let mounted=false, tries=0, lockedUntil=0, purpose='', res=null, rej=null;
  const els = {}; const now = () => Date.now();

  // ---------- UI (modal) ----------
  function mount(){
    if(mounted) return; mounted = true;

    const style = d.createElement('style');
    style.textContent = `
#secureGate{position:fixed;inset:0;display:none;z-index:2147483647!important}
#secureGate *{box-sizing:border-box}
#secureGate .sg-overlay{
  position:fixed;inset:0;background:rgba(0,0,0,.35);z-index:2147483646!important;
  backdrop-filter:blur(6px); -webkit-backdrop-filter:blur(6px);
}
#secureGate .sg-card{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);width:min(92vw,420px);background:#fff;border-radius:12px;padding:16px;box-shadow:0 18px 48px rgba(2,6,23,.28);border:1px solid #e5e7eb;z-index:2147483647!important}
#secureGate .sg-title{margin:0 0 8px;font:600 17px/1.2 system-ui;color:#111}
#secureGate .sg-input{display:block!important;visibility:visible!important;opacity:1!important;width:100%;padding:10px 12px;border-radius:10px;border:1px solid #d1d5db;outline:none;font:15px system-ui;margin-bottom:10px;background:#fff;color:#111}
#secureGate .sg-input:focus{border-color:${CFG.brandColor};box-shadow:0 0 0 3px rgba(37,99,235,.12)}
#secureGate .sg-row{display:flex;justify-content:flex-end;gap:8px}
#secureGate .sg-btn{padding:8px 12px;border-radius:10px;border:1px solid ${CFG.brandColor};background:${CFG.brandColor};color:#fff;cursor:pointer}
#secureGate .sg-btn.sg-ghost{background:#fff;color:#111;border-color:#e5e7eb}
#secureGate .sg-hint{margin-top:10px;color:#b91c1c;font:13px/1 system-ui;min-height:18px}
.sg-shake{animation:sgShake .36s both}
@keyframes sgShake{10%,90%{transform:translate(-50%,-50%) translateX(-1px)}20%,80%{transform:translate(-50%,-50%) translateX(2px)}30%,50%,70%{transform:translate(-50%,-50%) translateX(-4px)}40%,60%{transform:translate(-50%,-50%) translateX(4px)}}
/* Body blur + noscroll while modal open */
body.sg-blur > *:not(#secureGate){filter:blur(6px);transition:filter .2s ease}
body.sg-noscroll{overflow:hidden}

/* HARD MASK for #totalAmountReceivedDashboard: real text is empty while locked */
#totalAmountReceivedDashboard.sg-locked{position:relative}
#totalAmountReceivedDashboard.sg-locked::before{content:attr(data-mask);position:relative}
    `;
    d.head.appendChild(style);

    const wrap = d.createElement('div');
    wrap.id = 'secureGate';
    wrap.innerHTML = `
      <div class="sg-overlay" data-close="1" aria-hidden="true"></div>
      <div class="sg-card" role="dialog" aria-modal="true" aria-label="Admin password required">
        <h3 class="sg-title">Enter Admin Password</h3>
        <input id="sgInput" type="password" class="sg-input" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password"/>
        <div style="font-size:13px;color:#555;margin-bottom:8px;">This action requires admin authentication.</div>
        <div class="sg-row">
          <button id="sgCancel" class="sg-btn sg-ghost" type="button">Cancel</button>
          <button id="sgSubmit" class="sg-btn" type="button">Unlock</button>
        </div>
        <p id="sgHint" class="sg-hint" aria-live="polite"></p>
      </div>`;
    d.body.appendChild(wrap);

    els.root = wrap;
    els.card = wrap.querySelector('.sg-card');
    els.input = d.getElementById('sgInput');
    els.hint  = d.getElementById('sgHint');

    d.getElementById('sgCancel').addEventListener('click', ()=>close(false));
    d.getElementById('sgSubmit').addEventListener('click', verify);
    els.input.addEventListener('keydown', e=>{ if(e.key==='Enter') verify(); });
    wrap.addEventListener('click', e=>{ if(e.target.dataset.close) close(false); });
  }

  // ---------- Gate helpers ----------
  function cached(p){
    if (CFG.cacheMinutes <= 0) return false;
    try {
      const raw = sessionStorage.getItem('sg:'+p);
      if(!raw) return false;
      const {ts} = JSON.parse(raw);
      return (now()-ts) < CFG.cacheMinutes*60_000;
    } catch { return false; }
  }
  function setCache(p){ try{ sessionStorage.setItem('sg:'+p, JSON.stringify({ts:now()})); }catch{} }

  function open(p){
    mount();
    if (cached(p)) return Promise.resolve(true);
    purpose = p;
    return new Promise((resolve, reject)=>{
      res=resolve; rej=reject;
      els.hint.textContent=''; els.input.value='';
      els.root.style.display='block';
      // BG blur + noscroll
      document.body.classList.add('sg-blur','sg-noscroll');
      setTimeout(()=>els.input.focus(), 30);
    });
  }
  function close(ok){
    els.root.style.display='none';
    document.body.classList.remove('sg-blur','sg-noscroll');
    if(ok) res?.(true); else rej?.(false);
    res = rej = null;
  }
  function bump(){ els.card.classList.add('sg-shake'); setTimeout(()=>els.card.classList.remove('sg-shake'), 380); }

  async function verify(){
    if(now() < lockedUntil){
      const secs = Math.ceil((lockedUntil-now())/1000);
      els.hint.textContent = `Too many attempts. Try again in ${secs}s.`; bump(); return;
    }
    const password = els.input.value || '';
    if(!password){ els.hint.textContent = 'Enter password.'; bump(); return; }

    // optional Firebase id token attach
    let idToken=null; try{ idToken = await (w.firebase?.auth?.().currentUser?.getIdToken?.()); }catch{}

    try{
      const r = await fetch(FN_BASE + '/admin-auth', {
        method:'POST',
        headers: { 'Content-Type':'application/json', ...(idToken?{Authorization:'Bearer '+idToken}:{}) },
        body: JSON.stringify({ password, purpose, ua:navigator.userAgent })
      });
      const data = await r.json().catch(()=>({ok:false, error:'Invalid response'}));
      if(r.ok && data.ok){
        setCache(purpose); tries=0; els.hint.textContent=''; close(true);
        d.dispatchEvent(new CustomEvent('securegate:unlocked', { detail:{ purpose } }));
      }else{
        tries++; const left=Math.max(0, CFG.maxTries-tries);
        els.hint.textContent = data?.error || (left?`Wrong password. ${left} tries left.`:'Too many attempts. Locked for 60s.');
        bump(); if(!left){ lockedUntil = now()+CFG.cooldownMs; tries=0; }
      }
    }catch(e){
      els.hint.textContent = 'Network error. Please try again.'; bump();
    }
  }

  // ---------- Sidebar protection ----------
  function hookSidebar(){
    const map = { amountTab:'amount-received', categoryTab:'category-manager' };
    const sidebar = d.querySelector('.sidebar'); if(!sidebar) return;
    sidebar.addEventListener('click', async (ev)=>{
      const li = ev.target.closest('li[data-tab]'); if(!li) return;
      const tabId = li.getAttribute('data-tab');
      const need = map[tabId]; if(!need) return;
      ev.preventDefault(); ev.stopPropagation();
      const ok = await open(need); if(!ok) return;

      // tab switch (mirror existing pattern)
      d.querySelectorAll('.sidebar li').forEach(t=>t.classList.remove('active'));
      li.classList.add('active');
      d.querySelectorAll('.tab-content').forEach(sec=>sec.style.display='none');
      const section = d.getElementById(tabId); if(section) section.style.display='block';

      try{ if(tabId==='categoryTab' && typeof w.loadCategories==='function') w.loadCategories(); }catch{}
      try{ if(tabId==='amountTab' && typeof w.loadAmountReceived==='function') w.loadAmountReceived(); }catch{}
    }, {capture:true});
  }

  // ---------- Dashboard amount HARD-MASK (no real text while locked) ----------
  function guardDashboardAmount(){
    const el = d.getElementById('totalAmountReceivedDashboard');
    if(!el) return;

    // Wipe any server-rendered value from DOM (so Inspect me â‚¹5 NHI dikhe)
    el.textContent = '';
    el.setAttribute('data-mask','â‚¹ â€¢â€¢â€¢â€¢â€¢');
    el.classList.add('sg-locked');

    // Keep scrubbing any accidental text while locked
    const mo = new MutationObserver(()=>{
      if(el.classList.contains('sg-locked') && el.textContent.trim()!==''){
        el.textContent = '';
      }
    });
    mo.observe(el, { childList:true, characterData:true, subtree:true });

    // Click to unlock (optional)
    el.addEventListener('click', async (e)=>{
      if(!el.classList.contains('sg-locked')) return;
      e.preventDefault(); e.stopPropagation();
      const ok = await open('amount-received'); if(!ok) return;
      reveal();
    });

    // Auto reveal when unlocked elsewhere
    d.addEventListener('securegate:unlocked', (ev)=>{
      if(ev.detail?.purpose === 'amount-received') reveal();
    });

    function reveal(){
      el.classList.remove('sg-locked');
      el.removeAttribute('data-mask');
      // STOP scrubbingâ€”now real value can appear
      try{ mo.disconnect(); }catch{}
      // If you have a loader, call it; else leave to your app logic
      if (typeof w.loadDashboardStats === 'function') {
        try { w.loadDashboardStats(); } catch {}
      } else if (typeof w.loadAmountReceived === 'function') {
        try { w.loadAmountReceived(); } catch {}
      }
    }
  }

  // ---------- Init ----------
  d.addEventListener('DOMContentLoaded', ()=>{
    // Clear any old cache if you want password every refresh
    Object.keys(sessionStorage).forEach(k=>{ if(k.startsWith('sg:')) sessionStorage.removeItem(k); });
    mount();
    hookSidebar();
    guardDashboardAmount();
  });

})(window, document);
</script>

<script>
/* =========================
   Mini utils (safe + reusable)
========================= */
function _dispatchChange(el){
  if (!el) return;
  el.dispatchEvent(new Event('change', { bubbles: true }));
}
function _simulateClick(el){
  if (!el) return false;
  // prefer native click
  if (typeof el.click === 'function') el.click();
  // also fire a MouseEvent so delegated listeners receive it
  el.dispatchEvent(new MouseEvent('click', { bubbles: true, cancelable: true, view: window }));
  return true;
}
function _activateAndClickFirst(containerSel, btnSel){
  const wrap = document.querySelector(containerSel);
  if (!wrap) return false;
  const all = wrap.querySelectorAll(btnSel);
  if (!all.length) return false;
  all.forEach(b => b.classList?.remove('active'));
  const first = all[0];
  first.classList?.add('active');
  return _simulateClick(first);
}
function _setValAndChange(id, val){
  const el = document.getElementById(id);
  if(!el) return;
  el.value = val;
  _dispatchChange(el);
}
function _show(el, disp='block'){ if(el) el.style.display = disp; }
function _hide(el){ if(el) el.style.display = 'none'; }
function _clear(id){ const el=document.getElementById(id); if(el) el.value=''; }
function _uncheck(id){ const el=document.getElementById(id); if(el) el.checked=false; }

/* =========================
   Lightweight loading overlay per tab
========================= */
function _ensureTabOverlay(tabEl){
  if (!tabEl) return null;
  let overlay = tabEl.querySelector(':scope > ._tabLoadingOverlay');
  if (!overlay){
    overlay = document.createElement('div');
    overlay.className = '_tabLoadingOverlay';
    Object.assign(overlay.style, {
      position:'absolute',
      inset:'0 0 0 0',
      background:'rgba(255,255,255,0.55)',
      display:'none',
      alignItems:'center',
      justifyContent:'center',
      zIndex:'999'
    });
    const spinner = document.createElement('div');
    spinner.className = '_tabSpinner';
    Object.assign(spinner.style, {
      font:'600 14px/1.2 system-ui, -apple-system, Segoe UI, Roboto, Arial',
      padding:'10px 14px',
      borderRadius:'10px',
      background:'#ffffff',
      border:'1px solid #e5e7eb',
      boxShadow:'0 4px 14px rgba(0,0,0,.08)'
    });
    spinner.innerHTML = `<i class="fa fa-rotate fa-spin" style="margin-right:8px"></i>Loadingâ€¦`;
    overlay.appendChild(spinner);

    // Make tab container a positioning context if not already
    const computed = getComputedStyle(tabEl);
    if (computed.position === 'static') tabEl.style.position = 'relative';

    tabEl.appendChild(overlay);
  }
  return overlay;
}
function _overlayOn(tabEl){ const ov=_ensureTabOverlay(tabEl); if(ov) ov.style.display='flex'; }
function _overlayOff(tabEl){ const ov=_ensureTabOverlay(tabEl); if(ov) ov.style.display='none'; }

/* =========================
   Per-tab refresh registry
   (reset â†’ then click/show)
========================= */
window.__tabReloaders = {
  // ðŸ“Š Dashboard â†’ set defaults AND trigger change
  dashboardTab: async () => {
    _setValAndChange('dateRange', '7');
    _setValAndChange('chartType', 'bar');
    _hide(document.getElementById('startDate'));
    _hide(document.getElementById('endDate'));
    if (typeof updateFullDashboardChart === 'function') {
      await Promise.resolve(updateFullDashboardChart());
    }
  },

  // ðŸ—‘ï¸ Deleted Ads
  deletedAdsTab: async () => {
    if (typeof loadDeletedAds === 'function') await Promise.resolve(loadDeletedAds());
  },

  // ðŸ’° Amount Received â†’ Approved tab active
  amountTab: async () => {
    if (typeof refreshPaymentsSummary === 'function') await Promise.resolve(refreshPaymentsSummary());
    if (typeof showPaymentsTab === 'function') await Promise.resolve(showPaymentsTab('approved'));
    const apprBtn = document.getElementById('approvedTabBtn');
    if (apprBtn) _simulateClick(apprBtn);
  },

  // ðŸ–¼ï¸ Slider
  sliderTab: async () => {
    if (typeof loadSliders === 'function') await Promise.resolve(loadSliders());
  },

  // ðŸ—‚ï¸ Category Manager
  categoryTab: async () => {
    if (typeof loadCategories === 'function') await Promise.resolve(loadCategories());
    if (typeof initCategoryManager === 'function') await Promise.resolve(initCategoryManager());
    _hide(document.getElementById('subTabsWrap'));
    _hide(document.getElementById('subcatEditor'));
  },

  // ðŸ‘¥ Users â†’ default â€œAllâ€ AND click first tab-btn
  usersTab: async () => {
    const clicked = _activateAndClickFirst('#usersTab', '.users-tab-btn');
    if (!clicked && typeof loadUsers === 'function') {
      await Promise.resolve(loadUsers('all'));
    }
  },

  // ðŸ“¦ All Ads â†’ default â€œAllâ€ AND click first status tab
  adsTab: async () => {
    const clicked = _activateAndClickFirst('#adsStatusTabs', '.ads-tab-btn');
    if (typeof loadAds === 'function') {
      await Promise.resolve(loadAds('all')); // fallback explicit load
    }
    _uncheck('selectAllAds');
    const c = document.getElementById('bulkSelectedCount'); if (c) c.textContent = '';
    ['bulkApproveBtn','bulkRejectBtn','bulkDeleteBtn'].forEach(id=>{
      const b=document.getElementById(id); if(b) b.disabled = true;
    });
  },

  // ðŸ“¢ Push Center
  pushCenterTab: async () => {
    if (typeof loadPushHistory === 'function') await Promise.resolve(loadPushHistory(true));
  },

  // ðŸš¨ Abuse (Same-IP) â†’ set selects & fire change/click
  abuseTab: async () => {
    _setValAndChange('abMode', 'index');
    _setValAndChange('abMinUids', '2');
    _clear('abSearch');
    const abBtn = document.getElementById('abRefresh');
    if (!abBtn || !_simulateClick(abBtn)) {
      if (typeof buildAbuseList === 'function') await Promise.resolve(buildAbuseList());
      else if (typeof loadAbuseReports === 'function') await Promise.resolve(loadAbuseReports());
    }
  },

  // ðŸ“£ Notices
  noticesTab: async () => {
    if (typeof loadNotices === 'function') await Promise.resolve(loadNotices());
  },

  // ðŸ“ Ads Review (Pending)
  adsReviewTab: async () => {
    _uncheck('selectAllPending');
    if (typeof loadPendingAds === 'function') await Promise.resolve(loadPendingAds());
  },

  // ðŸ“ˆ Reports â†’ default â€œActiveâ€ + click its tab if exists
  reportsTab: async () => {
    if (typeof showReportSection === 'function') await Promise.resolve(showReportSection('active'));
    const activeBtn = document.getElementById('tabActiveBtn');
    if (activeBtn) _simulateClick(activeBtn);
    if (typeof loadReports === 'function') await Promise.resolve(loadReports?.('active'));
  },

  // ðŸ’¬ All Chats (Userâ†”User)
  messagesTab: async () => {
    if (typeof loadChats === 'function') await Promise.resolve(loadChats());
  },

  // ðŸ—¨ï¸ Live Chats (Adminâ†”User)
  userChatTab: async () => {
    if (typeof loadAdminUserChats === 'function') await Promise.resolve(loadAdminUserChats());
    _clear('liveChatInput');
  },

  // ðŸš€ Boost & Paid Post â†’ click Boost tab button
  boostRequestsTab: async () => {
    const boostBtn = document.getElementById('btnBoostTab');
    const postBtn  = document.getElementById('btnPostFeeTab');
    if (boostBtn){ boostBtn.classList.add('active'); _simulateClick(boostBtn); }
    postBtn?.classList.remove('active');
    const boostList = document.getElementById('boostRequestsList');
    const postList  = document.getElementById('postFeeRequestsList');
    if (boostList) boostList.style.display = '';
    if (postList)  postList.style.display  = 'none';
    if (typeof loadBoostRequests === 'function') await Promise.resolve(loadBoostRequests());
  },
};

/* =========================
   Universal refresh (async + overlay + safe reflow)
========================= */
async function refreshTab(tabRef){
  // tabRef can be id string or Element
  const tab = (typeof tabRef === 'string') ? document.getElementById(tabRef) : tabRef;
  if (!tab) { console.warn('Tab element not found for', tabRef); return; }
  const tabId = tab.id || String(tabRef);

  const btn = tab.querySelector('.tab-refresh-btn');
  const run = window.__tabReloaders?.[tabId];
  if (!run){
    console.warn('No refresh handler for', tabId);
    return;
  }

  // Button busy state
  let oldHtml;
  if (btn){
    btn.disabled = true;
    oldHtml = btn.innerHTML;
    btn.innerHTML = `<i class="fa fa-rotate fa-spin"></i> Refreshingâ€¦`;
    btn.setAttribute('aria-busy', 'true');
  }

  // Overlay on (only if tab is currently visible)
  const visible = !!(tab.offsetParent !== null || tab.getClientRects().length);
  if (visible) _overlayOn(tab);

  // Preserve scroll position of main scrolling node inside tab (optional)
  const scroller = tab.querySelector('[data-scroll]') || tab;
  const oldScrollTop = scroller.scrollTop;

  // Force a micro reflow to help CSS-driven layouts
  const doReflow = () => {
    tab.style.transform = 'translateZ(0)'; // GPU tickle
    // flicker reflow fallback
    tab.style.display = 'none';
    setTimeout(()=>{ tab.style.display = ''; }, 40);
  };

  try{
    // Execute handler (await if Promise-like)
    const ret = run();
    if (ret && typeof ret.then === 'function') {
      await ret;
    }
    // Light reflow only if the tab is visible (hidden tabs donâ€™t need it)
    if (visible) doReflow();
  }catch(e){
    console.error('refreshTab error:', e);
  }finally{
    // Restore scroll
    if (typeof oldScrollTop === 'number') scroller.scrollTop = oldScrollTop;
    // Button restore
    if (btn){
      btn.disabled = false;
      btn.innerHTML = oldHtml || `<i class="fa fa-rotate"></i> Refresh`;
      btn.removeAttribute('aria-busy');
    }
    if (visible) _overlayOff(tab);
  }
}

/* =========================
   Auto-wire all .tab-refresh-btn buttons
   â€“ figures out the correct tab id via closest .section
========================= */
function _findTabForButton(button){
  // try closest ancestor with an id (prefer .section)
  let el = button.closest('.section') || button.closest('[id]');
  while (el && !el.id) el = el.parentElement;
  return el || null;
}

function _bindRefreshButtons(){
  document.querySelectorAll('.tab-refresh-btn').forEach(btn=>{
    // avoid duplicate binding
    if (btn._refreshBound) return;
    btn._refreshBound = true;

    btn.addEventListener('click', (e)=>{
      e.preventDefault();
      const tabEl = _findTabForButton(btn);
      if (!tabEl){
        console.warn('Cannot resolve tab container for refresh button', btn);
        return;
      }
      refreshTab(tabEl);
    }, false);
  });
}

// Bind on DOM ready + also on any dynamic content mutations (optional)
document.addEventListener('DOMContentLoaded', _bindRefreshButtons);
// If your UI injects tabs dynamically, rebind on clicks anywhere (cheap + safe)
document.addEventListener('click', function(e){
  if ((e.target && e.target.classList && e.target.classList.contains('tab-refresh-btn')) ||
      (e.target && e.target.closest && e.target.closest('.tab-refresh-btn'))) {
    // the click handler above will run; but ensure late-added buttons get a listener next time
    setTimeout(_bindRefreshButtons, 0);
  }
});
</script>


<script>
/* ===== Admin Tickets (Open/Answered/Closed tabs + NEW + server-first + reset on refresh & tab change) ===== */
(function(){
  const db = (window.db || firebase.firestore());
  const $  = (id)=> document.getElementById((id && id.replace) ? id.replace(/^#/, '') : id);
  const esc= (s)=>String(s||'').replace(/[&<>\"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  const when = ts => ts?.toDate?.() ? ts.toDate().toLocaleString() : 'â€”';

  // State
  let unsubTicketList = null;        // left list stream
  let unsubscribeLiveChat = null;    // thread stream
  let selectedTicketId = null;
  let sendingLock = false;

  let currentFilter = 'Open';        // default tab
  let docCache = [];                 // latest tickets snapshot
  let newFlags = {};                 // ticketId -> last message by user?

  /* ================== Controls enable/disable ================== */
  function setControls(disabled){
    ['liveChatInput','liveChatSendBtn','ticketStatus','saveTicketStatus'].forEach(id=>{
      const el = $(id); if (!el) return;
      el.disabled = !!disabled;
      el.classList.toggle('is-disabled', !!disabled);
      if (id==='liveChatInput') el.placeholder = disabled ? 'Select a ticket to reply' : 'Type your replyâ€¦';
    });
  }

  /* ================== HARD RESET (right panel + listeners) ================== */
  function resetTicketPanel(){
  // stop previous thread listener
  if (typeof unsubscribeLiveChat === 'function') {
    try{ unsubscribeLiveChat(); }catch(_){}
    unsubscribeLiveChat = null;
  }
  // clear selection + UI
  selectedTicketId = null;
  const header = $('ticketHeader');
  const chat   = $('liveChatBox');
  const list   = $('userChatList');

  if (header) header.innerHTML = '<em>Select a ticket from the left.</em>';
  if (chat)   chat.innerHTML   = '';
  if (list)   list.querySelectorAll('.list-item.active').forEach(el=>el.classList.remove('active'));

  // lock right-side controls
  if (typeof setControls === 'function') setControls(true);
  const inp = $('liveChatInput'); if (inp) inp.value = '';
}

  /* ================== Re-binds (avoid double handlers) ================== */
  function rebindSendButton(){
    const old = $('liveChatSendBtn'); if(!old) return;
    const clone = old.cloneNode(true); clone.type='button';
    old.parentNode.replaceChild(clone, old);
    clone.addEventListener('click', sendLiveAdminReplySafe);
  }
  function bindInputHotkey(){
    const inp = $('liveChatInput'); if (!inp) return;
    inp.onkeydown = (e)=>{ if(e.key==='Enter' && (e.ctrlKey||e.metaKey)){ e.preventDefault(); sendLiveAdminReplySafe(); } };
  }
  function bindSaveStatus(){
    const btn = $('saveTicketStatus'); if (!btn) return;
    const clone = btn.cloneNode(true);
    btn.parentNode.replaceChild(clone, btn);
    clone.addEventListener('click', saveTicketStatus);
  }

  /* ================== Status Tabs (Open / Answered / Closed) ================== */
  function wireStatusTabs(){
  const bar = $('ticketStatusTabs'); if (!bar) return;

  // Event delegation (robust)
  bar.onclick = (e)=>{
    const btn = e.target.closest('.st-btn');
    if (!btn || !bar.contains(btn)) return;

    const next = btn.dataset.status || 'Open';
    if (next === currentFilter){
      // same tab pe click â€” optional: no-op
      return;
    }

    // âœ… RESET right panel + selection + live listener
    resetTicketPanel();

    // toggle active
    bar.querySelectorAll('.st-btn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');

    // set filter + re-render list
    currentFilter = next;
    renderList(docCache);
  };
}

  function updateCounts(){
    const by = { Open:0, Answered:0, Closed:0 };
    let openNew = 0;
    docCache.forEach(d=>{
      const t = d.data()||{};
      if (by[t.status] !== undefined) by[t.status]++;
      if (t.status==='Open' && newFlags[d.id]) openNew++;
    });
    const setTxt = (id,val)=>{ const el=$(id); if(el) el.textContent=String(val); };
    setTxt('stOpen', by.Open);
    setTxt('stAnswered', by.Answered);
    setTxt('stClosed', by.Closed);
    const newEl = document.querySelector('#ticketStatusTabs .st-btn[data-status="Open"] .st-new');
    if (newEl) newEl.textContent = String(openNew);
  }
  async function computeNewFlags(docs){
    const jobs = docs.map(async d=>{
      try{
        const last = await d.ref.collection('messages').orderBy('createdAt','desc').limit(1).get({source:'server'});
        const data = last.docs[0]?.data();
        return [d.id, data?.by === 'user'];
      }catch(_){ return [d.id,false]; }
    });
    newFlags = Object.fromEntries(await Promise.all(jobs));
  }

  /* ================== Load List: server-first then realtime ================== */
  async function loadAdminUserChats(){
    const listEl = $('userChatList');
    if (listEl) listEl.textContent = 'Loading ticketsâ€¦';

    try{
      const serverSnap = await db.collection('tickets').orderBy('updatedAt','desc').get({source:'server'});
      docCache = serverSnap.docs;
      await computeNewFlags(docCache);
      updateCounts();
      renderList(docCache);
    }catch(err){
      if (listEl) listEl.innerHTML = `<span style="color:#b91c1c">Error: ${esc(err.message)}</span>`;
    }

    if (unsubTicketList) { try{unsubTicketList();}catch(_){ } unsubTicketList = null; }
    unsubTicketList = db.collection('tickets').orderBy('updatedAt','desc')
      .onSnapshot({includeMetadataChanges:true}, async snap=>{
        if (snap.metadata.fromCache) return;
        docCache = snap.docs;
        await computeNewFlags(docCache);
        updateCounts();
        renderList(docCache);
      });
  }
  window.loadAdminUserChats = loadAdminUserChats;

  function renderList(docs){
    const box = $('userChatList'); if(!box) return;

    const filtered = docs.filter(d=>{
      const st = d.data()?.status || 'Open';
      return currentFilter==='Answered' ? st==='Answered'
           : currentFilter==='Closed'   ? st==='Closed'
           : /* default Open */           st==='Open';
    });

    if (!filtered.length){
      box.innerHTML = '<p style="margin:24px 0; color:#888;">No tickets found.</p>';
      return;
    }

    const html = filtered.map(doc=>{
      const t = doc.data()||{};
      const isNew = !!newFlags[doc.id] && t.status==='Open';
      return `
        <div class="list-item ${doc.id===selectedTicketId?'active':''}"
             data-ticket-id="${doc.id}"
             style="padding:10px; border-bottom:1px solid #eee; cursor:pointer;">
          <div>
            <strong>${doc.id}</strong> â€“ ${esc(t.subject||'')}
            ${isNew ? `<span class="badge Open" style="margin-left:6px; background:#fee2e2; color:#b91c1c; border:1px solid #fecaca;">NEW</span>` : ``}
          </div>
          <div style="font-size:12px; color:#666;">
            ${esc(t.user?.name||'User')} Â· ${esc(t.user?.email||'')} Â· ${when(t.updatedAt)}
            <span class="badge ${t.status||'Open'}" style="margin-left:6px;">${t.status||'Open'}</span>
          </div>
        </div>`;
    }).join('');
    box.innerHTML = html;

    box.querySelectorAll('.list-item').forEach(n=>{
      n.onclick = ()=>{
        box.querySelectorAll('.list-item').forEach(li=>li.classList.remove('active'));
        n.classList.add('active');
        openLiveChat(n.getAttribute('data-ticket-id'));
      };
    });
  }

  /* ================== Thread: server-first then realtime ================== */
  window.openLiveChat = async function(ticketId){
    selectedTicketId = ticketId;
    setControls(true); // lock while loading

    const header = $('ticketHeader'), chatBox = $('liveChatBox');
    header && (header.innerHTML = `<em>Loading ${esc(ticketId)}â€¦</em>`);
    chatBox && (chatBox.innerHTML = `<em>Loading messagesâ€¦</em>`);

    // meta server-first
    let tSnap;
    try { tSnap = await db.collection('tickets').doc(ticketId).get({source:'server'}); }
    catch(_) { tSnap = await db.collection('tickets').doc(ticketId).get(); }
    if (!tSnap.exists){ header && (header.innerHTML = `<span style="color:#b91c1c">Ticket not found.</span>`); return; }
    const t = tSnap.data()||{};

    header && (header.innerHTML = `
      <div style="font-weight:600; margin-bottom:4px;">${esc(t.id||ticketId)} Â· ${esc(t.subject||'')}</div>
      <div style="font-size:12px; color:#666; display:flex; flex-wrap:wrap; gap:6px;">
        <span>User: ${esc(t.user?.name||'User')}</span>
        <span>Â· Email: ${esc(t.user?.email||'')}</span>
        <span>Â· Category: ${esc(t.category||'-')}</span>
        <span>Â· Priority: ${esc(t.priority||'-')}</span>
        <span>Â· Created: ${when(t.createdAt)}</span>
        <span>Â· Updated: ${when(t.updatedAt)}</span>
      </div>`);
    const stSel = $('ticketStatus'); if (stSel) stSel.value = t.status || 'Open';

    const msgsRef = db.collection('tickets').doc(ticketId).collection('messages').orderBy('createdAt');
    try{
      const serverMsgs = await msgsRef.get({source:'server'});
      renderMsgs(serverMsgs);
    }catch(_){}

    if (unsubscribeLiveChat) { try{unsubscribeLiveChat();}catch(_){ } unsubscribeLiveChat = null; }
    unsubscribeLiveChat = msgsRef.onSnapshot({includeMetadataChanges:true}, snap=>{
      if (snap.metadata.fromCache) return;
      renderMsgs(snap);
    });

    setControls(false); // enable after load
    rebindSendButton(); bindInputHotkey(); bindSaveStatus();
  };

  function renderMsgs(snap){
    const box = $('liveChatBox'); if(!box) return;
    const out = []; let lastDay='';
    snap.forEach(m=>{
      const d = m.data()||{};
      const ts = d.createdAt?.toDate?.();
      const day = ts ? ts.toDateString() : '';
      if (day && day !== lastDay){ out.push(`<div class="day-sep" style="text-align:center;color:#6b7280;font-size:12px;margin:10px 0;">${day}</div>`); lastDay = day; }
      const isAdmin = d.by==='admin';
      out.push(`
        <div class="chat-bubble ${isAdmin?'admin-message':'user-message'}">
          <div>${esc(d.text||'').replace(/\n/g,'<br>')}</div>
          <div class="message-time">${isAdmin?'Support':'User'} Â· ${ts ? ts.toLocaleString() : when(d.createdAt)}</div>
        </div>`);
    });
    box.innerHTML = out.join('') || '<em>No messages yet.</em>';
    box.scrollTop = box.scrollHeight;
  }

  /* ================== Save status (manual button) ================== */
  async function saveTicketStatus(){
    if (!selectedTicketId) return;
    const status = $('ticketStatus')?.value || 'Open';
    await db.collection('tickets').doc(selectedTicketId).update({
      status, updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    alert('Status saved.');
  }

  /* ================== Send (with lock) ================== */
  async function sendLiveAdminReplySafe(){
    if ($('liveChatSendBtn')?.disabled) return;
    if (sendingLock) return;
    const input = $('liveChatInput'), btn=$('liveChatSendBtn');
    if (!input || !selectedTicketId) return;
    const text = input.value.trim(); if(!text) return;

    sendingLock = true; btn && (btn.disabled = true);
    try{
      const tRef = db.collection('tickets').doc(selectedTicketId);
      await tRef.collection('messages').add({
        by:'admin', text, attachments:[], createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      // flip Open -> Answered by default
      const sel = $('ticketStatus');
      const chosen = sel?.value || 'Answered';
      const next   = (chosen==='Open') ? 'Answered' : chosen;
      await tRef.update({
        status: next,
        lastBy: 'admin', // (optional) help dashboard counters
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      if (sel) sel.value = next;
      input.value='';

      // update badges/counters (this ticket no longer NEW)
      if (docCache.length){
        await computeNewFlags(docCache);
        updateCounts();
        renderList(docCache);
      }
    }finally{
      sendingLock = false; btn && (btn.disabled = false);
    }
  }
  window.sendLiveAdminReply = sendLiveAdminReplySafe;

  /* ================== TAB RELOADER (called on open/refresh) ================== */
  window.__tabReloaders = window.__tabReloaders || {};
  window.__tabReloaders.userChatTab = async () => {
    resetTicketPanel(); // clear current thread before reload
    try { await db.collection('tickets').orderBy('updatedAt','desc').get({source:'server'}); } catch(_){}
    await loadAdminUserChats();
    // bind tabs + default Open active
    wireStatusTabs();
    const bar = $('ticketStatusTabs');
    const openBtn = bar?.querySelector('.st-btn[data-status="Open"]');
    if (openBtn){
      bar.querySelectorAll('.st-btn').forEach(b=>b.classList.remove('active'));
      openBtn.classList.add('active');
      currentFilter = 'Open';
      renderList(docCache);
    }
    // rebind right-panel controls
    rebindSendButton(); bindInputHotkey(); bindSaveStatus();
  };

  /* ================== Hooks for tab change/reset ================== */
  // A) Clicks on side-nav li[data-tab]
  document.addEventListener('click', (e)=>{
    const li = e.target.closest('li[data-tab]');
    if (!li) return;
    const tab = li.getAttribute('data-tab');
    if (tab === 'userChatTab'){
      window.__tabReloaders.userChatTab();
    } else {
      cleanupTicketsTab(); // leaving this tab
    }
  });

  // B) Refresh button inside this tab
  document.addEventListener('click', (e)=>{
    const btn = e.target.closest('.tab-refresh-btn');
    if (!btn) return;
    if (btn.closest('#userChatTab')) {
      resetTicketPanel();
      // your app may call refreshTab('userChatTab') itself
    }
  });

  // C) Patch refreshTab/showTab if app uses these programmatically
  (function ensureTabPatches(){
    if (!window.__patchedRefreshTab){
      const orig = window.refreshTab;
      window.refreshTab = function(name){
        if (name !== 'userChatTab') cleanupTicketsTab();
        const r = orig ? orig.apply(this, arguments) : undefined;
        if (name === 'userChatTab') window.__tabReloaders.userChatTab();
        return r;
      };
      window.__patchedRefreshTab = true;
    }
    if (typeof window.showTab === 'function' && !window.__patchedShowTab){
      const origS = window.showTab;
      window.showTab = function(name){
        if (name !== 'userChatTab') cleanupTicketsTab();
        const r = origS.apply(this, arguments);
        if (name === 'userChatTab') window.__tabReloaders.userChatTab();
        return r;
      };
      window.__patchedShowTab = true;
    }
  })();

  // D) MutationObserver: if tab is shown/hidden by CSS class/style
  (function observeVisibility(){
    const el = $('userChatTab'); if (!el) return;
    let wasVisible = getComputedStyle(el).display !== 'none';
    const onChange = ()=>{
      const now = getComputedStyle(el).display !== 'none';
      if (now && !wasVisible){ window.__tabReloaders.userChatTab(); }
      if (!now && wasVisible){ cleanupTicketsTab(); }
      wasVisible = now;
    };
    const mo = new MutationObserver(onChange);
    mo.observe(el, { attributes: true, attributeFilter: ['class','style'] });
    // also run once on load
    onChange();
  })();

})();


// Make cleanup available where the tab-switch patches expect it.
window.cleanupTicketsTab = function(){
  try { 
    // hard reset the right panel (existing helper)
    if (typeof resetTicketPanel === 'function') resetTicketPanel();
  } catch(_) {}

  // also stop the left-list subscription if present
  try {
    if (typeof unsubTicketList === 'function') { unsubTicketList(); }
  } catch(_) {}
  // Make sure these globals exist; your module already declares them.
  try { window.unsubTicketList = null; } catch(_) {}
};

</script>

<script>
window.refreshTab = async function(input, btn){
  // Normalize input â†’ tab element + id
  const tab = (typeof input === 'string')
    ? document.getElementById(input)
    : (input && input.nodeType === 1 ? input : null);

  if (!tab) { console.warn('refreshTab: missing tab element for', input); return; }
  const tabId = tab.id || '';

  // Find handler from registry
  const run = (window.__tabReloaders || {})[tabId];
  if (!run) { console.warn('No refresh handler for', tabId); return; }

  // ==== Busy/overlay handling (your existing logic kept intact) ====
  let oldHtml;
  if (btn){
    btn.disabled = true;
    oldHtml = btn.innerHTML;
    btn.innerHTML = `<i class="fa fa-rotate fa-spin"></i> Refreshingâ€¦`;
    btn.setAttribute('aria-busy', 'true');
  }

  const visible = !!(tab.offsetParent !== null || tab.getClientRects().length);
  if (visible) _overlayOn(tab);

  const scroller = tab.querySelector('[data-scroll]') || tab;
  const oldScrollTop = scroller.scrollTop;

  const doReflow = () => {
    tab.style.transform = 'translateZ(0)';
    tab.style.display = 'none';
    setTimeout(()=>{ tab.style.display = ''; }, 40);
  };

  try{
    const ret = run();
    if (ret && typeof ret.then === 'function') await ret;
    if (visible) doReflow();
  } catch(e){
    console.error('refreshTab error:', e);
  } finally {
    if (typeof oldScrollTop === 'number') scroller.scrollTop = oldScrollTop;
    if (btn){
      btn.disabled = false;
      btn.innerHTML = oldHtml || `<i class="fa fa-rotate"></i> Refresh`;
      btn.removeAttribute('aria-busy');
    }
    if (visible) _overlayOff(tab);
  }
};


</script>
<script>
// --- Migration shim: purani onclick calls bach gaye hon to yeh unhe safe bana dega ---
window.showTab = function(id){
  const li = document.querySelector(`.sidebar li[data-tab="${id}"]`);
  if (li) li.click();
  else console.warn('[tabs] No sidebar item for', id);
};

// --- Data-attr based switching (robust) ---
document.addEventListener('DOMContentLoaded', () => {
  const sidebarItems = Array.from(document.querySelectorAll('.sidebar li'));
  const sections = Array.from(document.querySelectorAll('.tab-content'));

  function hideAll(){ sections.forEach(sec => { if (sec) sec.style.display = 'none'; }); }
  function setActive(li){ sidebarItems.forEach(t => t.classList.remove('active')); if (li) li.classList.add('active'); }

  function runPerTabLogic(id){
    switch(id){
      case 'dashboardTab':      if (typeof renderAdsStatusChart === 'function') renderAdsStatusChart(); break;
      case 'categoryTab':       if (typeof loadCategories === 'function') loadCategories(); break;
      case 'noticesTab':        if (typeof loadNotices === 'function') loadNotices(); break;
      case 'amountTab':         if (typeof loadAmountReceived === 'function') loadAmountReceived(); break;
      case 'deletedAdsTab':     if (typeof loadDeletedAds === 'function') loadDeletedAds(); break;
      case 'userReportsTab':    if (typeof loadUserReports === 'function') loadUserReports(); break;
      // add more cases as needed
    }
  }

  // Bind clicks (sirf un LI par jinke paas data-tab hai)
  sidebarItems.forEach(li => {
    li.addEventListener('click', (e) => {
      const target = li.getAttribute('data-tab');
      if (!target) return; // non-tab items ignored

      const el = document.getElementById(target);
      if (!el) {                         // âœ… null guard: TypeError se bachaata hai
        console.warn('[tabs] Target tab not found:', target);
        return;
      }

      hideAll();
      el.style.display = 'block';
      setActive(li);
      runPerTabLogic(target);

      try { localStorage.setItem('bb_admin_last_tab', target); } catch {}
    });
  });

  // Initial open: last saved / first available
  let initial = null;
  try { initial = localStorage.getItem('bb_admin_last_tab'); } catch {}
  const toActivate =
    document.querySelector(`.sidebar li[data-tab="${initial}"]`) ||
    document.querySelector('.sidebar li.active[data-tab]') ||
    document.querySelector('.sidebar li[data-tab]');

  if (toActivate) toActivate.click();
});
</script>
<script>
function showDealerProof(proofs=[]) {
  const wrap = document.getElementById('dealerProofBody');
  const modal = document.getElementById('dealerProofModal');
  const items = Array.isArray(proofs) ? proofs : [];

  if (!wrap || !modal) return;

  if (!items.length) {
    wrap.innerHTML = `<p style="color:#6b7280">No proof uploaded.</p>`;
  } else {
    wrap.innerHTML = items.map((url, i) => {
      const isImg = /\.(png|jpe?g|webp|gif|bmp|svg)$/i.test(url);
      return `
        <div class="dealer-proof-item">
          <a href="${url}" target="_blank" rel="noopener">Open Proof ${i+1}</a>
          ${isImg ? `<div><img src="${url}" alt="proof ${i+1}"></div>` : ``}
        </div>`;
    }).join('');
  }
  modal.style.display = 'flex';
}

function hideDealerProof(){ 
  const modal = document.getElementById('dealerProofModal'); 
  if (modal) modal.style.display = 'none'; 
}

// Link click (delegated)
document.addEventListener('click', (e)=>{
  const a = e.target.closest('.dealer-proof-link');
  if(!a) return;
  e.preventDefault();
  try{
    const proofs = JSON.parse(a.getAttribute('data-proof') || '[]');
    showDealerProof(proofs);
  }catch(_){
    showDealerProof([]);
  }
});
</script>

<!-- Dealer Proof Popup -->
<div id="dealerProofModal" style="display:none;position:fixed;inset:0;z-index:9999;background:rgba(0,0,0,.5);align-items:center;justify-content:center;">
  <div style="background:#fff;border-radius:12px;padding:16px 18px;max-width:640px;width:92%;max-height:80vh;overflow:auto;">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
      <h3 style="margin:0;font:700 16px system-ui">Dealer Proof</h3>
      <button onclick="hideDealerProof()" style="border:0;background:#eee;border-radius:8px;padding:6px 10px;cursor:pointer">Close</button>
    </div>
    <div id="dealerProofBody"></div>
  </div>
</div>
<script>
// history writer (shared)
async function writeAdHistory(entry){
  // entry: { action:'resolved'|'rejected', itemId, ownerUserId, reportId, reporterUserId, note, reason, by }
  const payload = {
    type: 'ad',
    action: entry.action,
    itemId: entry.itemId || null,
    ownerUserId: entry.ownerUserId || null,
    reportId: entry.reportId || null,
    reporterUserId: entry.reporterUserId || null,
    note: entry.note || '',
    reason: entry.reason || '',
    by: entry.by || ((auth && auth.currentUser && (auth.currentUser.uid || auth.currentUser.email)) || 'admin'),
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  };
  await db.collection('reportHistory').add(payload);
}

// No-issue resolve
async function resolveAdReport(reportDocId, itemId, details){
  const reportSnap = await db.collection('reports').doc(reportDocId).get();
  const r = reportSnap.data() || {};
  const { ownerUserId } = getAdTarget(r);

  // 1) mark report resolved
  await db.collection('reports').doc(reportDocId).set({
    status: 'resolved',
    details: details || 'No issue',
    resolvedAt: firebase.firestore.FieldValue.serverTimestamp(),
    resolvedBy: (auth && auth.currentUser && (auth.currentUser.uid || auth.currentUser.email)) || 'admin'
  }, { merge:true });

  // 2) add to history
  await writeAdHistory({
    action: 'resolved',
    itemId,
    ownerUserId,
    reportId: reportDocId,
    reporterUserId: getReporterId(r),
    note: details
  });
}

// Reject ad from report (same as normal reject + history)
async function rejectAdFromReport(reportDocId, itemId, reason){
  const by = (auth && auth.currentUser && (auth.currentUser.uid || auth.currentUser.email)) || 'admin';

  // 1) update ad status (like your normal reject)
  await db.collection('items').doc(itemId).set({
    status: 'rejected',
    rejectionReason: reason,
    rejectedBy: by,
    rejectedAt: firebase.firestore.FieldValue.serverTimestamp()
  }, { merge:true });

  // optional: keep your old rejectionHistory for backwards compatibility
  try{
    await db.collection('rejectionHistory').add({
      itemId, reason, by, createdAt: firebase.firestore.FieldValue.serverTimestamp(), from: 'ads_report'
    });
  }catch(_) {}

  // 2) mark report resolved (closed via reject)
  await db.collection('reports').doc(reportDocId).set({
    status: 'resolved',
    details: `Rejected: ${reason}`,
    resolvedAt: firebase.firestore.FieldValue.serverTimestamp(),
    resolvedBy: by
  }, { merge:true });

  // 3) history log
  const reportSnap = await db.collection('reports').doc(reportDocId).get();
  const r = reportSnap.data() || {};
  const { ownerUserId } = getAdTarget(r);

  await writeAdHistory({
    action: 'rejected',
    itemId,
    ownerUserId,
    reportId: reportDocId,
    reporterUserId: getReporterId(r),
    reason
  });
}
</script>
<!-- History tab container (add if you don't have one) -->
<div id="historyTab" class="tab-content section" style="display:none;">
  <h3>History</h3>
  <div id="reportHistoryList">Loadingâ€¦</div>
</div>

<script>
// live list for 'reportHistory' (type:'ad')
dashboardUnsubs.push(
  db.collection('reportHistory')
    .where('type','==','ad')
    .orderBy('createdAt','desc')
    .limit(200)
    .onSnapshot(snap=>{
      const el = document.getElementById('reportHistoryList');
      if (!el) return;
      if (snap.empty){ el.innerHTML = '<p style="color:#6b7280">No history yet.</p>'; return; }

      const rows = snap.docs.map(d=>{
        const h = d.data() || {};
        const when = fmtTs(h.createdAt);
        const header = (h.action === 'rejected') ? 'Rejected' : 'Resolved';
        const note = h.note ? `<div><b>Note:</b> ${escapeHtml(h.note)}</div>` : '';
        const reason = h.reason ? `<div><b>Reason:</b> ${escapeHtml(h.reason)}</div>` : '';

        return `
          <div class="hist" style="border:1px solid #e5e7eb;border-radius:12px;padding:10px;background:#fff;margin-bottom:8px;">
            <div style="display:flex;gap:8px;align-items:center;margin-bottom:4px;">
              <span class="badge" style="border:1px solid #e5e7eb;border-radius:999px;padding:2px 8px;font-size:12px;background:#fff;">${header}</span>
              <small style="color:#6b7280">${when}</small>
            </div>
            <div><b>Ad ID:</b> <code>${escapeHtml(h.itemId || 'â€”')}</code> ${h.ownerUserId ? `â€¢ <b>Owner:</b> <code>${escapeHtml(h.ownerUserId)}</code>`:''}</div>
            <div><b>Report ID:</b> <code>${escapeHtml(h.reportId || 'â€”')}</code> â€¢ <b>Reporter:</b> <code>${escapeHtml(h.reporterUserId || 'â€”')}</code></div>
            ${note}${reason}
            <div style="margin-top:4px;color:#6b7280"><b>By:</b> <code>${escapeHtml(h.by||'admin')}</code></div>
          </div>`;
      }).join('');
      el.innerHTML = rows;
    })
);
</script>

</body>
</html>
